<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Introduction: Synthetically Modeling ECG with BayesFlow &mdash; BayesFlow beta documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->

        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
</head>

<body class="wy-body-for-nav">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> BayesFlow
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">bayesflow</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BayesFlow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Introduction: Synthetically Modeling ECG with BayesFlow</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorial_notebooks/ECG_Model.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">


<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">### Application: ECG-Modeling</span>
<span class="c1"># Work in progress</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">integrate</span><span class="p">,</span> <span class="n">ndimage</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits</span> <span class="kn">import</span> <span class="n">mplot3d</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../../..&#39;</span><span class="p">)))</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2022-11-02 16:16:16.458579: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcudart.so.10.1
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># original_dir = &#39;/home/rene/Bf_ecg/BayesFlow/docs/source/tutorial_notebooks/&#39;</span>
<span class="c1"># os.chdir(original_dir)</span>
<span class="c1"># list_of_folders = glob.glob(&#39;*checkpoints_*&#39;)</span>


<span class="c1"># for ckpoint in list_of_folders:</span>
<span class="c1">#     os.chdir(ckpoint)</span>
<span class="c1">#     list_of_memory_checkpoints = glob.glob(&#39;*memory*&#39;)</span>
<span class="c1">#     if len(list_of_memory_checkpoints) &gt; 1:</span>
<span class="c1">#         current_nr = 0</span>
<span class="c1">#         nr_list = []</span>


<span class="c1">#         for mem_ckpt in list_of_memory_checkpoints:</span>
<span class="c1">#             nr_list += [int(re.search(r&#39;memory_(.*)\.pkl&#39;, mem_ckpt).group(1))]</span>

<span class="c1">#         nr_list = np.sort(nr_list)</span>

<span class="c1">#         for i in nr_list[:-1]:</span>
<span class="c1">#             os.remove(f&#39;memory_{i}.pkl&#39;)</span>

<span class="c1">#         os.rename(f&#39;memory_{nr_list[-1]}.pkl&#39;, &#39;memory.pkl&#39;)</span>
<span class="c1">#         print(f&#39;Deleted all memory files in {ckpoint} but the {nr_list[-1]}th one, which was renamed memory.pkl&#39;)</span>
<span class="c1">#     os.chdir(original_dir)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#from bayesflow.helper_functions import generate_lr_adjustment_dict</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bayesflow.forward_inference</span> <span class="kn">import</span> <span class="n">GenerativeModel</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">Simulator</span>
<span class="kn">from</span> <span class="nn">bayesflow.networks</span> <span class="kn">import</span> <span class="n">InvertibleNetwork</span><span class="p">,</span> <span class="n">InvariantNetwork</span>
<span class="kn">from</span> <span class="nn">bayesflow.amortized_inference</span> <span class="kn">import</span> <span class="n">AmortizedPosterior</span>
<span class="kn">from</span> <span class="nn">bayesflow.trainers</span> <span class="kn">import</span> <span class="n">Trainer</span>
<span class="kn">import</span> <span class="nn">bayesflow.diagnostics</span> <span class="k">as</span> <span class="nn">diag</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/rene/Bf_ecg/BayesFlow/bayesflow/forward_inference.py:27: TqdmWarning: IProgress not found. Please update jupyter and ipywidgets. See https://ipywidgets.readthedocs.io/en/stable/user_install.html
  from tqdm.autonotebook import tqdm
</pre></div></div>
</div>
<section id="Introduction:-Synthetically-Modeling-ECG-with-BayesFlow">
<h1>Introduction: Synthetically Modeling ECG with BayesFlow<a class="headerlink" href="#Introduction:-Synthetically-Modeling-ECG-with-BayesFlow" title="Permalink to this heading"></a></h1>
<p>This notebook serves as an introduction to the BayesFlow library by applying it to a mathematical model capable of producing a synthetic electrocardiogram (ECG). The goal is to learn to predict the distribution of various model parameters from a simulated ECG signal.</p>
<p>Our tutorial begins with a very brief introduction to the ECG signal, a time series of frequencies representing the depolarization and repolarization of various portions of the heart in the course of each heartbeat, and the way in which the simulation model attempts to reproduce its properties. We then turn to an implementation of this model, which is in turn fed into an appropriate BayesFlow architecture in order to learn the parameter distributions. We conclude by evaluating the performance of
our BayesFlow.</p>
<p>Here is a segment of ECG representing a single heartbeat:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Image</span><span class="p">(</span><span class="n">url</span><span class="o">=</span> <span class="s2">&quot;https://upload.wikimedia.org/wikipedia/commons/9/9e/SinusRhythmLabels.svg&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="c1"># (Created by Agateller (Anthony Atkielski), converted to svg by atom., Public domain, via Wikimedia Commons)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<img src="https://upload.wikimedia.org/wikipedia/commons/9/9e/SinusRhythmLabels.svg" width="500" height="500"/></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">single_gaussian</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">c</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">t</span><span class="o">-</span><span class="n">theta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>
<span class="k">for</span> <span class="n">A</span> <span class="ow">in</span> <span class="mi">10</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">single_gaussian</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">a</span><span class="o">=</span><span class="n">A</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">T</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_8_0.png" src="../_images/tutorial_notebooks_ECG_Model_8_0.png" />
</div>
</div>
<p>The local maxima and minima of the signal characterize five waves labelled P,Q,R,S and T. Their relative shape and size can be used by clinicians to draw conclusions about the cardiac health of a patient.</p>
<p>In their 2003 paper, McSherry et al. proposed a model for generating a synthetic ECG signal using a system of ordinary differential equations (ODEs). A brief explanation of this system is given below, with a focus on its connection to the generated ECG signal (i.e. how it works), whereas the motivation behind the system (i.e. why it works) is largely ignored.</p>
<p>The solution <span class="math notranslate nohighlight">\(z\)</span> of the third differential equation in the system represents the actual ECG signal as a function of time, whereas the solutions <span class="math notranslate nohighlight">\(x\)</span> and <span class="math notranslate nohighlight">\(y\)</span> of the first two equations have to do with the duration of each heartbeat (note that we are omitting the argument <span class="math notranslate nohighlight">\(t\)</span> throughout, writing e.g. <span class="math notranslate nohighlight">\(x\)</span> for <span class="math notranslate nohighlight">\(x(t)\)</span>):</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{cases}
\dot{x} = \alpha(x,y) x - \omega y\\
\dot{y} = \alpha(x,y) y + \omega x\\
\dot{z} = -\sum_{i \in \{P,Q,R,S,T\}} a_i \Delta \theta_i(y,x) \exp \left( \frac{-(\Delta \theta_i(y,x))^2}{2b_i^2} \right)-(z-z_0)
\end{cases}\end{split}\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\alpha(x(t),y(t)) = 1 - \sqrt{x^2(t)+y^2(t)} \qquad \Delta \theta_i(y(t),x(t)) = (\text{atan2}(y(t),x(t))-\theta_i) \mod 2\pi \qquad z_0(t) = 0.005 \sin(2 \pi t f_2)\]</div>
<p>The parameters <span class="math notranslate nohighlight">\(a=(a_P, a_Q, a_R, a_S, a_T), b=(b_P, b_Q, b_R, b_S, b_T)\)</span> and <span class="math notranslate nohighlight">\(\theta = (\theta_P, \theta_Q, \theta_R, \theta_S, \theta_T)\)</span> are time-independent five-dimensional vectors which primarily determine the structure of the waves comprising the ECG signal, which is why their entries are indexed with the names of the waves. <span class="math notranslate nohighlight">\(a\)</span> determines the amplitude of each wave (i.e. how low/high its minimum/maximum is), <span class="math notranslate nohighlight">\(b\)</span> determines the width of each wave, and
<span class="math notranslate nohighlight">\(\theta\)</span> determines the position of each wave within a heartbeat.</p>
<p><span class="math notranslate nohighlight">\(\omega\)</span> is a time-dependent function responsible for modelling changes in duration between two heartbeats. The biological processes which it models and its mathematical construction exceed the scope of this tutorial, however. Here, it is treated as a time-independent constant. Thus, the simplified model below generates a sequence of largely identical heartbeats.</p>
<p>Changes between heartbeats only result from a wandering baseline frequency (implemented via <span class="math notranslate nohighlight">\(z_0\)</span>, which contains the (constant) respiratory frequency <span class="math notranslate nohighlight">\(f_2\)</span>) and noise added to the simulated ECG signal in order to simulate measurement errors.</p>
<p>Constant omega (<span class="math notranslate nohighlight">\(\forall t: \omega(t) = c\)</span> for some <span class="math notranslate nohighlight">\(c \in [0, 2\pi)\)</span>) means that <span class="math notranslate nohighlight">\(x(t) = cos(ct)\)</span> and <span class="math notranslate nohighlight">\(y(t) = sin(ct)\)</span> and as such <span class="math notranslate nohighlight">\(\Delta \theta_i(y,x) = ct\)</span>, so we could limit ourselves to the last differential equation in order to simulate our ECG.</p>
<p>Things simplify even further if we omit the baseline-wander-related error term <span class="math notranslate nohighlight">\(z-z_0\)</span>. <span class="math notranslate nohighlight">\(z\)</span> can then be explictly computed as the antiderivative of <span class="math notranslate nohighlight">\(z'\)</span>:</p>
<div class="math notranslate nohighlight">
\[z(t) = \sum_{i \in \{P,Q,R,S,T\}} a_i \frac{2 b_i^2}{2c} \exp \left( -\frac{(ct - \theta_i)^2}{2b_i^2}\right) = \frac{1}{c}\sum_{i \in \{P,Q,R,S,T\}} a_ib_i^2 \exp \left( -\frac{(ct - \theta_i)^2}{2b_i^2}\right)\]</div>
<p>In order to specify the model, <span class="math notranslate nohighlight">\(\theta\)</span>, <span class="math notranslate nohighlight">\(a\)</span> and <span class="math notranslate nohighlight">\(b\)</span> are given default values which will then be varied in order to generate different simulations. They are grouped together in the params_ODE dictionary below, along with the (unvarying) respiratory frequency <span class="math notranslate nohighlight">\(f_2=0.25\)</span>.</p>
<p>The simulation itself requires a variety of internal parameters. Some (e.g. the initial value pos_0) pertain to the numerical solution of the ODE system (which employs a standard Runge-Kutta method, the socalled Dormand-Prince method), others have to do with the specific nature of modeling a signal corresponding to measurements over time (e.g. the model-internal sampling frequency, sf_int, and the sampling frequency of the synthetic ECG output, sf_ecg), and a few correspond to biological
quantities (e.g. the mean heartrate, heartrate_mean). All simulation-related parameters are compiled into a dictionary (params_sim) below.</p>
<p>Of these, the signal duration and the sampling frequencies are kept fixed in this tutorial, because this ensures a signal of constant length in each run of the simulator, which is a prerequisite for the chosen (convolutional) neural architecture to function. The mean heartrate, by contrast, is varied alongside the ODE parameters. A specific mean heartrate requires a rescaling of the positional and width parameters <span class="math notranslate nohighlight">\(\theta\)</span> and <span class="math notranslate nohighlight">\(b\)</span>, so these parameters, at least, are not independent.</p>
<p>We next turn to the implementation of our ECG simulation model, which begins by initializing our parameters.</p>
</section>
<section id="1:-Implementing-the-ECG-Model">
<h1>1: Implementing the ECG Model<a class="headerlink" href="#1:-Implementing-the-ECG-Model" title="Permalink to this heading"></a></h1>
<p>Much of the implementation below is inspired by McSharry et al.’s (2003) own work ( <a class="reference external" href="https://github.com/neuropsychology/NeuroKit">https://github.com/neuropsychology/NeuroKit</a> ). Several changes were made with readability in mind, however: our code is packaged into a greater number of individual functions, and our variable names are often a bit more explicit than their counterparts in NeuroKit. Where possible, vectorized implementations were chosen over loops in order to speed up computation.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Function to initialize the various model parameters.</span>
<span class="c1"># Details on the role of each parameter are given below.</span>

<span class="k">def</span> <span class="nf">initialize_model_parameters</span><span class="p">(</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]),</span> \
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">1.2</span><span class="p">,</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span><span class="mf">30.0</span><span class="p">,</span><span class="o">-</span><span class="mf">7.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">]),</span> \
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">]),</span> \
    <span class="n">f_2</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> \
    <span class="n">Nt</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span> <span class="n">pos_0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.04</span><span class="p">]),</span> \
    <span class="n">sf_int</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">sf_ecg</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span> \
    <span class="n">noise_amp</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">noise_freq</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">noise_type</span> <span class="o">=</span> <span class="s1">&#39;laplace&#39;</span><span class="p">,</span> \
    <span class="n">heartrate_mean</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">heartrate_std</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> \
    <span class="n">duration</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span> <span class="n">N_heartbeats</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> \
    <span class="n">phase_offset</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reparametrize</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>

    <span class="c1">## ODE system parameters</span>

    <span class="c1"># theta: PQRST positions (as specified in the paper)</span>
    <span class="c1"># The original Matlab and later NeuroKit implementations use an approximation instead:</span>
    <span class="c1"># theta = np.array([-70, -15, 0, 15, 100])/180*np.pi</span>

    <span class="c1"># a: PQRST height modifiers</span>

    <span class="c1"># b: PQRST width modifiers</span>

    <span class="c1"># f_2: Respiratory frequency</span>
    <span class="k">if</span> <span class="n">reparametrize</span><span class="p">:</span>
        <span class="n">params_ODE</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;d&#39;</span><span class="p">:</span> <span class="n">a</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">b</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;f_2&#39;</span><span class="p">:</span> <span class="n">f_2</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params_ODE</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span> <span class="s1">&#39;f_2&#39;</span><span class="p">:</span> <span class="n">f_2</span><span class="p">}</span>

    <span class="c1">## Parameters for numeric integration of ODE system</span>

    <span class="c1"># Nt: No of samples / times t at which to integrate</span>

    <span class="c1"># pos_0: Initial value for initial value problem to be solved</span>
    <span class="c1"># (other candidate: pos_0 = np.asarray([1, 0, 0]))</span>

    <span class="c1"># sf_int: Internal sampling frequency</span>

    <span class="c1"># sf_ecg: Sampling frequency of ecg; in practice, ECGs can be measured with a</span>
    <span class="c1"># variety of sampling frequencies. 250 and 360 are typical choices, and the</span>
    <span class="c1"># lower frequency was selected here to keep the size of simulated data samples</span>
    <span class="c1"># as manageable as possible.</span>

    <span class="c1"># noise_amp, noise_freq, noise_type: Parameters of additive noise (amplitude, frequency, type)</span>

    <span class="c1"># heartrate_mean, heartrate_std: Mean and standard deviation of heart rate</span>
    <span class="c1"># (take precedent over number of samples if both are given)</span>

    <span class="c1"># duration, N_heartbeats: if heartrate_mean and heartrate_std are provided, the duration of the ecg signal</span>
    <span class="c1"># or an approximate number of heartbeats must be specified</span>
    <span class="c1"># If both are given, duration takes precedent over the approximate number of heartbeats.</span>

    <span class="c1"># phase_offset: a fraction (between 0 and 1) by which the start of the signal is shifted right</span>
    <span class="c1"># from the first R-peak (equivalently: the fraction of the first heartbeat generated which is removed</span>
    <span class="c1"># from the output). If None is given, this parameter is chosen randomly during signal generation.</span>

    <span class="c1"># The dependent parameters used by the numerical method used to solve the system of ODEs</span>
    <span class="c1"># are based around max_t, the latest time point t at which the approximate solution is computed:</span>
    <span class="c1"># t_span is a list of the first and list t (i.e. 0 and max_t), and t_eval is an array of Nt time points</span>
    <span class="c1"># within this range. Note that all of these parameters are always recomputed below, since we systematically</span>
    <span class="c1"># supply a mean heartrate.</span>
    <span class="n">max_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">sf_int</span><span class="p">)</span>
    <span class="n">t_span</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_t</span><span class="p">]</span>
    <span class="n">t_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_t</span><span class="p">,</span> <span class="n">Nt</span><span class="p">)</span>

    <span class="n">params_sim</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sf_int&#39;</span><span class="p">:</span> <span class="n">sf_int</span><span class="p">,</span> <span class="s1">&#39;sf_ecg&#39;</span><span class="p">:</span> <span class="n">sf_ecg</span><span class="p">,</span> <span class="s1">&#39;Nt&#39;</span><span class="p">:</span> <span class="n">Nt</span><span class="p">,</span> <span class="s1">&#39;max_t&#39;</span><span class="p">:</span> <span class="n">max_t</span><span class="p">,</span> \
                  <span class="s1">&#39;pos_0&#39;</span><span class="p">:</span> <span class="n">pos_0</span><span class="p">,</span> <span class="s1">&#39;t_span&#39;</span><span class="p">:</span> <span class="n">t_span</span><span class="p">,</span> <span class="s1">&#39;t_eval&#39;</span><span class="p">:</span> <span class="n">t_eval</span><span class="p">,</span> \
                  <span class="s1">&#39;noise_amplitude&#39;</span><span class="p">:</span> <span class="n">noise_amp</span><span class="p">,</span> <span class="s1">&#39;noise_frequency&#39;</span><span class="p">:</span> <span class="n">noise_freq</span><span class="p">,</span> <span class="s1">&#39;noise_type&#39;</span><span class="p">:</span> <span class="n">noise_type</span><span class="p">,</span> \
                  <span class="s1">&#39;heartrate_mean&#39;</span><span class="p">:</span> <span class="n">heartrate_mean</span><span class="p">,</span> <span class="s1">&#39;heartrate_std&#39;</span><span class="p">:</span> <span class="n">heartrate_std</span><span class="p">,</span> \
                  <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="n">duration</span><span class="p">,</span> <span class="s1">&#39;N_heartbeats&#39;</span><span class="p">:</span> <span class="n">N_heartbeats</span><span class="p">,</span> <span class="s1">&#39;phase_offset&#39;</span><span class="p">:</span> <span class="n">phase_offset</span><span class="p">}</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Params ODE:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">params_ODE</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Params simulation:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">params_sim</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">params_ODE</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">)</span>

<span class="c1">### Implementation of the FMM_ecg model (Rueda et al. 2021)</span>
<span class="k">def</span> <span class="nf">initialize_FMM</span><span class="p">(</span><span class="n">M_FMM</span> <span class="o">=</span> <span class="mf">0.03</span><span class="p">,</span> \
                   <span class="n">A_FMM</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">1164</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">5.0</span><span class="p">,</span><span class="o">-</span><span class="mf">30.0</span><span class="p">,</span><span class="mf">7.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">15.0</span><span class="p">]),</span>
                   <span class="c1">#A_FMM = (1/1050)*np.asarray([-9.0,4,-27.0,8, -13.5]), \</span>
                   <span class="n">alpha_FMM</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]),</span>
                   <span class="n">beta_FMM</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> \
                   <span class="n">omega_FMM</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mf">0.21</span><span class="p">,</span><span class="mf">0.06</span><span class="p">,</span><span class="mf">0.045</span><span class="p">,</span><span class="mf">0.06</span><span class="p">,</span><span class="mf">0.27</span><span class="p">]),</span> \
                   <span class="n">f2_FMM</span> <span class="o">=</span> <span class="mf">0.25</span><span class="p">,</span> \
                   <span class="n">sigma_FMM</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>


    <span class="n">params_FMM</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;M_FMM&#39;</span><span class="p">:</span> <span class="n">M_FMM</span><span class="p">,</span> <span class="s1">&#39;A_FMM&#39;</span><span class="p">:</span> <span class="n">A_FMM</span><span class="p">,</span> <span class="s1">&#39;alpha_FMM&#39;</span><span class="p">:</span> <span class="n">alpha_FMM</span><span class="p">,</span> <span class="s1">&#39;beta_FMM&#39;</span><span class="p">:</span> <span class="n">beta_FMM</span><span class="p">,</span> \
                  <span class="s1">&#39;omega_FMM&#39;</span><span class="p">:</span> <span class="n">omega_FMM</span><span class="p">,</span> <span class="s1">&#39;f2_FMM&#39;</span><span class="p">:</span> <span class="n">f2_FMM</span><span class="p">,</span> <span class="s1">&#39;sigma_FMM&#39;</span><span class="p">:</span> <span class="n">sigma_FMM</span><span class="p">}</span>

    <span class="c1"># M_FMM is a vertical offset</span>
    <span class="c1"># A_FMM determines the amplitude of the five ECG waves</span>
    <span class="c1"># alpha_FMM determines the location of the five ECG waves</span>
    <span class="c1"># beta_FMM determines the skewness/asymmetry of the five ECG</span>
    <span class="c1"># omega_FMM determines the width of the five ECG waves</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">FMM parameters:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">params_FMM</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">params_FMM</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># params_FMM = initialize_FMM()</span>
<span class="c1"># params_GM, params_sim = initialize_model_parameters()</span>
<span class="c1"># params_sim[&#39;duration&#39;] = 1</span>
<span class="c1"># params_sim[&#39;heartrate_mean&#39;] = 60</span>
<span class="c1"># xdata_GM, ydata_GM, zdata_GM = generate_ECG(params_GM, params_sim, baseline_wander=True)</span>
<span class="c1"># xdata_FMM, ydata_FMM, zdata_FMM = generate_ECG(params_FMM, params_sim, baseline_wander=True)</span>

<span class="c1"># fig_2d = plt.figure(figsize=(10,8))</span>
<span class="c1"># ax_2d = plt.axes()</span>
<span class="c1"># plt.xlabel(&quot;Time (s)&quot;)</span>
<span class="c1"># plt.ylabel(&quot;Frequency (Hz)&quot;)</span>
<span class="c1"># ax_2d.plot(np.arange(len(zdata_FMM)), zdata_FMM, label=&#39;FMM&#39;)</span>
<span class="c1"># ax_2d.plot(np.arange(len(zdata_FMM)), zdata_GM, label=&#39;GM&#39;)</span>
<span class="c1"># ax_2d.legend()</span>
<span class="c1"># plot_ecg_segment(zdata_FMM, params_sim[&#39;sf_ecg&#39;])</span>
<span class="c1"># plot_ecg_segment(zdata_GM, params_sim[&#39;sf_ecg&#39;])</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># For the sake of convenience, several parameters to do with training are currently</span>
<span class="c1"># read from an options file, ecg_options.txt.</span>
<span class="n">sf_ecg</span> <span class="o">=</span> <span class="mi">250</span>
<span class="n">model_par_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">]</span>
<span class="n">sim_par_list</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">variation_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">stdn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">trunc_low</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">trunc_high</span> <span class="o">=</span> <span class="mf">0.005</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">summary_net_type</span> <span class="o">=</span> <span class="s1">&#39;CNN&#39;</span>
<span class="n">patience</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">coupling_block_size</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">spectral_normalization</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">train_epochwise</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">default_priors</span> <span class="o">=</span> <span class="kc">True</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;ecg_options.txt&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">opt_file</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">opt_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Duration&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ECG sampling frequency&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sf_ecg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Model Parameters to Vary&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ODE Parameters to Vary&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">model_par_list</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Use default priors&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">default_priors</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Variation mean&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">variation_mean</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Variation Standard Deviation&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">stdn</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Variation lower bound&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">trunc_low</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Variation upper bound&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">trunc_high</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Simulation Parameters to Vary&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">sim_par_list</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Baseline wander&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">baseline_wander</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Summary Net&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">summary_net_type</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;n_summary&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">n_summary</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Depth INN&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">depth_INN</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Coupling block size&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">coupling_block_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Spectral normalization&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spectral_normalization</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Presimulation path&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">presimulation_path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Checkpoint path&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Number of epochs&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">epochs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Train epoch-wise&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">train_epochwise</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Patience&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">patience</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Initial learning rate&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">initial_lr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Learning rate change points&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">lr_changepoints</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Learning rates&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">learning_rates</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Iterations per epoch&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">iterations_per_epoch</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">line</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;Batch size&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;(.*?)\&quot;&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="c1">#checkpoint_path = &#39;checkpoints_Oct26_2&#39;</span>
<span class="c1">#checkpoint_path = &#39;checkpoints_Oct31&#39;</span>
<span class="n">checkpoint_path</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;tutorial_notebooks\/(.*)&#39;</span><span class="p">,</span> <span class="n">checkpoint_path</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#Signs of learning: Sep26, Sep27, Sep28</span>
<span class="c1">#&#39;/home/rene/Bf_ecg/BayesFlow/docs/source/tutorial_notebooks/checkpoints_Aug31&#39;</span>

<span class="k">if</span> <span class="s1">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">model_par_list</span><span class="p">:</span>
    <span class="n">params_ODE</span><span class="p">,</span> <span class="n">params_sim</span> <span class="o">=</span> <span class="n">initialize_model_parameters</span><span class="p">(</span><span class="n">reparametrize</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">params_ODE</span><span class="p">,</span> <span class="n">params_sim</span> <span class="o">=</span> <span class="n">initialize_model_parameters</span><span class="p">()</span>

<span class="c1"># If the model parameter list intersects with the parameter list for the FMM model, that model is chosen.</span>
<span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">model_par_list</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;A_FMM&#39;</span><span class="p">,</span><span class="s1">&#39;alpha_FMM&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_FMM&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_FMM&#39;</span><span class="p">,</span> <span class="s1">&#39;M_FMM&#39;</span><span class="p">])):</span>
    <span class="n">params_model</span> <span class="o">=</span> <span class="n">initialize_FMM</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">params_model</span> <span class="o">=</span> <span class="n">params_ODE</span>
<span class="c1">#params_sim[&#39;duration&#39;] = 1</span>
<span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Params ODE:
{&#39;d&#39;: array([ 0.075, -0.05 ,  0.3  , -0.075,  0.12 ]), &#39;b&#39;: array([0.25, 0.1 , 0.1 , 0.1 , 0.4 ]), &#39;theta&#39;: array([-1.04719755, -0.26179939,  0.        ,  0.26179939,  1.57079633]), &#39;f_2&#39;: 0.25}

 Params simulation:
{&#39;sf_int&#39;: 1000, &#39;sf_ecg&#39;: 250, &#39;Nt&#39;: 5000, &#39;max_t&#39;: 4.999, &#39;pos_0&#39;: array([1.  , 0.  , 0.04]), &#39;t_span&#39;: [0, 4.999], &#39;t_eval&#39;: array([0.000e+00, 1.000e-03, 2.000e-03, ..., 4.997e+00, 4.998e+00,
       4.999e+00]), &#39;noise_amplitude&#39;: 0.01, &#39;noise_frequency&#39;: 100, &#39;noise_type&#39;: &#39;laplace&#39;, &#39;heartrate_mean&#39;: None, &#39;heartrate_std&#39;: 1, &#39;duration&#39;: 30, &#39;N_heartbeats&#39;: None, &#39;phase_offset&#39;: None}
</pre></div></div>
</div>
<p>Below, the model is implemented in the spirit of functional programming: the differential equations are organized as combinations of simpler functions.</p>
<p>Once the ODE system has been defined (ECG_model), an infrastructure for numerically solving it is created, which involves potentially rescaling various parameters based on the mean heartrate. Postprocessing of the signal includes rescaling the signal to lie between <span class="math notranslate nohighlight">\(-0.4\)</span> and <span class="math notranslate nohighlight">\(+1.2\)</span> Hz and adding noise.</p>
<p>Simulations are run via the generate_ECG function. At its core is the solution of the ODE system, which has to be given an initial value (in the form of the variable pos_0) in order to be uniquely solvable. A standard numerical method for solving systems of ODEs is used here: the Dormand-Prince method ( <a class="reference external" href="https://en.wikipedia.org/wiki/Dormand%E2%80%93Prince_method">https://en.wikipedia.org/wiki/Dormand%E2%80%93Prince_method</a> ), which is the default choice for scipy’s integrate.solve_ivp method.</p>
<p>We also provide a function for visualizing a segment of ECG.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Implementation of the system of ODEs used in the model</span>

<span class="c1"># Helper functions</span>
<span class="k">def</span> <span class="nf">alpha</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">((</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span> <span class="mf">.5</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">delta_theta</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">theta</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fmod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">theta</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">delta_alpha</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">alpha_FMM</span><span class="p">):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fmod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">alpha_FMM</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">gauss_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">theta</span><span class="p">):</span>
    <span class="n">d_p</span> <span class="o">=</span> <span class="n">delta_theta</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">theta</span><span class="p">)</span>
    <span class="n">gauss_summands</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">d_p</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="p">((</span><span class="n">d_p</span><span class="o">/</span><span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gauss_summands</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">FMM_sum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">A_FMM</span><span class="p">,</span><span class="n">alpha_FMM</span><span class="p">,</span><span class="n">beta_FMM</span><span class="p">,</span><span class="n">omega_FMM</span><span class="p">):</span>
    <span class="n">tan_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">delta_alpha</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">alpha_FMM</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">FMM_summands</span> <span class="o">=</span> <span class="n">A_FMM</span><span class="o">*</span><span class="n">omega_FMM</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta_FMM</span> <span class="o">+</span> \
                    <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">omega_FMM</span><span class="o">*</span><span class="n">tan_p</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">tan_p</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">omega_FMM</span><span class="o">*</span><span class="n">omega_FMM</span><span class="o">*</span><span class="n">tan_p</span><span class="o">*</span><span class="n">tan_p</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">FMM_summands</span><span class="p">))</span>

<span class="c1"># Note that the paper specifies A = 0.15, but this distorts the entire signal</span>
<span class="c1"># rather than just creating baseline wander.</span>
<span class="k">def</span> <span class="nf">z_0</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">f_2</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">):</span><span class="c1">#A=0.005):</span>
    <span class="k">return</span><span class="p">(</span><span class="n">A</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">f_2</span><span class="o">*</span><span class="n">t</span><span class="p">))</span>

<span class="c1"># Handles the logic of whether baseline wander is applied or not</span>
<span class="k">def</span> <span class="nf">get_z_zero</span><span class="p">(</span><span class="n">baseline_wander</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">baseline_wander</span><span class="p">:</span>
        <span class="n">z_zero</span> <span class="o">=</span> <span class="n">z_0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z_zero</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">f_2</span><span class="p">:</span> <span class="mi">0</span>
    <span class="k">return</span><span class="p">(</span><span class="n">z_zero</span><span class="p">)</span>

<span class="c1"># Actual system of ODEs</span>
<span class="k">def</span> <span class="nf">ECG_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">T_om</span><span class="p">,</span> <span class="n">params_ODE</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">z_zero</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">alpha_yx</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">omega_T</span> <span class="o">=</span> <span class="n">omega</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">T_om</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">],</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;Nt&#39;</span><span class="p">])</span>

    <span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">alpha_yx</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">omega_T</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha_yx</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">omega_T</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="n">gauss_sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">params_ODE</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span><span class="n">params_ODE</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">],</span><span class="n">params_ODE</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">])</span> \
                <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">z_zero</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">params_ODE</span><span class="p">[</span><span class="s1">&#39;f_2&#39;</span><span class="p">])]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">ECG_model_FMM</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">T_om</span><span class="p">,</span> <span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">,</span> <span class="n">omega</span><span class="p">,</span> <span class="n">z_zero</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">alpha_yx</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">omega_T</span> <span class="o">=</span> <span class="n">omega</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">T_om</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">],</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;Nt&#39;</span><span class="p">])</span>

    <span class="n">position</span> <span class="o">=</span> <span class="p">[</span><span class="n">alpha_yx</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">omega_T</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha_yx</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">omega_T</span><span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> \
                <span class="n">omega_T</span><span class="o">*</span><span class="n">FMM_sum</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;A_FMM&#39;</span><span class="p">],</span><span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;alpha_FMM&#39;</span><span class="p">],</span><span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;beta_FMM&#39;</span><span class="p">],</span> \
                       <span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;omega_FMM&#39;</span><span class="p">])</span><span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">z_zero</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;f2_FMM&#39;</span><span class="p">])]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">position</span><span class="p">)</span>

<span class="c1"># Explicit solution in case there is no baseline wander</span>
<span class="k">def</span> <span class="nf">Explicit_ECG</span><span class="p">(</span><span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">,</span> <span class="n">omega</span><span class="p">):</span>
    <span class="n">t_eval</span> <span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;t_eval&#39;</span><span class="p">]</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;Nt&#39;</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="n">t_eval</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="n">t_eval</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nt</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">params_model</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="s1">&#39;theta&#39;</span><span class="p">])):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;d&#39;</span> <span class="ow">in</span> <span class="n">params_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">z</span> <span class="o">+=</span> <span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">delta_theta</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
                <span class="n">z</span> <span class="o">+=</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">delta_theta</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

        <span class="n">z</span> <span class="o">*=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">omega</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">omega_FMM</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;omega_FMM&#39;</span><span class="p">]</span>
        <span class="n">alpha_FMM</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;alpha_FMM&#39;</span><span class="p">]</span>
        <span class="n">beta_FMM</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;beta_FMM&#39;</span><span class="p">]</span>
        <span class="n">A_FMM</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;A_FMM&#39;</span><span class="p">]</span>
        <span class="n">M_FMM</span> <span class="o">=</span> <span class="n">params_model</span><span class="p">[</span><span class="s1">&#39;M_FMM&#39;</span><span class="p">]</span>
        <span class="c1">#Start at R like GM: T_FMM = np.fmod(t_eval*omega+np.pi, 2*np.pi)</span>
        <span class="c1">#Start before P unlike GM: T_FMM = np.fmod(t_eval*omega, 2*np.pi)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="c1">#z += A_FMM[i]*np.cos(beta_FMM[i]+2*np.arctan(omega_FMM[i]*np.tan((T_FMM-alpha_FMM[i])/2)))</span>
            <span class="n">z</span> <span class="o">+=</span> <span class="n">A_FMM</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta_FMM</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">omega_FMM</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">delta_alpha</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">alpha_FMM</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="n">M_FMM</span>

    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>

<span class="c1">## Functions used to rescale the parameters depending on the inputs given</span>

<span class="c1"># If a mean heartrate is specified, the PQRS locations and widths have to be adapted.</span>
<span class="k">def</span> <span class="nf">rescale_ODE_params</span><span class="p">(</span><span class="n">params_ODE</span><span class="p">,</span> <span class="n">heartrate_mean</span><span class="p">):</span>
    <span class="n">hr_fact</span> <span class="o">=</span> <span class="p">(</span><span class="n">heartrate_mean</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">hr_fact2</span> <span class="o">=</span> <span class="n">hr_fact</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="n">params_ODE_rescaled</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_ODE</span><span class="p">)</span>
    <span class="n">params_ODE_rescaled</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">hr_fact2</span><span class="p">,</span> <span class="n">hr_fact</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hr_fact</span><span class="p">,</span> <span class="n">hr_fact2</span><span class="p">])</span>
    <span class="n">params_ODE_rescaled</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">hr_fact</span>
    <span class="k">return</span><span class="p">(</span><span class="n">params_ODE_rescaled</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rescale_FMM_params</span><span class="p">(</span><span class="n">params_model</span><span class="p">,</span> <span class="n">heartrate_mean</span><span class="p">):</span>
    <span class="n">hr_fact</span> <span class="o">=</span> <span class="p">(</span><span class="n">heartrate_mean</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">hr_fact2</span> <span class="o">=</span> <span class="n">hr_fact</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="n">params_FMM_rescaled</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_model</span><span class="p">)</span>
    <span class="n">params_FMM_rescaled</span><span class="p">[</span><span class="s1">&#39;alpha_FMM&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">hr_fact2</span><span class="p">,</span> <span class="n">hr_fact</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hr_fact</span><span class="p">,</span> <span class="n">hr_fact2</span><span class="p">])</span>
    <span class="n">params_FMM_rescaled</span><span class="p">[</span><span class="s1">&#39;omega_FMM&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="n">hr_fact</span>
    <span class="k">return</span><span class="p">(</span><span class="n">params_FMM_rescaled</span><span class="p">)</span>

<span class="c1"># In conjunction with the mean heartrate, either a desired duration or</span>
<span class="c1"># an approximate number of desired heartbeats (N_heartbeats) must be specified.</span>
<span class="c1"># The unknown quantity is computed from the one given (e.g. unknown N_heartbeats from known duration)</span>
<span class="k">def</span> <span class="nf">rescale_simulation_params</span><span class="p">(</span><span class="n">params_sim</span><span class="p">,</span> <span class="n">heartrate_mean</span><span class="p">):</span>
    <span class="n">params_sim_rescaled</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_sim</span><span class="p">)</span>

    <span class="c1"># Ensure that all parameters which have to be integers are in fact integers</span>
    <span class="c1"># (Note that several parameters, e.g. the mean heartrate, may be defined as integers by the user,</span>
    <span class="c1"># but this is not a conceptual or numerical requirement at any point.)</span>
    <span class="k">for</span> <span class="n">int_param</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">,</span> <span class="s1">&#39;sf_ecg&#39;</span><span class="p">,</span> <span class="s1">&#39;Nt&#39;</span><span class="p">,</span> <span class="s1">&#39;noise_frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;N_heartbeats&#39;</span><span class="p">]:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="n">int_param</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params_sim_rescaled</span><span class="p">[</span><span class="n">int_param</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;N_heartbeats&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Determine approximate number of heartbeats</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">heartrate_mean</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)))</span>
        <span class="n">params_sim_rescaled</span><span class="p">[</span><span class="s1">&#39;N_heartbeats&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span>
        <span class="c1">#print(N)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">N</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please specify either a duration or an approximate number of heartbeats.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Determine duration</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">N</span><span class="o">*</span><span class="mi">60</span><span class="o">/</span><span class="n">heartrate_mean</span>
            <span class="n">params_sim_rescaled</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span>

    <span class="c1"># Determine number of samples needed and latest time point</span>
    <span class="c1"># Add a buffer of 1 second (i.e. 1 x sf_int) which will be trimmed off at the end</span>
    <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">d</span><span class="o">*</span><span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">]</span>
    <span class="n">params_sim_rescaled</span> <span class="o">=</span> <span class="n">rescale_Nt</span><span class="p">(</span><span class="n">params_sim_rescaled</span><span class="p">,</span> <span class="n">Nt</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">params_sim_rescaled</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">rescale_Nt</span><span class="p">(</span><span class="n">params_sim</span><span class="p">,</span> <span class="n">Nt</span><span class="p">):</span>
    <span class="n">params_sim_res</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_sim</span><span class="p">)</span>

    <span class="n">max_t</span> <span class="o">=</span> <span class="p">(</span><span class="n">Nt</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">])</span>

    <span class="n">params_sim_res</span><span class="p">[</span><span class="s1">&#39;Nt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nt</span>
    <span class="n">params_sim_res</span><span class="p">[</span><span class="s1">&#39;max_t&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_t</span>
    <span class="n">params_sim_res</span><span class="p">[</span><span class="s1">&#39;t_eval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">max_t</span><span class="p">,</span><span class="n">Nt</span><span class="p">)</span>
    <span class="n">params_sim_res</span><span class="p">[</span><span class="s1">&#39;t_span&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_t</span><span class="p">]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">params_sim_res</span><span class="p">)</span>

<span class="c1"># Handles the logic behind rescaling the parameters (rescaling occurs if a mean heartrate is given)</span>
<span class="k">def</span> <span class="nf">rescale_if_needed</span><span class="p">(</span><span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">):</span>
    <span class="n">hr_mean</span> <span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;heartrate_mean&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">hr_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hr_mean</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
            <span class="n">hr_mean</span> <span class="o">=</span> <span class="n">hr_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Rescale location and width of PQRST signals to match mean heart rate</span>
        <span class="k">if</span> <span class="s1">&#39;theta&#39;</span> <span class="ow">in</span> <span class="n">params_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">params_model_r</span> <span class="o">=</span> <span class="n">rescale_ODE_params</span><span class="p">(</span><span class="n">params_model</span><span class="p">,</span> <span class="n">hr_mean</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">params_model_r</span> <span class="o">=</span> <span class="n">rescale_FMM_params</span><span class="p">(</span><span class="n">params_model</span><span class="p">,</span> <span class="n">hr_mean</span><span class="p">)</span>
        <span class="c1"># Rescale simulation parameters (time points for evaluation etc) to match mean heart rate</span>
        <span class="n">params_sim_r</span> <span class="o">=</span> <span class="n">rescale_simulation_params</span><span class="p">(</span><span class="n">params_sim</span><span class="p">,</span> <span class="n">hr_mean</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">params_model_r</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_model</span><span class="p">)</span>
        <span class="c1"># Set Nt to match the user-specified duration, plus a buffer of sf_int (the equivalent of</span>
        <span class="c1"># 1s of signal) which will be trimmed off at the end of the simulation process.</span>
        <span class="n">Nt</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;duration&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">])</span><span class="o">+</span><span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">]</span>
        <span class="n">params_sim_r</span> <span class="o">=</span> <span class="n">rescale_Nt</span><span class="p">(</span><span class="n">params_sim</span><span class="p">,</span> <span class="n">Nt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">params_model_r</span><span class="p">,</span> <span class="n">params_sim_r</span>

<span class="c1"># Trims 1 x sf_int (the equivalent of 1s of signal) off the signal</span>
<span class="c1"># A random portion is trimmed off the left, the rest is trimmed off the right</span>
<span class="k">def</span> <span class="nf">trim_signal</span><span class="p">(</span><span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">,</span> <span class="n">z_int</span><span class="p">,</span> <span class="n">params_sim_r</span><span class="p">):</span>
    <span class="n">sf_int</span> <span class="o">=</span> <span class="n">params_sim_r</span><span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">]</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="n">params_sim_r</span><span class="p">[</span><span class="s1">&#39;phase_offset&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">offset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sf_int</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="o">*</span><span class="n">sf_int</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">sf_int</span><span class="o">-</span><span class="n">l</span>
    <span class="k">return</span><span class="p">(</span><span class="n">x_int</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="o">-</span><span class="n">h</span><span class="p">],</span><span class="n">y_int</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="o">-</span><span class="n">h</span><span class="p">],</span><span class="n">z_int</span><span class="p">[</span><span class="n">l</span><span class="p">:</span><span class="o">-</span><span class="n">h</span><span class="p">])</span>

<span class="c1">## Functions used to downsample should the target ecg sampling frequency (sf_ecg) not correspond</span>
<span class="c1">## to the internal sampling frequency (sf_int)</span>

<span class="c1"># q is the ratio between the internal and the ecg sampling rate.</span>
<span class="k">def</span> <span class="nf">get_downsampling_stepsize</span><span class="p">(</span><span class="n">params_sim</span><span class="p">):</span>
    <span class="n">sf_int</span> <span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">]</span>
    <span class="n">sf_ecg</span> <span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_ecg&#39;</span><span class="p">]</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">sf_int</span><span class="o">/</span><span class="n">sf_ecg</span><span class="p">)</span>
    <span class="n">qd</span> <span class="o">=</span> <span class="n">sf_int</span><span class="o">/</span><span class="n">sf_ecg</span>
    <span class="k">if</span> <span class="n">q</span> <span class="o">!=</span> <span class="n">qd</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Internal sampling frequency (sfint) must be an integer multiple of the ECG sampling frequency&quot;</span>
            <span class="s2">&quot; (sfecg). Your current choices are: sfecg = &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sf_ecg</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot; and sfint = &quot;</span>
            <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sf_int</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

<span class="c1"># Handles the logic behind downsampling (downsampling occurs if q is greater than one)</span>
<span class="k">def</span> <span class="nf">downsample_if_needed</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">,</span> <span class="n">z_int</span><span class="p">):</span>
    <span class="c1"># Downsample the signal to sf_ecg (via q = round(sf_int/sf_ecg) )</span>
    <span class="k">if</span> <span class="n">q</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_int</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_int</span><span class="p">),</span> <span class="n">step</span><span class="o">=</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y_int</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_int</span><span class="p">),</span> <span class="n">step</span><span class="o">=</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z_int</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">z_int</span><span class="p">),</span> <span class="n">step</span><span class="o">=</span><span class="n">q</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_int</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y_int</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z_int</span>
    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

<span class="c1">## Post-processing of the ecg signal</span>

<span class="c1"># Rescale signal to the range (target_min, target_max)</span>
<span class="k">def</span> <span class="nf">rescale_signal</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">target_min</span><span class="p">,</span> <span class="n">target_max</span><span class="p">):</span>
    <span class="n">zmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">zmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">z_diff</span> <span class="o">=</span> <span class="n">zmax</span><span class="o">-</span><span class="n">zmin</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z_diff</span><span class="p">):</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">z_diff</span> <span class="o">&gt;</span> <span class="mf">0.0005</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">target_max</span><span class="o">-</span><span class="n">target_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">zmax</span> <span class="o">-</span> <span class="n">zmin</span><span class="p">)</span> <span class="o">+</span> <span class="n">target_min</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">z</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">target_max</span><span class="o">-</span><span class="n">target_min</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">return</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

<span class="c1"># Add additive noise to the signal (typically with a frequency below the sampling frequency)</span>
<span class="k">def</span> <span class="nf">add_distortion</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">noise_amplitude</span><span class="p">,</span> <span class="n">noise_frequency</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">signal_sampling_rate</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> \
                   <span class="n">noise_type</span><span class="o">=</span><span class="s2">&quot;laplace&quot;</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">):</span>
    <span class="c1">#For reproducibility</span>
    <span class="c1">#np.random.seed(random_state)</span>

    <span class="n">n_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
    <span class="n">signal_sd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">signal_sd</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">noise_amplitude</span> <span class="o">*=</span> <span class="n">signal_sd</span>

    <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n_samples</span><span class="p">)</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">n_samples</span> <span class="o">/</span> <span class="n">signal_sampling_rate</span>
    <span class="c1"># Apply a very conservative Nyquist criterion in order to ensure</span>
    <span class="c1"># sufficiently sampled signals.</span>
    <span class="n">nyquist</span> <span class="o">=</span> <span class="n">signal_sampling_rate</span> <span class="o">*</span> <span class="mf">0.1</span>
    <span class="k">if</span> <span class="n">noise_frequency</span> <span class="o">&gt;</span> <span class="n">nyquist</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping requested noise frequency &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; of </span><span class="si">{</span><span class="n">noise_frequency</span><span class="si">}</span><span class="s2"> Hz since it cannot be resolved at &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; the sampling rate of </span><span class="si">{</span><span class="n">signal_sampling_rate</span><span class="si">}</span><span class="s2"> Hz. Please increase &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; sampling rate to </span><span class="si">{</span><span class="n">noise_frequency</span> <span class="o">*</span> <span class="mi">10</span><span class="si">}</span><span class="s2"> Hz or choose &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; frequencies smaller than or equal to </span><span class="si">{</span><span class="n">nyquist</span><span class="si">}</span><span class="s2"> Hz.&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="n">NeuroKitWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">noise</span>
    <span class="c1"># Also make sure that at least one period of the frequency can be</span>
    <span class="c1"># captured over the duration of the signal.</span>

    <span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">noise_frequency</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">duration</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping requested noise frequency &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; of </span><span class="si">{</span><span class="n">noise_frequency</span><span class="si">}</span><span class="s2"> Hz since its period of </span><span class="si">{</span><span class="mi">1</span> <span class="o">/</span> <span class="n">noise_frequency</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; seconds exceeds the signal duration of </span><span class="si">{</span><span class="n">duration</span><span class="si">}</span><span class="s2"> seconds. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; Please choose noise frequencies larger than &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="mi">1</span> <span class="o">/</span> <span class="n">duration</span><span class="si">}</span><span class="s2"> Hz or increase the duration of the &quot;</span>
                <span class="sa">f</span><span class="s2">&quot; signal above </span><span class="si">{</span><span class="mi">1</span> <span class="o">/</span> <span class="n">noise_frequency</span><span class="si">}</span><span class="s2"> seconds.&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="n">NeuroKitWarning</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">noise</span>

    <span class="n">noise_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">noise_frequency</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">noise_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;aplace&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">noise_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;efault&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">laplace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_amplitude</span><span class="p">,</span> <span class="n">noise_duration</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">noise_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;aussian&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">noise_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;ormal&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noise_amplitude</span><span class="p">,</span> <span class="n">noise_duration</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">noise_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;niform&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="n">noise_amplitude</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">bound</span><span class="p">,</span><span class="o">-</span><span class="n">bound</span><span class="p">,</span> <span class="n">noise_duration</span><span class="p">)</span>

    <span class="c1"># Resample via interpolation</span>
    <span class="n">n_noise</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n_noise</span> <span class="o">!=</span> <span class="n">n_samples</span><span class="p">:</span>
        <span class="c1"># Use third order splines to interpolate</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">zoom</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">n_samples</span> <span class="o">/</span> <span class="n">n_noise</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">signal</span><span class="o">+</span><span class="n">noise</span>


<span class="c1">## Generating the simulated ecg</span>
<span class="k">def</span> <span class="nf">generate_ECG</span><span class="p">(</span><span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">og_flavor</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pcw_cst</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Rescale parameters to fit mean heartrate</span>
    <span class="n">params_model_r</span><span class="p">,</span> <span class="n">params_sim_r</span> <span class="o">=</span> <span class="n">rescale_if_needed</span><span class="p">(</span><span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">)</span>

    <span class="c1"># Set the angular velocity to a constant matching the mean heartrate</span>
    <span class="k">if</span> <span class="n">params_sim_r</span><span class="p">[</span><span class="s1">&#39;heartrate_mean&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">omega_constant</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">60</span><span class="o">*</span><span class="n">params_sim_r</span><span class="p">[</span><span class="s1">&#39;heartrate_mean&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">omega_constant</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">T_om</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">om</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">sf_int</span><span class="p">,</span> <span class="n">Nt</span><span class="p">:</span> <span class="n">omega_constant</span>

    <span class="c1"># Determine extent of baseline wander</span>
    <span class="n">z_zero</span> <span class="o">=</span> <span class="n">get_z_zero</span><span class="p">(</span><span class="n">baseline_wander</span><span class="p">)</span>

    <span class="c1"># Generate the signal, either...</span>
    <span class="c1"># ...by solving the IVP if there is baseline wander or...</span>
    <span class="k">if</span> <span class="n">baseline_wander</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;A_FMM&#39;</span> <span class="ow">in</span> <span class="n">params_model_r</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">,</span> <span class="n">z_int</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> \
                                                    <span class="n">ECG_model_FMM</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">T_om</span><span class="p">,</span> <span class="n">params_model_r</span><span class="p">,</span> \
                                                                  <span class="n">params_sim_r</span><span class="p">,</span> <span class="n">om</span><span class="p">,</span> <span class="n">z_zero</span><span class="p">,</span> \
                                                                  <span class="n">baseline_wander</span><span class="p">,),</span> \
                                                    <span class="n">params_sim_r</span><span class="p">[</span><span class="s1">&#39;t_span&#39;</span><span class="p">],</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">],</span> \
                                                    <span class="n">t_eval</span><span class="o">=</span><span class="n">params_sim_r</span><span class="p">[</span><span class="s1">&#39;t_eval&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">y</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">,</span> <span class="n">z_int</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> \
                                                            <span class="n">ECG_model</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">T_om</span><span class="p">,</span> <span class="n">params_model_r</span><span class="p">,</span> <span class="n">params_sim_r</span><span class="p">,</span> \
                                                                      <span class="n">om</span><span class="p">,</span> <span class="n">z_zero</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="p">,),</span> \
                                                            <span class="n">params_sim_r</span><span class="p">[</span><span class="s1">&#39;t_span&#39;</span><span class="p">],</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;pos_0&#39;</span><span class="p">],</span> \
                                                            <span class="n">t_eval</span><span class="o">=</span><span class="n">params_sim_r</span><span class="p">[</span><span class="s1">&#39;t_eval&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">y</span>
    <span class="c1"># ...by using the explicit solution if there is no baseline wander</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">,</span> <span class="n">z_int</span> <span class="o">=</span> <span class="n">Explicit_ECG</span><span class="p">(</span><span class="n">params_model_r</span><span class="p">,</span> <span class="n">params_sim_r</span><span class="p">,</span> <span class="n">omega_constant</span><span class="p">)</span>
    <span class="c1"># Trim signal by 1 x sf_int</span>
    <span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">,</span> <span class="n">z_int</span> <span class="o">=</span> <span class="n">trim_signal</span><span class="p">(</span><span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">,</span> <span class="n">z_int</span><span class="p">,</span> <span class="n">params_sim_r</span><span class="p">)</span>

    <span class="c1"># Downsample the signal if needed</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">get_downsampling_stepsize</span><span class="p">(</span><span class="n">params_sim</span><span class="p">)</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">downsample_if_needed</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x_int</span><span class="p">,</span> <span class="n">y_int</span><span class="p">,</span> <span class="n">z_int</span><span class="p">)</span>

    <span class="c1"># Rescale the signal to the interval [-0.4, 1.2]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">rescale_signal</span><span class="p">(</span><span class="n">z</span><span class="p">,</span><span class="o">-</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">1.2</span><span class="p">)</span>

    <span class="c1"># Add noise if necessary</span>
    <span class="k">if</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;noise_type&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">add_distortion</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;noise_amplitude&#39;</span><span class="p">],</span> <span class="n">noise_type</span><span class="o">=</span><span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;noise_type&#39;</span><span class="p">],</span> \
                          <span class="n">signal_sampling_rate</span><span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_int&#39;</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">)</span>

<span class="c1"># Plots a section from an ecg_signal whose sampling frequency is ecg_frequency.</span>
<span class="c1"># desired_range is a list of two indices which delimit the section of the signal to plot.</span>
<span class="k">def</span> <span class="nf">plot_ecg_segment</span><span class="p">(</span><span class="n">ecg_signal</span><span class="p">,</span> <span class="n">ecg_frequency</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">desired_range</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># If no desired_range is supplied, the entire signal is plotted.</span>
    <span class="k">if</span> <span class="n">desired_range</span><span class="o">==</span><span class="kc">None</span><span class="p">:</span>
        <span class="n">desired_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ecg_signal</span><span class="p">)]</span>

    <span class="n">y</span> <span class="o">=</span> <span class="n">ecg_signal</span><span class="p">[</span><span class="n">desired_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span><span class="n">desired_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">x_min</span> <span class="o">=</span> <span class="n">desired_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">ecg_frequency</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">desired_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">ecg_frequency</span>
    <span class="n">desired_length</span> <span class="o">=</span> <span class="n">desired_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">desired_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span><span class="n">x_max</span><span class="p">,</span><span class="n">desired_length</span><span class="p">)</span>
    <span class="n">fig_2d</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="n">ax_2d</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Time (s)&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency (Hz)&quot;</span><span class="p">)</span>
    <span class="n">ax_2d</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="math notranslate nohighlight">
\[X(t_i) = \mu(t_i,M,\alpha,\beta,\omega)+e(t_i)\]</div>
<p>for</p>
<div class="math notranslate nohighlight">
\[\mu(t,M,\alpha, \beta, \omega) = M + \sum_{J \in \{P,Q,R,S,T\}}A_J \cos\left(\beta_J+2\arctan\left(\omega_J \tan\left(\frac{t-\alpha_J}{2}\right)\right)\right)\]</div>
<p>with <span class="math notranslate nohighlight">\(M \in \mathbb{R}\)</span>, <span class="math notranslate nohighlight">\(A \in \mathbb{R}_{&gt;0}^{5}\)</span>, <span class="math notranslate nohighlight">\(\alpha, \beta \in [0,2\pi]^5\)</span>, <span class="math notranslate nohighlight">\(\alpha_P \leq \alpha_Q \leq \alpha_R \leq \alpha_S \leq \alpha_T\)</span> and <span class="math notranslate nohighlight">\(\omega \in [0,1]^5\)</span> as well as</p>
<div class="math notranslate nohighlight">
\[(e(t_i), ..., (e(t_n))' \sim N_n(0, \sigma^2I)\]</div>
<p>In order to model the same level of biological complexity as McSharry et al. 2003, we can replace the Gaussian mixing component of the latter model with the derivative of <span class="math notranslate nohighlight">\(\mu\)</span>, i.e.</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{cases}
\dot{x} = \alpha(x,y) x - \omega y\\
\dot{y} = \alpha(x,y) y + \omega x\\
\dot{z} = \mu'(x,y)-(z-z_0)
\end{cases}\end{split}\]</div>
<p>Also incorporating adaptable manipulation of time via a constant factor <span class="math notranslate nohighlight">\(c\)</span>, by the chain rule, the derivative in question is</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mu_c'(t, \alpha, \beta, \omega) = \frac{d}{dt} \sum_{J \in \{P,Q,R,S,T\}}A_J \cos\left(\beta_J+2\arctan\left(\omega_J \tan\left(\frac{ct-\alpha_J}{2}\right)\right)\right) \\
 =  -\sum_{J \in \{P,Q,R,S,T\}} A_J \sin\left(\beta_J+2\arctan\left(\omega_J \tan\left(\frac{ct-\alpha_J}{2}\right)\right)\right) \cdot \frac{1}{1+\omega_J^2 \tan^2\left(\frac{t-\alpha_J}{2}\right)} \cdot 2 \omega_J \left(1+\tan^2\left(\frac{t-\alpha_J}{2}\right)\right) \cdot \frac{c}{2} \\ = -c\sum_{J \in \{P,Q,R,S,T\}} \frac{A_J\omega_J \sin\left(\beta_J+2\arctan\left(\omega_J \tan\left(\frac{t-\alpha_J}{2}\right)\right)\right) \left(1+\tan^2\left(\frac{t-\alpha_J}{2}\right)\right)}{1+\omega_J^2 \tan^2\left(\frac{t-\alpha_J}{2}\right)}\end{split}\]</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># params_FMM = initialize_FMM()</span>
<span class="c1"># params_GM, params_sim = initialize_model_parameters()</span>
<span class="c1"># params_sim[&#39;duration&#39;] = 1</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#xdata_FMM, ydata_FMM, zdata_FMM = generate_ECG(params_FMM, params_sim, baseline_wander=True)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#plot_ecg_segment(zdata_FMM, params_sim[&#39;sf_ecg&#39;])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#xdata_GM, ydata_GM, zdata_GM = generate_ECG(params_GM, params_sim, baseline_wander=True)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#plot_ecg_segment(zdata_GM, params_sim[&#39;sf_ecg&#39;])</span>
</pre></div>
</div>
</div>
<p>Here is an example of what a signal generated with our model looks like:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#%timeit xdata, ydata, zdata = generate_ECG(params_ODE, params_sim, baseline_wander=True)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#%timeit xdata, ydata, zdata = generate_ECG(params_ODE, params_sim, baseline_wander=False)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#%timeit xdata, ydata, zdata = generate_ECG(params_model, params_sim, baseline_wander=False)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#params_sim[&#39;heartrate_mean&#39;] = 60</span>
<span class="c1">#params_sim[&#39;duration&#39;] = 10</span>
<span class="c1">#params_sim[&#39;noise_type&#39;] = &#39;Laplace&#39;</span>
<span class="n">xdata</span><span class="p">,</span> <span class="n">ydata</span><span class="p">,</span> <span class="n">zdata</span> <span class="o">=</span> <span class="n">generate_ECG</span><span class="p">(</span><span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="c1">#_, _, z_data = Explicit_ECG(params_ODE, params_sim, omega=2*np.pi, params_FMM=params_FMM)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#%matplotlib notebook</span>
<span class="n">plot_ecg_segment</span><span class="p">(</span><span class="n">zdata</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_ecg&#39;</span><span class="p">])</span>
<span class="c1">#plt.plot(z_data)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_27_0.png" src="../_images/tutorial_notebooks_ECG_Model_27_0.png" />
</div>
</div>
</section>
<section id="2:-Building-a-Generative-Model-from-the-Simulator">
<h1>2: Building a Generative Model from the Simulator<a class="headerlink" href="#2:-Building-a-Generative-Model-from-the-Simulator" title="Permalink to this heading"></a></h1>
<p>One of the ways in which BayesFlow can be used is to define a GenerativeModel, a custom class essentially created from two functions: one which generates parameters according to certain distributions (i.e. a prior), and one which generates simulated signals from those parameters (i.e. a simulator). Since our simulator is essentially the generate_ECG function above, the code below focuses primarily on parameter generation and on simulating on batches of parameters (as opposed to a single set of
parameters as above).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Internal utility functions for prior generation</span>

<span class="c1"># Retrieves the dimension of a parameter</span>
<span class="k">def</span> <span class="nf">get_param_dim</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">index_set</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">params_sim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">index_set</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">index_set</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">param_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;A_FMM&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha_FMM&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_FMM&#39;</span><span class="p">,</span> <span class="s1">&#39;omega_FMM&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="mi">5</span>
        <span class="k">elif</span> <span class="n">param_name</span> <span class="o">==</span> <span class="s1">&#39;pos_0&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">param_name</span> <span class="o">==</span> <span class="s1">&#39;t_span&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">param_name</span> <span class="o">==</span> <span class="s1">&#39;t_eval&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;t_eval&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>

<span class="c1"># Separates parameters related to the ODE system itself from those related to simulation,</span>
<span class="c1"># creating dictionaries with the parameter names as keys and lists of indexes (by default: all the indexes</span>
<span class="c1"># of the parameter in question) as values</span>
<span class="k">def</span> <span class="nf">split_param_list</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">i</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">get_param_dim</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>

    <span class="n">param_dict_sim</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">param_dict_model</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params_sim</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">param_dict_sim</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">param_dict_model</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

    <span class="k">return</span><span class="p">(</span><span class="n">param_dict_model</span><span class="p">,</span> <span class="n">param_dict_sim</span><span class="p">)</span>


<span class="c1"># Creates a dictionary containing all necessary information to vary the default parameters.</span>
<span class="c1"># Variation occurs via normal distributions with the (potentially multi-dimensional) mean</span>
<span class="c1"># and standard deviations provided (by default, entrywise independently) and applied to the default values,</span>
<span class="c1"># i.e. if the default is 5, mean=0 and standard_deviation = 0.2, then we draw a value x from a normal</span>
<span class="c1"># distribution with mean zero and standard deviation 0.2 and multiply that by 5, adding the result to 5.</span>
<span class="c1"># It is possible to truncate these distributions via trunc_low and trunc_high arguments.</span>
<span class="c1"># Values close to zero are replaced with 0.005.</span>
<span class="k">def</span> <span class="nf">make_variation_dict</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">indexes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">standard_deviation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">trunc_low</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> \
                        <span class="n">trunc_high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rejection_sampling</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">entrywise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> \
                        <span class="n">zero_threshold</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">zero_replacement</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">distribution</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">param_dim</span> <span class="o">=</span> <span class="n">get_param_dim</span><span class="p">(</span><span class="n">param_name</span><span class="p">,</span> <span class="n">indexes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">indexes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">param_dim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mean</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">param_dim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">standard_deviation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">standard_deviation</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">param_dim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trunc_low</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trunc_low</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">param_dim</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">trunc_high</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">trunc_high</span> <span class="o">=</span> <span class="n">zero_replacement</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">param_dim</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;indexes&#39;</span><span class="p">:</span> <span class="n">indexes</span><span class="p">,</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mean</span><span class="p">),</span> \
            <span class="s1">&#39;standard_deviation&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">standard_deviation</span><span class="p">),</span> \
            <span class="s1">&#39;trunc_low&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">trunc_low</span><span class="p">),</span> <span class="s1">&#39;trunc_high&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">trunc_high</span><span class="p">),</span> \
            <span class="s1">&#39;rejection_sampling&#39;</span><span class="p">:</span> <span class="n">rejection_sampling</span><span class="p">,</span> <span class="s1">&#39;entrywise&#39;</span><span class="p">:</span> <span class="n">entrywise</span><span class="p">,</span> \
            <span class="s1">&#39;zero_threshold&#39;</span><span class="p">:</span> <span class="n">zero_threshold</span><span class="p">,</span> <span class="s1">&#39;zero_replacement&#39;</span><span class="p">:</span> <span class="n">zero_replacement</span><span class="p">,</span> \
            <span class="s1">&#39;distribution&#39;</span><span class="p">:</span> <span class="n">distribution</span><span class="p">}</span>

<span class="c1">#     if hasattr(mean, &quot;__len__&quot;):</span>
<span class="c1">#         return {&#39;indexes&#39;: indexes, &#39;mean&#39;: np.asarray(mean), \</span>
<span class="c1">#                 &#39;standard_deviation&#39;: np.asarray(standard_deviation), \</span>
<span class="c1">#                 &#39;trunc_low&#39;: np.asarray(trunc_low), &#39;trunc_high&#39;: np.asarray(trunc_high), \</span>
<span class="c1">#                 &#39;rejection_sampling&#39;: rejection_sampling, &#39;entrywise&#39;: entrywise, \</span>
<span class="c1">#                 &#39;zero_threshold&#39;: zero_threshold, &#39;zero_replacement&#39;: zero_replacement, \</span>
<span class="c1">#                 &#39;distribution&#39;: distribution}</span>
<span class="c1">#     else:</span>
<span class="c1">#         return {&#39;indexes&#39;: indexes, &#39;mean&#39;: mean, &#39;standard_deviation&#39;: standard_deviation,\</span>
<span class="c1">#                 &#39;trunc_low&#39;: trunc_low, &#39;trunc_high&#39;: trunc_high, &#39;rejection_sampling&#39;: rejection_sampling,\</span>
<span class="c1">#                 &#39;entrywise&#39;: entrywise, &#39;zero_threshold&#39;: zero_threshold,\</span>
<span class="c1">#                 &#39;zero_replacement&#39;: zero_replacement, &#39;distribution&#39;: distribution}</span>


<span class="c1">## Prior generation</span>

<span class="k">def</span> <span class="nf">generate_single_param_prior_nondefault</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="n">variation_dict</span><span class="p">,</span> <span class="n">hr_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="s1">&#39;heartrate_mean&#39;</span><span class="p">:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="mi">205</span>
        <span class="k">while</span> <span class="n">output_p</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="mi">40</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="n">output_p</span><span class="p">])</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">get_param_dim</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">])</span>

    <span class="n">distribution</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span>
    <span class="n">deviation_mean</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
    <span class="n">deviation_std</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;standard_deviation&#39;</span><span class="p">]</span>
    <span class="n">trunc_low</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;trunc_low&#39;</span><span class="p">]</span>
    <span class="n">trunc_high</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;trunc_high&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trunc_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">trunc_low</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">output_p</span> <span class="o">&lt;</span> <span class="n">trunc_low</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">output_p</span> <span class="o">&gt;</span> <span class="n">trunc_high</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">deviation_mean</span><span class="p">,</span> <span class="n">deviation_std</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">deviation_mean</span><span class="p">,</span> <span class="n">deviation_std</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trunc_low</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Must supply a lower and upper bound (trunc_low and trunc_high) when sampling from </span><span class="se">\</span>
<span class="s2">                  uniform distribution.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">trunc_low</span><span class="p">,</span> <span class="n">trunc_high</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2"> is not a known distribution. Choose between normal and uniform.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">]:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span>

    <span class="c1"># Ensure that the output is an array of arrays (as opposed to an array of floats)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">output_p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output_p</span><span class="p">))])</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output_p</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">generate_single_param_prior_nondefault_batch</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">variation_dict</span><span class="p">,</span> <span class="n">hr_factors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="s1">&#39;heartrate_mean&#39;</span><span class="p">:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span><span class="o">+</span><span class="mi">40</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">40</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">output_p</span><span class="p">[:</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">get_param_dim</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">])</span>

    <span class="n">distribution</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span>
    <span class="n">deviation_mean</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
    <span class="n">deviation_std</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;standard_deviation&#39;</span><span class="p">]</span>
    <span class="n">trunc_low</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;trunc_low&#39;</span><span class="p">]</span>
    <span class="n">trunc_high</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;trunc_high&#39;</span><span class="p">]</span>


    <span class="k">if</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;normal&#39;</span><span class="p">:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">deviation_mean</span><span class="p">,</span> <span class="n">deviation_std</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">trunc_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                    <span class="n">output_row</span> <span class="o">=</span> <span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
                    <span class="k">while</span> <span class="p">(</span><span class="n">output_row</span> <span class="o">&lt;</span> <span class="n">trunc_low</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="p">(</span><span class="n">output_row</span> <span class="o">&gt;</span> <span class="n">trunc_high</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">deviation_mean</span><span class="p">,</span> <span class="n">deviation_std</span><span class="p">)</span>
                        <span class="n">output_row</span> <span class="o">=</span> <span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span>
    <span class="k">elif</span> <span class="n">distribution</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">trunc_low</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Must supply a lower and upper bound (trunc_low and trunc_high) when sampling from </span><span class="se">\</span>
<span class="s2">                  uniform distribution.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">trunc_low</span><span class="p">,</span> <span class="n">trunc_high</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">distribution</span><span class="si">}</span><span class="s2"> is not a known distribution. Choose between normal and uniform.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>

    <span class="c1"># Ensure that the output is an array of arrays (as opposed to an array of floats)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">output_p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output_p</span><span class="p">))])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span>


<span class="c1"># Draws from the prior distribution of a single parameter (scalar or vector)</span>
<span class="c1"># The distribution in question is either</span>
<span class="c1"># 1) a family of independent normal distributions centered around the default value of</span>
<span class="c1"># each of the parameter&#39;s entries with a standard deviation 0.05 if entrywise is True, or</span>
<span class="c1"># 2) induced by muliplying the parameter with a random number with mean 0 and std 0.05 and adding</span>
<span class="c1"># the result to the original parameter (i.e. varying each entry by the same percentage between -5% and +5%)</span>
<span class="c1"># Approach 1) is the default, since approach 2) creates a degenerate prior which renders learning impossible.</span>
<span class="c1"># Approach 2) is only shown here to exemplify a potential caveat for priors used with BayesFlow, see below.</span>
<span class="k">def</span> <span class="nf">generate_single_param_prior</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">variation_dict</span><span class="p">,</span> <span class="n">hr_factor</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="c1"># The mean heartrate is varied according to a log normal distribution shifted right by 40</span>
    <span class="c1"># and truncated at 200</span>
    <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="s1">&#39;heartrate_mean&#39;</span><span class="p">:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="mi">205</span>
        <span class="k">while</span> <span class="n">output_p</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">20</span> <span class="o">+</span> <span class="mi">40</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>

    <span class="c1"># Differentiate between one-dimensional and multi-dimensional parameters</span>
    <span class="c1"># and replace values close (or identical) to zero with a small number (the variable zero_replacement)</span>
    <span class="n">zero_replaced</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">zero_threshold</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;zero_threshold&#39;</span><span class="p">]</span>
    <span class="n">zero_replacement</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;zero_replacement&#39;</span><span class="p">]</span>
    <span class="n">deviation_mean</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
        <span class="n">parameter_backup</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">]]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
        <span class="n">zero_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">zero_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero_indexes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">parameter</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">zero_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_replacement</span>
            <span class="n">zero_replaced</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">zero_threshold</span><span class="p">:</span>
            <span class="n">parameter</span> <span class="o">=</span> <span class="n">zero_replacement</span>
            <span class="n">deviation_mean</span> <span class="o">-=</span> <span class="n">zero_replacement</span>

    <span class="n">entrywise</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;entrywise&#39;</span><span class="p">]</span>
    <span class="n">deviation_std</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;standard_deviation&#39;</span><span class="p">]</span>
    <span class="n">trunc_low</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;trunc_low&#39;</span><span class="p">]</span>
    <span class="n">trunc_high</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;trunc_high&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">entrywise</span><span class="p">:</span>
        <span class="n">variation_coefficient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">deviation_mean</span><span class="p">,</span> <span class="n">deviation_std</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trunc_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Rejecting and re-rolling samples with the intended standard deviation (0.66)</span>
            <span class="c1"># and bounds (-1 and 0) slows prior generation down immensely.</span>
            <span class="c1"># As such, re-rolling was replaced by deterministic alterations: values that are too high</span>
            <span class="c1"># have their sign switched, and values that are too low are raised to the lower</span>
            <span class="c1"># truncation bound. The former change essentially mirrors the right half of the normal</span>
            <span class="c1"># distribution onto the left, whereas the latter change increases the probability of the</span>
            <span class="c1"># lower bound. In practice, this is acceptable.</span>
            <span class="n">variation_coefficient</span><span class="p">[</span><span class="n">variation_coefficient</span> <span class="o">&gt;</span> <span class="n">trunc_high</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
            <span class="n">low_indexes</span> <span class="o">=</span> <span class="p">(</span><span class="n">variation_coefficient</span> <span class="o">&lt;</span> <span class="n">trunc_low</span><span class="p">)</span>
            <span class="n">variation_coefficient</span><span class="p">[</span><span class="n">low_indexes</span><span class="p">]</span> <span class="o">=</span> <span class="n">trunc_low</span><span class="p">[</span><span class="n">low_indexes</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">variation_coefficient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">deviation_mean</span><span class="p">,</span> <span class="n">deviation_std</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trunc_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">variation_coefficient</span> <span class="o">&lt;</span> <span class="n">trunc_low</span> <span class="ow">or</span> <span class="n">variation_coefficient</span> <span class="o">&gt;</span> <span class="n">trunc_high</span><span class="p">:</span>
                <span class="n">variation_coefficient</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">deviation_mean</span><span class="p">,</span> <span class="n">deviation_std</span><span class="p">)</span>

    <span class="n">output_p</span> <span class="o">=</span> <span class="n">parameter</span> <span class="o">+</span> <span class="n">parameter</span><span class="o">*</span><span class="n">variation_coefficient</span>

    <span class="k">if</span> <span class="n">zero_replaced</span><span class="p">:</span>
        <span class="n">output_p</span><span class="p">[</span><span class="n">zero_indexes</span><span class="p">]</span> <span class="o">-=</span> <span class="n">zero_replacement</span>

    <span class="c1"># Reject prior samples that are blatantly physiologically impossible:</span>
    <span class="c1"># This includes samples in which the PQRST peaks are not an alternating series of local</span>
    <span class="c1"># maxima and minima (in that order) and those in which the R peak is not the most pronounced peak</span>
    <span class="k">if</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;rejection_sampling&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="n">correct_signs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
            <span class="n">scaled_out</span> <span class="o">=</span> <span class="p">[</span><span class="n">hr_factor</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">hr_factor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">hr_factor</span><span class="p">,</span> <span class="n">hr_factor</span><span class="o">**</span><span class="mf">0.5</span><span class="p">]</span><span class="o">*</span><span class="n">output_p</span>
            <span class="n">max_non_R</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">scaled_out</span><span class="p">[:</span><span class="mi">2</span><span class="p">])),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">scaled_out</span><span class="p">[</span><span class="mi">3</span><span class="p">:])))</span>
            <span class="n">sign_misalignment</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span> <span class="o">!=</span> <span class="n">correct_signs</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">sign_misalignment</span> <span class="ow">or</span> <span class="n">max_non_R</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">output_p</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                   <span class="n">output_p</span> <span class="o">=</span> <span class="n">parameter</span>

    <span class="c1"># It also includes samples in which the PQRST waves do not appear in order.</span>
    <span class="c1"># The latter cannot be opted out of, since the results would not simply be medically absurd,</span>
    <span class="c1"># but also (and perhaps more importantly) uninterpretable.</span>
    <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">]:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span>
        <span class="n">finished_parameter</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">parameter_backup</span><span class="p">)</span>
        <span class="n">finished_parameter</span><span class="p">[</span><span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">finished_parameter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">finished_parameter</span><span class="p">:</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">parameter_backup</span><span class="p">[</span><span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">]]</span>

    <span class="c1"># Ensure that the output is an array (as opposed to a float)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">output_p</span><span class="p">])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span>


<span class="c1"># Batched version of the above function</span>
<span class="k">def</span> <span class="nf">generate_single_param_prior_batch</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">variation_dict</span><span class="p">,</span> <span class="n">hr_factors</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="s1">&#39;heartrate_mean&#39;</span><span class="p">:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span><span class="o">+</span><span class="mi">40</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="k">while</span> <span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">s</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mi">40</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">output_p</span><span class="p">[:</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
        <span class="k">return</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;indexes&#39;</span><span class="p">]</span>

    <span class="n">zero_replaced</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">zero_threshold</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;zero_threshold&#39;</span><span class="p">]</span>
    <span class="n">zero_replacement</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;zero_replacement&#39;</span><span class="p">]</span>
    <span class="n">deviation_mean</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
        <span class="n">parameter</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
        <span class="n">zero_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">zero_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero_indices</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">parameter</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">zero_threshold</span><span class="p">]</span> <span class="o">=</span> <span class="n">zero_replacement</span>
            <span class="n">zero_replaced</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">zero_threshold</span><span class="p">:</span>
            <span class="n">parameter</span> <span class="o">=</span> <span class="n">zero_replacement</span>
            <span class="n">deviation_mean</span> <span class="o">-=</span> <span class="n">zero_replacement</span>

    <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">entrywise</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;entrywise&#39;</span><span class="p">]</span>
    <span class="n">deviation_std</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;standard_deviation&#39;</span><span class="p">]</span>
    <span class="n">trunc_low</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;trunc_low&#39;</span><span class="p">]</span>
    <span class="n">trunc_high</span> <span class="o">=</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;trunc_high&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">entrywise</span><span class="p">:</span>
        <span class="n">variation_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">deviation_mean</span><span class="p">,</span> <span class="n">deviation_std</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">trunc_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="n">coefficient_row</span> <span class="o">=</span> <span class="n">variation_coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">coefficient_row</span><span class="p">[</span><span class="n">coefficient_row</span> <span class="o">&gt;</span> <span class="n">trunc_high</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mf">1.0</span>
                <span class="n">low_indexes</span> <span class="o">=</span> <span class="p">(</span><span class="n">coefficient_row</span> <span class="o">&lt;</span> <span class="n">trunc_low</span><span class="p">)</span>
                <span class="n">coefficient_row</span><span class="p">[</span><span class="n">low_indexes</span><span class="p">]</span> <span class="o">=</span> <span class="n">trunc_low</span><span class="p">[</span><span class="n">low_indexes</span><span class="p">]</span>
                <span class="n">variation_coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">coefficient_row</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">output_p</span> <span class="o">+</span> <span class="n">output_p</span><span class="o">*</span><span class="n">variation_coefficients</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">variation_coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">deviation_mean</span><span class="p">,</span> <span class="n">deviation_std</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">trunc_low</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="n">coefficient</span> <span class="o">=</span> <span class="n">variation_coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">while</span> <span class="n">coefficient</span> <span class="o">&lt;</span> <span class="n">trunc_low</span> <span class="ow">or</span> <span class="n">coefficient</span> <span class="o">&gt;</span> <span class="n">trunc_high</span><span class="p">:</span>
                    <span class="n">variation_coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">deviation_mean</span><span class="p">,</span> <span class="n">deviation_std</span><span class="p">)</span>
                    <span class="n">coefficient_row</span> <span class="o">=</span> <span class="n">variation_coefficients</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">output_p</span> <span class="o">+</span> <span class="n">output_p</span><span class="o">*</span><span class="n">variation_coefficients</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">zero_replaced</span><span class="p">:</span>
        <span class="n">M</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">zero_indices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">):</span>
            <span class="n">ind_tuple</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">batch_size</span><span class="p">),</span> <span class="n">zero_indices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">))</span>
            <span class="n">output_p</span><span class="p">[</span><span class="n">ind_tuple</span><span class="p">]</span> <span class="o">-=</span> <span class="n">zero_replacement</span>

    <span class="k">if</span> <span class="n">variation_dict</span><span class="p">[</span><span class="s1">&#39;rejection_sampling&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="s1">&#39;a&#39;</span><span class="p">:</span>
            <span class="n">correct_signs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">parameter</span><span class="p">)</span>
            <span class="n">scaling_1</span> <span class="o">=</span> <span class="n">hr_factors</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="n">scaling_2</span> <span class="o">=</span> <span class="n">hr_factors</span>
            <span class="n">scaling_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hr_factors</span><span class="p">))</span>
            <span class="n">scaling_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">scaling_1</span><span class="p">,</span> <span class="n">scaling_2</span><span class="p">,</span> <span class="n">scaling_3</span><span class="p">,</span> <span class="n">scaling_2</span><span class="p">,</span> <span class="n">scaling_1</span><span class="p">))</span>
            <span class="n">scaled_out</span> <span class="o">=</span> <span class="n">scaling_factor</span><span class="o">*</span><span class="n">output_p</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
                <span class="n">max_non_R</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">scaled_out</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="mi">2</span><span class="p">])),</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">scaled_out</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">:])))</span>
                <span class="n">sign_misalignment</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span> <span class="o">!=</span> <span class="n">correct_signs</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sign_misalignment</span> <span class="ow">or</span> <span class="n">max_non_R</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">parameter</span>

    <span class="k">if</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">]:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">batch_size</span><span class="p">):</span>
            <span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>

    <span class="c1"># Ensure that the output is an array of arrays (as opposed to an array of floats)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">output_p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">output_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([[</span><span class="n">output_p</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">output_p</span><span class="p">))])</span>

    <span class="k">return</span><span class="p">(</span><span class="n">output_p</span><span class="p">)</span>

<span class="c1"># Generates a concatenation of prior draws for all parameters being varied</span>
<span class="k">def</span> <span class="nf">generate_ecg_parameter_prior</span><span class="p">(</span><span class="n">params_model</span><span class="p">,</span> <span class="n">model_params_to_vary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> \
                                 <span class="n">params_sim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sim_params_to_vary</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">model_params_to_vary</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sim_params_to_vary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;alpha_FMM&#39;</span> <span class="ow">in</span> <span class="n">params_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">model_params_to_vary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A_FMM&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;A_FMM&#39;</span><span class="p">),</span>\
                                    <span class="s1">&#39;alpha_FMM&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;alpha_FMM&#39;</span><span class="p">),</span> \
                                    <span class="s1">&#39;beta_FMM&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;beta_FMM&#39;</span><span class="p">),</span>\
                                    <span class="s1">&#39;omega_FMM&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;omega_FMM&#39;</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_params_to_vary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span>\
                                    <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">make_varation_dict</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">)}</span>
        <span class="n">sim_params_to_vary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;heartrate_mean&#39;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">sim_parameter_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sim_params_to_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">model_parameter_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_params_to_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">sim_output_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model_output_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">hr_mean</span> <span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;heartrate_mean&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">hr_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hr_mean</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
            <span class="n">hr_mean</span> <span class="o">=</span> <span class="n">hr_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hr_factor</span><span class="o">=</span> <span class="p">(</span><span class="n">hr_mean</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hr_factor</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">sim_parameter_names</span><span class="p">:</span>
        <span class="n">dist_is_None</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;distribution&#39;</span> <span class="ow">in</span> <span class="n">sim_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dist_is_None</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dist_is_None</span><span class="p">:</span>
            <span class="n">original_p</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_sim</span><span class="p">[</span><span class="n">p_name</span><span class="p">])</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">generate_single_param_prior</span><span class="p">(</span><span class="n">original_p</span><span class="p">,</span> <span class="n">p_name</span><span class="p">,</span> \
                                                   <span class="n">variation_dict</span> <span class="o">=</span> <span class="n">sim_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">generate_single_param_prior_nondefault</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> \
                                                              <span class="n">variation_dict</span> <span class="o">=</span> <span class="n">sim_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">])</span>

        <span class="n">sim_output_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">output_p</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="s1">&#39;heartrate_mean&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">output_p</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
                <span class="n">hr_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hr_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_p</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">model_parameter_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">original_p</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_model</span><span class="p">[</span><span class="n">p_name</span><span class="p">])</span>
                <span class="n">output_p</span> <span class="o">=</span> <span class="n">generate_single_param_prior</span><span class="p">(</span><span class="n">original_p</span><span class="p">,</span> <span class="n">p_name</span><span class="p">,</span> \
                                                       <span class="n">variation_dict</span><span class="o">=</span><span class="n">model_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">],</span> \
                                                       <span class="n">hr_factor</span><span class="o">=</span><span class="n">hr_factor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">generate_single_param_prior_nondefault</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> \
                                                   <span class="n">variation_dict</span><span class="o">=</span><span class="n">model_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">],</span> \
                                                   <span class="n">hr_factor</span><span class="o">=</span><span class="n">hr_factor</span><span class="p">)</span>
        <span class="n">model_output_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">output_p</span><span class="p">]</span>

    <span class="n">output_list</span> <span class="o">=</span> <span class="n">model_output_list</span> <span class="o">+</span> <span class="n">sim_output_list</span>
    <span class="n">output_array</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">output_list</span><span class="p">)</span>

    <span class="c1">#print(f&quot;Prior generated for {parameter_list}&quot;)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">output_array</span><span class="p">)</span>

<span class="c1"># Batched version of the above function</span>
<span class="k">def</span> <span class="nf">generate_ecg_parameter_prior_batch</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">params_model</span><span class="p">,</span> <span class="n">model_params_to_vary</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> \
                                       <span class="n">params_sim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sim_params_to_vary</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">model_params_to_vary</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sim_params_to_vary</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;alpha_FMM&#39;</span> <span class="ow">in</span> <span class="n">params_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">model_params_to_vary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A_FMM&#39;</span><span class="p">:</span> <span class="n">make_variaction_dict</span><span class="p">(</span><span class="s1">&#39;A_FMM&#39;</span><span class="p">),</span>\
                                    <span class="s1">&#39;alpha_FMM&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;alpha_FMM&#39;</span><span class="p">),</span> \
                                    <span class="s1">&#39;beta_FMM&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;beta_FMM&#39;</span><span class="p">),</span>\
                                    <span class="s1">&#39;omega_FMM&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;omega_FMM&#39;</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_params_to_vary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">),</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">),</span>\
                                    <span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">make_varation_dict</span><span class="p">(</span><span class="s1">&#39;theta&#39;</span><span class="p">)}</span>
        <span class="n">sim_params_to_vary</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;heartrate_mean&#39;</span><span class="p">:</span> <span class="p">{}}</span>

    <span class="n">sim_parameter_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sim_params_to_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">model_parameter_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model_params_to_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">sim_output_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">model_output_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">hr_mean</span> <span class="o">=</span> <span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;heartrate_mean&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">hr_mean</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hr_mean</span><span class="p">,</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
            <span class="n">hr_mean</span> <span class="o">=</span> <span class="n">hr_mean</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">hr_fact</span><span class="o">=</span> <span class="p">(</span><span class="n">hr_mean</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">hr_factors</span> <span class="o">=</span> <span class="n">hr_fact</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hr_fact</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">hr_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">batch_size</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">sim_parameter_names</span><span class="p">:</span>
        <span class="n">dist_is_None</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;distribution&#39;</span> <span class="ow">in</span> <span class="n">sim_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">dist_is_None</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dist_is_None</span><span class="p">:</span>
            <span class="n">original_p</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_sim</span><span class="p">[</span><span class="n">p_name</span><span class="p">])</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">generate_single_param_prior_batch</span><span class="p">(</span><span class="n">original_p</span><span class="p">,</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> \
                                                     <span class="n">variation_dict</span> <span class="o">=</span> <span class="n">sim_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">generate_single_param_prior_nondefault_batch</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> \
                                                     <span class="n">variation_dict</span> <span class="o">=</span> <span class="n">sim_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">])</span>
        <span class="n">sim_output_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">output_p</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">p_name</span> <span class="o">==</span> <span class="s1">&#39;heartrate_mean&#39;</span><span class="p">:</span>
            <span class="n">hr_factors</span> <span class="o">=</span> <span class="p">(</span><span class="n">output_p</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">model_parameter_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;distribution&#39;</span> <span class="ow">in</span> <span class="n">model_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> \
        <span class="ow">and</span> <span class="n">model_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">original_p</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_model</span><span class="p">[</span><span class="n">p_name</span><span class="p">])</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">generate_single_param_prior_batch</span><span class="p">(</span><span class="n">original_p</span><span class="p">,</span> <span class="n">p_name</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> \
                                                         <span class="n">hr_factors</span><span class="o">=</span><span class="n">hr_factors</span><span class="p">,</span> \
                                                         <span class="n">variation_dict</span> <span class="o">=</span> <span class="n">model_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_p</span> <span class="o">=</span> <span class="n">generate_single_param_prior_nondefault_batch</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">hr_factors</span><span class="o">=</span><span class="n">hr_factors</span><span class="p">,</span> \
                                                         <span class="n">variation_dict</span> <span class="o">=</span> <span class="n">model_params_to_vary</span><span class="p">[</span><span class="n">p_name</span><span class="p">])</span>
        <span class="n">model_output_list</span> <span class="o">+=</span> <span class="p">[</span><span class="n">output_p</span><span class="p">]</span>

    <span class="c1">#print(f&quot;Prior batch of size {batch_size} generated for {parameter_list}&quot;)</span>

    <span class="n">output_list</span> <span class="o">=</span> <span class="n">model_output_list</span> <span class="o">+</span> <span class="n">sim_output_list</span>

    <span class="k">return</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">output_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Simulates data from a single prior sample</span>
<span class="k">def</span> <span class="nf">simulate_one</span><span class="p">(</span><span class="n">prior_sample</span><span class="p">,</span> <span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">,</span> <span class="n">param_list</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">param_list_model</span><span class="p">,</span> <span class="n">param_list_sim</span> <span class="o">=</span> <span class="n">split_param_list</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">)</span>

    <span class="n">output_model</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">param_list_model</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
            <span class="n">next_index</span> <span class="o">=</span> <span class="n">current_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_list_model</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_index</span> <span class="o">=</span> <span class="n">current_index</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">output_model</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="p">[</span><span class="n">current_index</span><span class="p">:</span><span class="n">next_index</span><span class="p">]</span>
        <span class="n">current_index</span> <span class="o">=</span> <span class="n">next_index</span>

    <span class="k">if</span> <span class="n">param_list_sim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sim_param_change</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">output_sim</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">param_list_sim</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">param_list_sim</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
                <span class="n">next_index</span> <span class="o">=</span> <span class="n">current_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_list_sim</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
                <span class="n">output_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="p">[</span><span class="n">current_index</span><span class="p">:</span><span class="n">next_index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="p">[</span><span class="n">current_index</span><span class="p">]</span>
            <span class="n">current_index</span> <span class="o">=</span> <span class="n">next_index</span>

    <span class="n">current_params_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_model</span><span class="p">)</span>
    <span class="n">current_params_sim</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_sim</span><span class="p">)</span>


    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">get_param_dim</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">current_params_model</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">param_list_model</span><span class="p">[</span><span class="n">p</span><span class="p">]]</span> <span class="o">=</span> <span class="n">output_model</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_params_model</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_model</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">sim_param_change</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">param_list_sim</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">current_params_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">current_params_sim</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="n">param_list_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]]</span> <span class="o">=</span> <span class="n">output_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_params_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">generate_ECG</span><span class="p">(</span><span class="n">current_params_model</span><span class="p">,</span> <span class="n">current_params_sim</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="n">baseline_wander</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">z</span>



<span class="c1"># Batched version of the above function</span>
<span class="k">def</span> <span class="nf">simulate_batch</span><span class="p">(</span><span class="n">prior_sample</span><span class="p">,</span> <span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">,</span> <span class="n">param_list</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

    <span class="n">param_list_model</span><span class="p">,</span> <span class="n">param_list_sim</span> <span class="o">=</span> <span class="n">split_param_list</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">)</span>

    <span class="n">output_model</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">param_list_model</span><span class="p">[</span><span class="n">p</span><span class="p">],</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
            <span class="n">next_index</span> <span class="o">=</span> <span class="n">current_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_list_model</span><span class="p">[</span><span class="n">p</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_index</span> <span class="o">=</span> <span class="n">current_index</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">output_model</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="p">[:,</span><span class="n">current_index</span><span class="p">:</span><span class="n">next_index</span><span class="p">]</span>
        <span class="n">current_index</span> <span class="o">=</span> <span class="n">next_index</span>

    <span class="k">if</span> <span class="n">param_list_sim</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sim_param_change</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">output_sim</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">param_list_sim</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">param_list_sim</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="s2">&quot;__len__&quot;</span><span class="p">):</span>
                <span class="n">next_index</span> <span class="o">=</span> <span class="n">current_index</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_list_sim</span><span class="p">[</span><span class="n">q</span><span class="p">])</span>
                <span class="n">output_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="p">[:,</span><span class="n">current_index</span><span class="p">:</span><span class="n">next_index</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">output_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="p">[:,</span><span class="n">current_index</span><span class="p">]</span>
            <span class="n">current_index</span> <span class="o">=</span> <span class="n">next_index</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">output_sim</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">current_params_model</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_model</span><span class="p">)</span>
    <span class="n">current_params_sim</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params_sim</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="n">prior_sample</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1">#     if len(param_list_model) &gt; 0:</span>
<span class="c1">#         n = output_model[param_list_model[0]].shape[0]</span>
<span class="c1">#     else:</span>
<span class="c1">#         n = output_sim[param_list_sim[0]].shape[0]</span>

    <span class="n">batch</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">get_param_dim</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">current_params_model</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">param_list_model</span><span class="p">[</span><span class="n">p</span><span class="p">]]</span> <span class="o">=</span> <span class="n">output_model</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_params_model</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_model</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">sim_param_change</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">param_list_sim</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">current_params_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">get_param_dim</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">current_params_sim</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="n">param_list_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]]</span> <span class="o">=</span> <span class="n">output_sim</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">current_params_sim</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">output_sim</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">generate_ECG</span><span class="p">(</span><span class="n">current_params_model</span><span class="p">,</span> <span class="n">current_params_sim</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="n">baseline_wander</span><span class="p">)</span>
        <span class="n">batch</span> <span class="o">+=</span> <span class="p">[</span><span class="n">z</span><span class="p">]</span>

    <span class="n">batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">batch</span>

<span class="c1"># def simulate_multiple_batches(prior_samples, no_cores, params_ODE, params_sim, param_list, parallel=False):</span>
<span class="c1">#     if parallel:</span>
<span class="c1">#         pool = mp.Pool(no_cores)</span>
<span class="c1">#         batch_list = [pool.apply(simulate_batch, args=(prior_samples[i], params_ODE, params_sim, param_list, False)) for i in range(no_cores)]</span>
<span class="c1">#         pool.close()</span>
<span class="c1">#     else:</span>
<span class="c1">#         batch_list = [simulate_batch(prior_samples[i], params_ODE, params_sim, param_list, False) for i in range(no_cores)]</span>
<span class="c1">#     return(batch_list)</span>
<br/><br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># single_pr = generate_ecg_parameter_prior_batch(batch_size=10, params_model=params_model, model_params_to_vary=model_params_to_vary, \</span>
<span class="c1">#                                  params_sim=params_sim, sim_params_to_vary=sim_params_to_vary)</span>
<span class="c1"># single_pr[:,10]</span>
<span class="c1"># single_sm = simulate_batch(single_pr, params_model=params_model, params_sim=params_sim,\</span>
<span class="c1">#                          param_list=param_list, baseline_wander=False)</span>
</pre></div>
</div>
</div>
<p>The above implementation can in principle be used to define and draw from priors for any of the model parameters initialized with initialize_model_parameters(). However, not all choices make sense.</p>
<p>Certain parameters depend on each other (e.g. specifying duration and the internal sampling frequency sf_int specify the total number of time steps Nt), and certain others can be assumed to be constant for the time frames under consideration (e.g. <span class="math notranslate nohighlight">\(f_2\)</span>).</p>
<p>The most obvious candidates for parameters to predict, then, are those characterizing the IVP, i.e. <span class="math notranslate nohighlight">\(a, b\)</span> and <span class="math notranslate nohighlight">\(\theta\)</span>, along with the simulation parameter with the greatest impact on the signal, the mean heartrate. Counted entrywise, this amounts to 16 parameters whose distribution we want BayesFlow to learn:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># deviation_mean=np.zeros(5)</span>
<span class="c1"># deviation_std = 0.66*np.ones(5)</span>
<span class="c1"># trunc_high = 0.005*np.ones(5)</span>
<span class="c1"># trunc_low = -np.ones(5)</span>
<span class="c1"># batch_size = 64</span>
<span class="c1"># n = 5</span>
<span class="c1"># variation_coefficients = np.random.normal(deviation_mean, deviation_std, (batch_size, n))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_params_to_vary</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model_par_list</span><span class="p">:</span>
    <span class="n">param_dim</span> <span class="o">=</span> <span class="n">get_param_dim</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">mean_p</span> <span class="o">=</span> <span class="n">variation_mean</span><span class="p">[:</span><span class="n">param_dim</span><span class="p">]</span>
    <span class="n">std_p</span> <span class="o">=</span> <span class="n">stdn</span><span class="p">[:</span><span class="n">param_dim</span><span class="p">]</span>
    <span class="n">trunc_low_p</span> <span class="o">=</span> <span class="n">trunc_low</span><span class="p">[:</span><span class="n">param_dim</span><span class="p">]</span>
    <span class="n">trunc_high_p</span> <span class="o">=</span> <span class="n">trunc_high</span><span class="p">[:</span><span class="n">param_dim</span><span class="p">]</span>
    <span class="n">model_params_to_vary</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mean_p</span><span class="p">,</span> <span class="n">standard_deviation</span><span class="o">=</span><span class="n">std_p</span><span class="p">,</span>\
                                                  <span class="n">trunc_low</span><span class="o">=</span><span class="n">trunc_low_p</span><span class="p">,</span> <span class="n">trunc_high</span><span class="o">=</span><span class="n">trunc_high_p</span><span class="p">,</span> <span class="n">entrywise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="s1">&#39;beta_FMM&#39;</span> <span class="ow">in</span> <span class="n">model_params_to_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">model_params_to_vary</span><span class="p">[</span><span class="s1">&#39;beta_FMM&#39;</span><span class="p">][</span><span class="s1">&#39;indexes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="n">model_params_to_vary</span><span class="p">[</span><span class="s1">&#39;beta_FMM&#39;</span><span class="p">][</span><span class="s1">&#39;mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1">#model_params_to_vary[&#39;beta_FMM&#39;][&#39;standard_deviation&#39;] = 0.66</span>
        <span class="n">model_params_to_vary</span><span class="p">[</span><span class="s1">&#39;beta_FMM&#39;</span><span class="p">][</span><span class="s1">&#39;trunc_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">model_params_to_vary</span><span class="p">[</span><span class="s1">&#39;beta_FMM&#39;</span><span class="p">][</span><span class="s1">&#39;trunc_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">model_params_to_vary</span><span class="p">[</span><span class="s1">&#39;beta_FMM&#39;</span><span class="p">][</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;uniform&#39;</span>

<span class="c1"># if &#39;M_FMM&#39; in model_params_to_vary.keys():</span>
<span class="c1">#     model_params_to_vary[&#39;M_FMM&#39;][&#39;trunc_high&#39;] = 5</span>
<span class="c1">#     model_params_to_vary[&#39;M_FMM&#39;][&#39;trunc_low&#39;] = 0</span>
<span class="c1">#     model_params_to_vary[&#39;M_FMM&#39;][&#39;distribution&#39;] = &#39;uniform&#39;</span>

<span class="c1"># if &#39;alpha_FMM&#39; in model_params_to_vary.keys():</span>
<span class="c1">#     model_params_to_vary[&#39;alpha_FMM&#39;][&#39;mean&#39;] = copy.deepcopy(params_model[&#39;alpha_FMM&#39;])</span>
<span class="c1">#     model_params_to_vary[&#39;alpha_FMM&#39;][&#39;standard_deviation&#39;] = 0.75*np.pi*np.ones(5)</span>
<span class="c1">#     model_params_to_vary[&#39;alpha_FMM&#39;][&#39;trunc_low&#39;] = np.zeros(5)</span>
<span class="c1">#     model_params_to_vary[&#39;alpha_FMM&#39;][&#39;trunc_high&#39;] = 2*np.pi*np.ones(5)</span>
<span class="c1">#     model_params_to_vary[&#39;alpha_FMM&#39;][&#39;distribution&#39;] = &#39;normal&#39;</span>

<span class="n">sim_params_to_vary</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="n">sim_par_list</span><span class="p">:</span>
    <span class="n">param_dim</span> <span class="o">=</span> <span class="n">get_param_dim</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="n">mean_q</span> <span class="o">=</span> <span class="n">variation_mean</span><span class="p">[:</span><span class="n">param_dim</span><span class="p">]</span>
    <span class="n">std_q</span> <span class="o">=</span> <span class="n">stdn</span><span class="p">[:</span><span class="n">param_dim</span><span class="p">]</span>
    <span class="n">trunc_low_q</span> <span class="o">=</span> <span class="n">trunc_low</span><span class="p">[:</span><span class="n">param_dim</span><span class="p">]</span>
    <span class="n">trunc_high_q</span> <span class="o">=</span> <span class="n">trunc_high</span><span class="p">[:</span><span class="n">param_dim</span><span class="p">]</span>
    <span class="n">sim_params_to_vary</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mean_q</span><span class="p">,</span> <span class="n">standard_deviation</span><span class="o">=</span><span class="n">std_q</span><span class="p">,</span>\
                                                <span class="n">trunc_low</span><span class="o">=</span><span class="n">trunc_low_q</span><span class="p">,</span> <span class="n">trunc_high</span><span class="o">=</span><span class="n">trunc_high_q</span><span class="p">,</span> <span class="n">entrywise</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="s1">&#39;phase_offset&#39;</span> <span class="ow">in</span> <span class="n">sim_params_to_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">sim_params_to_vary</span><span class="p">[</span><span class="s1">&#39;phase_offset&#39;</span><span class="p">][</span><span class="s1">&#39;trunc_high&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">sim_params_to_vary</span><span class="p">[</span><span class="s1">&#39;phase_offset&#39;</span><span class="p">][</span><span class="s1">&#39;trunc_low&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">sim_params_to_vary</span><span class="p">[</span><span class="s1">&#39;phase_offset&#39;</span><span class="p">][</span><span class="s1">&#39;distribution&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;uniform&#39;</span>

<span class="c1"># stdn = 0.66</span>
<span class="c1"># mean = 0</span>
<span class="c1"># model_params_to_vary = {}</span>
<span class="c1"># for p in model_par_list:</span>
<span class="c1">#     param_dim = get_param_dim(p)</span>
<span class="c1">#     model_params_to_vary[p] = make_variation_dict(p, mean=mean, standard_deviation=stdn, entrywise=True)</span>
<span class="c1"># sim_params_to_vary = {}</span>
<span class="c1"># for q in sim_par_list:</span>
<span class="c1">#     param_dim = get_param_dim(q)</span>
<span class="c1">#     sim_params_to_vary[q] = make_variation_dict(q, mean=mean, standard_deviation=stdn, entrywise=True)</span>

<span class="n">default_priors</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">default_priors</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;A_FMM&#39;</span> <span class="ow">in</span> <span class="n">model_params_to_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">model_params_to_vary</span><span class="p">[</span><span class="s1">&#39;A_FMM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;A_FMM&#39;</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span><span class="mf">4.0</span><span class="p">,</span><span class="o">-</span><span class="mf">30.0</span><span class="p">,</span><span class="mf">8.0</span><span class="p">,</span><span class="o">-</span><span class="mf">15.0</span><span class="p">]),</span>
                                                            <span class="c1">#standard_deviation=np.asarray([10,4,30,8,15]),</span>
                                                            <span class="n">standard_deviation</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">15</span><span class="p">])),</span>
                                                            <span class="c1">#trunc_low=False,</span>
                                                            <span class="n">trunc_low</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">30</span><span class="p">]),</span>
                                                            <span class="n">trunc_high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span><span class="mi">0</span><span class="p">]),</span>
                                                            <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">)</span> <span class="c1">#None)</span>

    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;alpha_FMM&#39;</span><span class="p">,</span> <span class="s1">&#39;beta_FMM&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model_params_to_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">model_params_to_vary</span><span class="p">[</span><span class="n">p</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">trunc_low</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">trunc_high</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">)</span> <span class="c1">#None)</span>

    <span class="k">if</span> <span class="s1">&#39;omega_FMM&#39;</span> <span class="ow">in</span> <span class="n">model_params_to_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">model_params_to_vary</span><span class="p">[</span><span class="s1">&#39;omega_FMM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;omega_FMM&#39;</span><span class="p">,</span> <span class="n">trunc_low</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span>\
                                                                <span class="n">trunc_high</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">)</span> <span class="c1">#None)</span>
    <span class="k">if</span> <span class="s1">&#39;M_FMM&#39;</span> <span class="ow">in</span> <span class="n">model_params_to_vary</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">model_params_to_vary</span><span class="p">[</span><span class="s1">&#39;M_FMM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">make_variation_dict</span><span class="p">(</span><span class="s1">&#39;M_FMM&#39;</span><span class="p">,</span> <span class="n">trunc_low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">trunc_high</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>\
                                                        <span class="n">distribution</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">)</span> <span class="c1">#None</span>
<span class="c1"># ODE_params_to_vary = {&#39;theta&#39;: make_variation_dict(&#39;theta&#39;, standard_deviation=stnd)}</span>
<span class="c1"># sim_params_to_vary = {&#39;heartrate_mean&#39;: None}</span>

<span class="c1"># Combine the two dictionaries</span>
<span class="n">param_dict</span> <span class="o">=</span> <span class="n">model_params_to_vary</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">param_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">sim_params_to_vary</span><span class="p">)</span>
<span class="n">param_list</span> <span class="o">=</span> <span class="p">{</span><span class="n">p</span><span class="p">:</span> <span class="n">param_dict</span><span class="p">[</span><span class="n">p</span><span class="p">][</span><span class="s1">&#39;indexes&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span><span class="p">(</span><span class="n">param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span><span class="c1">#list(param_dict.keys())</span>

<span class="c1"># Generate parameter names</span>
<span class="n">param_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">inds</span> <span class="o">=</span> <span class="n">param_dict</span><span class="p">[</span><span class="n">param</span><span class="p">][</span><span class="s1">&#39;indexes&#39;</span><span class="p">]</span>
    <span class="n">p_dim</span> <span class="o">=</span> <span class="n">get_param_dim</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">inds</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p_dim</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">inds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">param_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">param</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">inds</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">param_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">param</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span>

<span class="c1"># Determine the number of parameters (counting each n-dimensional parameter as n parameters)</span>
<span class="n">n_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Number of parameters: </span><span class="si">{</span><span class="n">n_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;d_1&#39;, &#39;d_2&#39;, &#39;d_3&#39;, &#39;d_4&#39;, &#39;d_5&#39;, &#39;b_1&#39;, &#39;b_2&#39;, &#39;b_3&#39;, &#39;b_4&#39;, &#39;b_5&#39;, &#39;theta_1&#39;, &#39;theta_2&#39;, &#39;theta_3&#39;, &#39;theta_4&#39;, &#39;theta_5&#39;, &#39;heartrate_mean&#39;, &#39;phase_offset&#39;]

Number of parameters: 17
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># # Provide a dictionary containing the names of the parameters to vary as keys and the (entrywise) standard</span>
<span class="c1"># # deviation(s) which to vary them as values</span>
<span class="c1"># stnd = np.ones(5)</span>
<span class="c1"># # model_params_to_vary = {&#39;a&#39;: make_variation_dict(&#39;a&#39;, standard_deviation=stnd), &#39;b&#39;: make_variation_dict(&#39;b&#39;, standard_deviation=stnd),\</span>
<span class="c1"># #                       &#39;theta&#39;: make_variation_dict(&#39;theta&#39;, standard_deviation=stnd)}</span>
<span class="c1"># # model_params_to_vary = {&#39;b&#39;: make_variation_dict(&#39;b&#39;, standard_deviation=stnd)}</span>
<span class="c1"># # model_params_to_vary = {&#39;a&#39;: make_variation_dict(&#39;a&#39;, standard_deviation=stnd)}</span>
<span class="c1"># ## Provide a dictionary containing the names of the parameters to vary as keys and the (entrywise) standard</span>
<span class="c1"># ##    deviation(s) which to vary them as values</span>
<span class="c1"># model_params_to_vary = {&#39;A_FMM&#39;: make_variation_dict(&#39;A_FMM&#39;),\</span>
<span class="c1">#                         &#39;alpha_FMM&#39;: make_variation_dict(&#39;alpha_FMM&#39;), \</span>
<span class="c1">#                         &#39;beta_FMM&#39;: make_variation_dict(&#39;beta_FMM&#39;),\</span>
<span class="c1">#                         &#39;omega_FMM&#39;: make_variation_dict(&#39;omega_FMM&#39;),\</span>
<span class="c1">#                         &#39;M_FMM&#39;: make_variation_dict(&#39;M_FMM&#39;)}</span>


<span class="c1"># # model_params_to_vary = {}</span>
<span class="c1"># # for p in model_par_list:</span>
<span class="c1"># #     param_dim = get_param_dim(p)</span>
<span class="c1"># #     std_p = stdn[:param_dim]</span>
<span class="c1"># #     model_params_to_vary[p] = make_variation_dict(p, standard_deviation=std_p)</span>
<span class="c1"># # sim_params_to_vary = {}</span>
<span class="c1"># # for q in sim_par_list:</span>
<span class="c1"># #     sim_params_to_vary[q] = make_variation_dict(q, standard_deviation=1.0)</span>

<span class="c1"># # # ODE_params_to_vary = {&#39;theta&#39;: make_variation_dict(&#39;theta&#39;, standard_deviation=stnd)}</span>
<span class="c1"># sim_params_to_vary = {&#39;heartrate_mean&#39;: {}}</span>

<span class="c1"># # Combine the two dictionaries</span>
<span class="c1"># param_dict = model_params_to_vary.copy()</span>
<span class="c1"># param_dict.update(sim_params_to_vary)</span>
<span class="c1"># param_list = list(param_dict.keys())</span>

<span class="c1"># # Generate parameter names</span>
<span class="c1"># param_names = []</span>
<span class="c1"># for param in param_dict.keys():</span>
<span class="c1">#     p_dim = get_param_dim(param)</span>
<span class="c1">#     if p_dim &gt; 1:</span>
<span class="c1">#         param_names += [param+&#39;_&#39;+str(i+1) for i in range(p_dim)]</span>
<span class="c1">#     else:</span>
<span class="c1">#         param_names += [param]</span>

<span class="c1"># print(param_names)</span>

<span class="c1"># # Determine the number of parameters (counting each n-dimensional parameter as n parameters)</span>
<span class="c1"># n_params = len(param_names)</span>
<span class="c1"># print(f&quot;\nNumber of parameters: {n_params}&quot;)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model_params_to_vary = {}</span>
<span class="c1"># model_params_to_vary[&#39;A_FMM&#39;] = make_variation_dict(&#39;A_FMM&#39;, mean=np.asarray([-10.0,4.0,-30.0,8.0,-15.0]),\</span>
<span class="c1">#                                                     standard_deviation=np.asarray([10,4,30,8,15]), \</span>
<span class="c1">#                                                     trunc_low=False, \</span>
<span class="c1">#                                                     #trunc_low=np.asarray([-20,0,-60,0,-30]),\</span>
<span class="c1">#                                                     trunc_high=np.asarray([0,8,0, 16,0]), \</span>
<span class="c1">#                                                     distribution=&#39;normal&#39;)#None)</span>
<span class="c1"># for p in [&#39;alpha_FMM&#39;, &#39;beta_FMM&#39;]:</span>
<span class="c1">#     model_params_to_vary[p] = make_variation_dict(p, trunc_low=np.zeros(5), trunc_high=2*np.pi*np.ones(5),\</span>
<span class="c1">#                                                   distribution=&#39;uniform&#39;)#None)</span>

<span class="c1"># model_params_to_vary[&#39;omega_FMM&#39;] = make_variation_dict(&#39;omega_FMM&#39;, trunc_low=np.zeros(5),\</span>
<span class="c1">#                                                         trunc_high=np.ones(5), distribution=&#39;uniform&#39;)#None)</span>
<span class="c1"># model_params_to_vary[&#39;M_FMM&#39;] = make_variation_dict(&#39;M_FMM&#39;, trunc_low=0.0,trunc_high=5.0,\</span>
<span class="c1">#                                                     distribution=&#39;uniform&#39;)#None</span>
<span class="c1"># sim_params_to_vary = {}</span>
<span class="c1"># sim_params_to_vary[&#39;heartrate_mean&#39;] = {}</span>

<span class="c1"># # Combine the two dictionaries</span>
<span class="c1"># param_dict = model_params_to_vary.copy()</span>
<span class="c1"># param_dict.update(sim_params_to_vary)</span>
<span class="c1"># param_list = list(param_dict.keys())</span>

<span class="c1"># # Generate parameter names</span>
<span class="c1"># param_names = []</span>
<span class="c1"># for param in param_dict.keys():</span>
<span class="c1">#     p_dim = get_param_dim(param)</span>
<span class="c1">#     if p_dim &gt; 1:</span>
<span class="c1">#         param_names += [param+&#39;_&#39;+str(i+1) for i in range(p_dim)]</span>
<span class="c1">#     else:</span>
<span class="c1">#         param_names += [param]</span>

<span class="c1"># print(param_names)</span>

<span class="c1"># # Determine the number of parameters (counting each n-dimensional parameter as n parameters)</span>
<span class="c1"># n_params = len(param_names)</span>
<span class="c1"># print(f&quot;\nNumber of parameters: {n_params}&quot;)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># for i in range(2500):</span>
<span class="c1">#     some_prior = generate_ecg_parameter_prior_batch(64, params_model=params_model, \</span>
<span class="c1">#                                                 params_sim=params_sim, model_params_to_vary=model_params_to_vary, \</span>
<span class="c1">#                                                 sim_params_to_vary=sim_params_to_vary)</span>
<span class="c1">#     if i % 50 == 0:</span>
<span class="c1">#         now = datetime.datetime.now()</span>
<span class="c1">#         current_time = now.strftime(&quot;%H:%M:%S&quot;)</span>
<span class="c1">#         print(f&quot;Current Time after {i} iterations = {current_time}&quot;)</span>
<span class="c1"># # Time: 790 ms</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#%whos</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># timeit some_prior = generate_ecg_parameter_prior_batch(64, params_model=params_model, \</span>
<span class="c1">#                                             params_sim=params_sim, model_params_to_vary=model_params_to_vary, \</span>
<span class="c1">#                                             sim_params_to_vary=sim_params_to_vary)</span>
<span class="c1"># 790 ms</span>
<span class="c1"># prior_samples = [generate_ecg_parameter_prior_batch(128, params_model=params_model, \</span>
<span class="c1">#                                             params_sim=params_sim, model_params_to_vary=model_params_to_vary, \</span>
<span class="c1">#                                             sim_params_to_vary=sim_params_to_vary)\</span>
<span class="c1">#                  for i in range(4)]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ODE_params_to_vary = {}</span>
<span class="c1"># for p in [&#39;a&#39;,&#39;b&#39;,&#39;theta&#39;]:</span>
<span class="c1">#     param_dim = get_param_dim(p)</span>
<span class="c1">#     std_p = stdn[:param_dim]</span>
<span class="c1">#     ODE_params_to_vary[p] = make_variation_dict(p, standard_deviation=std_p)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %timeit some_prior_ODE = generate_ecg_parameter_prior_batch(64, params_model=params_ODE, \</span>
<span class="c1">#                                             params_sim=params_sim, model_params_to_vary=ODE_params_to_vary, \</span>
<span class="c1">#                                             sim_params_to_vary=sim_params_to_vary)</span>
<span class="c1"># 610 ms</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># some_prior = generate_ecg_parameter_prior_batch(64, params_model=params_model, \</span>
<span class="c1">#                                             params_sim=params_sim, model_params_to_vary=model_params_to_vary, \</span>
<span class="c1">#                                             sim_params_to_vary=sim_params_to_vary)</span>
<span class="c1"># some_prior_ODE = generate_ecg_parameter_prior_batch(64, params_model=params_ODE, \</span>
<span class="c1">#                                             params_sim=params_sim, model_params_to_vary=ODE_params_to_vary, \</span>
<span class="c1">#                                             sim_params_to_vary=sim_params_to_vary)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#%timeit simulate_batch(some_prior_ODE, params_ODE, params_sim, param_list=[&#39;a&#39;,&#39;b&#39;,&#39;theta&#39;,&#39;heartrate_mean&#39;], baseline_wander=False)</span>
<span class="c1"># 167 ms</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># %timeit simulate_batch(some_prior, params_model, params_sim, param_list=param_list, baseline_wander=False)</span>
<span class="c1"># 147 ms</span>
</pre></div>
</div>
</div>
<p>Having chosen which parameters to vary, we prepare our above prior and simulator functions for use in BayesFlow by passing them to the appropriate wrappers, Prior and Simulator respectively. Both accept functions producing individual datasets (i.e. one value for each of our 16 parameters along with one ECG signal) or batches thereof (e.g. 64 sets of 16 parameters, 64 signals).</p>
<p>This can be relevant for simulations which are computationally expensive, since parallelization may be possible. We do not explore this question here, however - providing unbatched versions in the next cell would produce the same result as the current, batched solution.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the prior</span>
<span class="n">prior_ecg</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span><span class="n">batch_prior_fun</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">generate_ecg_parameter_prior_batch</span><span class="p">,</span> <span class="n">params_model</span><span class="o">=</span><span class="n">params_model</span><span class="p">,</span> \
                                            <span class="n">params_sim</span><span class="o">=</span><span class="n">params_sim</span><span class="p">,</span> <span class="n">model_params_to_vary</span><span class="o">=</span><span class="n">model_params_to_vary</span><span class="p">,</span> \
                                            <span class="n">sim_params_to_vary</span><span class="o">=</span><span class="n">sim_params_to_vary</span><span class="p">),</span>\
                  <span class="n">param_names</span><span class="o">=</span><span class="n">param_names</span>
<span class="p">)</span>


<span class="c1"># WARNING: Uncomment only to see pathological prior:</span>
<span class="c1"># for param in [&#39;a&#39;, &#39;b&#39;, &#39;theta&#39;]:</span>
<span class="c1">#     model_params_to_vary[param][&#39;mean&#39;] = 0</span>
<span class="c1">#     model_params_to_vary[param][&#39;standard_deviation&#39;] = 0.05</span>
<span class="c1">#     model_params_to_vary[param][&#39;trunc_low&#39;] = False</span>
<span class="c1"># prior_ecg = Prior(batch_prior_fun=partial(generate_ecg_parameter_prior_batch, params_model=params_model, \</span>
<span class="c1">#                                           params_sim=params_sim, model_params_to_vary=model_params_to_vary,</span>
<span class="c1">#                                           sim_params_to_vary=sim_params_to_vary, \</span>
<span class="c1">#                                           entrywise=False, rejection_sampling=False, zero_replacement=0),\</span>
<span class="c1">#           param_names=param_names</span>
<span class="c1"># )</span>


<span class="c1"># Define the simulator</span>
<span class="n">simulator_ecg</span> <span class="o">=</span> <span class="n">Simulator</span><span class="p">(</span>
    <span class="n">batch_simulator_fun</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">simulate_batch</span><span class="p">,</span> <span class="n">params_model</span><span class="o">=</span><span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="o">=</span><span class="n">params_sim</span><span class="p">,</span>\
                      <span class="n">param_list</span><span class="o">=</span><span class="n">param_list</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="p">)</span>


<span class="c1"># Unbatched versions, should you wish to try them out:</span>
<span class="c1"># prior_ecg = Prior(prior_fun=partial(generate_ecg_parameter_prior, params_model=params_model, params_sim=params_sim, \</span>
<span class="c1">#                             model_params_to_vary=model_params_to_vary, \</span>
<span class="c1">#                             sim_params_to_vary=sim_params_to_vary, entrywise=False),\</span>
<span class="c1">#           param_names=param_names</span>
<span class="c1"># )</span>
<span class="c1"># simulator = Simulator(</span>
<span class="c1">#     simulator_fun=partial(simulate_one, params_model=params_model, params_sim=params_sim,\</span>
<span class="c1">#                           param_list=param_list, baseline_wander=False)</span>
<span class="c1"># )</span>
</pre></div>
</div>
</div>
<p>We are now ready to combine our prior and simulator into a GenerativeModel. Instantiating this class also runs an initial test to ensure that the inputs we’ve made so far have been consistent:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model_ecg</span> <span class="o">=</span> <span class="n">GenerativeModel</span><span class="p">(</span><span class="n">prior_ecg</span><span class="p">,</span> <span class="n">simulator_ecg</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;basic_ecg_simulator&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Performing 2 pilot runs with the basic_ecg_simulator model...
INFO:root:Shape of parameter batch after 2 pilot simulations: (batch_size = 2, 17)
INFO:root:Shape of simulation batch after 2 pilot simulations: (batch_size = 2, 2500)
INFO:root:No optional prior non-batchable context provided.
INFO:root:No optional prior batchable context provided.
INFO:root:No optional simulation non-batchable context provided.
INFO:root:No optional simulation batchable context provided.
</pre></div></div>
</div>
<p>Before training BayesFlow, it makes sense to inspect our prior by estimating joint density functions for all possible pairs of parameters. In the figure below, we can see that all is well.</p>
<p>Pathological priors which could be caught at this stage might, for instance, involve perfectly correlated pairs of parameters (i.e. with a correlation of 1 or -1), which would lead to prior distributions looking like straight diagonal lines in the plots below. Constant parameters would be equally problematic, and they would manifest as straight vertical lines in the plots below. Either occurrence (perfectly correlated / constant) renders kernel density estimation impossible, and since this
process underlies the graphs in the lower triangle of the plot, this leads to a warning as a further clue to the user that something is wrong with the prior.</p>
<p>If you wish to see these situations, feel free to uncomment the appropriate lines in the cell defining prior_ecg above. Make sure to restore the normal configuration afterwards, however, since these pathologies render training impossible - in both cases, you would be asking BayesFlow to map a one-dimensional object (a straight line) onto a two-dimensional one (a 2D distribution), which it cannot do.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model_ecg.presimulate_and_save(batch_size=64, folder_path=&#39;presim_test&#39;, total_iterations=None, memory_limit=None,</span>
<span class="c1">#                              iterations_per_epoch = 2, epochs = 2, extend_from=0)</span>
</pre></div>
</div>
</div>
<p>Before training BayesFlow, it makes sense to inspect our prior by estimating joint density functions for all possible pairs of parameters. In the figure below, we can see that all is well.</p>
<p>Pathological priors which could be caught at this stage might, for instance, involve perfectly correlated pairs of parameters (i.e. with a correlation of 1 or -1), which would lead to prior distributions looking like straight diagonal lines in the plots below. Constant parameters would be equally problematic, and they would manifest as straight vertical lines in the plots below. Either occurrence (perfectly correlated / constant) renders kernel density estimation impossible, and since this
process underlies the graphs in the lower triangle of the plot, this leads to a warning as a further clue to the user that something is wrong with the prior.</p>
<p>If you wish to see these situations, feel free to uncomment the appropriate lines in the cell defining prior_ecg above. Make sure to restore the normal configuration afterwards, however, since these pathologies render training impossible - in both cases, you would be asking BayesFlow to map a one-dimensional object (a straight line) onto a two-dimensional one (a 2D distribution), which it cannot do.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#As per default, the plot_prior2d function will obtain 1000 draws from the joint prior.</span>
<span class="c1">#prior_plots = prior_ecg.plot_prior2d()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pushforward_dict</span> <span class="o">=</span> <span class="n">model_ecg</span><span class="o">.</span><span class="n">plot_pushforward</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_52_0.png" src="../_images/tutorial_notebooks_ECG_Model_52_0.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_52_1.png" src="../_images/tutorial_notebooks_ECG_Model_52_1.png" />
</div>
</div>
</section>
<section id="3.-Setting-up-BayesFlow’s-Neural-Architecture">
<h1>3. Setting up BayesFlow’s Neural Architecture<a class="headerlink" href="#3.-Setting-up-BayesFlow’s-Neural-Architecture" title="Permalink to this heading"></a></h1>
<p>The next step is to define a summary network. There are two primary considerations here: 1) What kind of architecture can capture as many important features of the simulated data as possible? 2) How small should the resulting summarized representation of the simulated data be?</p>
<p>Where the first of these questions is concerned, domain knowledge can often come in handy: it makes sense to choose a neural architecture which has been used successfully in a related task on similar data.</p>
<p>For instance, below, a variant of the convolutional neural network (CNN) used by Wu et al. (2021) ( <a class="reference external" href="https://www.frontiersin.org/articles/10.3389/fncom.2020.564015/full">https://www.frontiersin.org/articles/10.3389/fncom.2020.564015/full</a> ) to classify ECG signals into classes corresponding to diagnoses is implemented.</p>
<p>Regarding the second question, in the absence of domain knowledge pointing to a specific number of latent parameters, four times the number of parameters is a sensible starting point; this is what was adopted below, i.e. n_summary = <span class="math notranslate nohighlight">\(4\cdot16 = 64\)</span>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LSTM_ecg</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_summary</span><span class="p">,</span> <span class="n">sampling_frequency</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LSTM_ecg</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">n_summary</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="c1">#tf.keras.layers.LSTM(n_summary*4, return_sequences=True),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">n_summary</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">return_sequences</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">LSTM</span><span class="p">(</span><span class="n">n_summary</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x is a 3D tensor of shape (batch_size, n_time_steps, n_time_series)&quot;&quot;&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lstm</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">class</span> <span class="nc">CNN_ecg</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_summary</span><span class="p">,</span> <span class="n">sampling_frequency</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CNN_ecg</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span>  <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">28</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;causal&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">kernel_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">28</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;causal&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">kernel_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">28</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;causal&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">kernel_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">28</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;causal&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_summary</span><span class="p">)</span>
        <span class="p">])</span>
<span class="c1">#        self.full = tf.keras.layers.Dense(n_summary)</span>
<span class="c1">#        self.lstm = tf.keras.layers.LSTM(n_summary)</span>
<span class="c1">#         self.conv = tf.keras.layers.Conv1D(n_summary, kernel_size=sampling_frequency, strides=1,</span>
<span class="c1">#                                    padding=&#39;causal&#39;, activation=&#39;relu&#39;, kernel_initializer=&#39;glorot_uniform&#39;)</span>
<span class="c1">#         self.lstm = tf.keras.Sequential([</span>
<span class="c1">#             tf.keras.layers.LSTM(n_summary, return_sequences=True),</span>
<span class="c1">#             tf.keras.layers.LSTM(n_summary, return_sequences=True),</span>
<span class="c1">#             tf.keras.layers.LSTM(n_summary)])</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x is a 3D tensor of shape (batch_size, n_time_steps, n_time_series)&quot;&quot;&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1">#out = self.full(out)</span>
        <span class="c1">#out = self.lstm(x)</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># class NN_ecg(tf.keras.Model):</span>
<span class="c1">#     def __init__(self, n_summary, sampling_frequency):</span>
<span class="c1">#         super(NN_ecg, self).__init__()</span>

<span class="c1">#         self.conv =  tf.keras.Sequential([</span>
<span class="c1">#             tf.keras.layers.Conv1D(sampling_frequency, kernel_size=int(sampling_frequency/28), strides=1,</span>
<span class="c1">#                                    padding=&#39;causal&#39;, activation=&#39;relu&#39;),</span>
<span class="c1">#             tf.keras.layers.AveragePooling1D(pool_size=3, strides=2),</span>
<span class="c1">#             tf.keras.layers.Conv1D(int(sampling_frequency/2-1), kernel_size=int(sampling_frequency/28+2), strides=1,</span>
<span class="c1">#                                    padding=&#39;causal&#39;, activation=&#39;relu&#39;),</span>
<span class="c1">#             tf.keras.layers.AveragePooling1D(pool_size=3, strides=2),</span>
<span class="c1">#             tf.keras.layers.Conv1D(int(sampling_frequency/4-1), kernel_size=int(sampling_frequency/28+4), strides=1,</span>
<span class="c1">#                                    padding=&#39;causal&#39;, activation=&#39;relu&#39;),</span>
<span class="c1">#             tf.keras.layers.AveragePooling1D(pool_size=3, strides=2),</span>
<span class="c1">#             tf.keras.layers.Conv1D(int(sampling_frequency/8-1), kernel_size=int(sampling_frequency/28+6), strides=1,</span>
<span class="c1">#                                    padding=&#39;causal&#39;, activation=&#39;relu&#39;),</span>
<span class="c1">#             tf.keras.layers.AveragePooling1D(pool_size=3, strides=2),</span>
<span class="c1">#             tf.keras.layers.Flatten(),</span>
<span class="c1">#             tf.keras.layers.Dense(n_summary)</span>
<span class="c1">#         ])</span>
<span class="c1"># #        self.full = tf.keras.layers.Dense(n_summary)</span>
<span class="c1"># #        self.lstm = tf.keras.layers.LSTM(n_summary)</span>
<span class="c1"># #         self.conv = tf.keras.layers.Conv1D(n_summary, kernel_size=sampling_frequency, strides=1,</span>
<span class="c1"># #                                    padding=&#39;causal&#39;, activation=&#39;relu&#39;, kernel_initializer=&#39;glorot_uniform&#39;)</span>
<span class="c1"># #         self.lstm = tf.keras.Sequential([</span>
<span class="c1"># #             tf.keras.layers.LSTM(n_summary, return_sequences=True),</span>
<span class="c1"># #             tf.keras.layers.LSTM(n_summary, return_sequences=True),</span>
<span class="c1"># #             tf.keras.layers.LSTM(n_summary)])</span>

<span class="c1">#     def call(self, x, **args):</span>
<span class="c1">#         &quot;&quot;&quot;x is a 3D tensor of shape (batch_size, n_time_steps, n_time_series)&quot;&quot;&quot;</span>

<span class="c1">#         out = self.conv(x)</span>
<span class="c1">#         #out = self.full(out)</span>
<span class="c1">#         #out = self.lstm(x)</span>
<span class="c1">#         return out</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">summary_predictor</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_summary</span><span class="p">,</span> <span class="n">sampling_frequency</span><span class="p">,</span> <span class="n">n_params</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">summary_predictor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">conv</span> <span class="o">=</span>  <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">28</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;causal&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">kernel_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">28</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;causal&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">4</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">kernel_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">28</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;causal&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv1D</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">8</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">kernel_size</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">sampling_frequency</span><span class="o">/</span><span class="mi">28</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;causal&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">AveragePooling1D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_summary</span><span class="p">),</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_params</span><span class="p">)</span>
        <span class="p">])</span>
<span class="c1">#        self.full = tf.keras.layers.Dense(n_summary)</span>
<span class="c1">#        self.lstm = tf.keras.layers.LSTM(n_summary)</span>
<span class="c1">#         self.conv = tf.keras.layers.Conv1D(n_summary, kernel_size=sampling_frequency, strides=1,</span>
<span class="c1">#                                    padding=&#39;causal&#39;, activation=&#39;relu&#39;, kernel_initializer=&#39;glorot_uniform&#39;)</span>
<span class="c1">#         self.lstm = tf.keras.Sequential([</span>
<span class="c1">#             tf.keras.layers.LSTM(n_summary, return_sequences=True),</span>
<span class="c1">#             tf.keras.layers.LSTM(n_summary, return_sequences=True),</span>
<span class="c1">#             tf.keras.layers.LSTM(n_summary)])</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;x is a 3D tensor of shape (batch_size, n_time_steps, n_time_series)&quot;&quot;&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="c1">#out = self.full(out)</span>
        <span class="c1">#out = self.lstm(x)</span>
        <span class="k">return</span> <span class="n">out</span>

<span class="k">def</span> <span class="nf">_default_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;rb+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">loaded_file</span> <span class="o">=</span> <span class="n">pickle_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">loaded_file</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">adapt_learning_rate</span><span class="p">(</span><span class="n">epoch</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">epoch</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="ow">and</span> <span class="n">epoch</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">save_model</span><span class="p">(</span><span class="n">folder_path</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span> <span class="n">max_to_keep</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">saved_so_far</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">folder_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">saved_so_far</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">oldest</span> <span class="o">=</span> <span class="mi">999</span>
        <span class="k">for</span> <span class="n">flname</span> <span class="ow">in</span> <span class="n">saved_so_far</span><span class="p">:</span>
            <span class="n">model_no</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;_([0-9]*)&#39;</span><span class="p">,</span> <span class="n">flname</span><span class="p">)</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">model_no</span><span class="p">)</span>  <span class="o">&lt;</span> <span class="n">oldest</span><span class="p">:</span>
                <span class="n">file_to_delete</span> <span class="o">=</span> <span class="n">flname</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">file_to_delete</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">summary_as_prediction</span><span class="p">(</span><span class="n">summary_network</span><span class="p">,</span> <span class="n">presimulation_path</span><span class="p">,</span> <span class="n">checkpoint_location</span><span class="p">,</span> <span class="n">custom_loader</span><span class="o">=</span><span class="n">_default_loader</span><span class="p">):</span>
    <span class="n">my_lr_scheduler</span> <span class="o">=</span> <span class="n">keras</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">LearningRateScheduler</span><span class="p">(</span><span class="n">adapt_learning_rate</span><span class="p">)</span>
    <span class="n">loss_history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">presimulation_path</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ep</span><span class="p">,</span> <span class="n">current_filename</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">file_list</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

        <span class="c1"># Read single file into memory as a dictionary or list</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">presimulation_path</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">current_filename</span>
        <span class="n">epoch_data</span> <span class="o">=</span> <span class="n">custom_loader</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>

        <span class="c1"># For each epoch, the number of iterations is inferred from the presimulated dictionary or list used for that epoch</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epoch_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">index_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">epoch_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">epoch_data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">index_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">epoch_data</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading a simulation file resulted in a </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">epoch_data</span><span class="p">)</span><span class="si">}</span><span class="s2">. Must be a dictionary or a list.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">index_list</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Training epoch </span><span class="si">{</span><span class="n">ep</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">p_bar</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">it</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">index_list</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>

                <span class="c1"># Perform one training step and obtain current loss value</span>
                <span class="n">input_dict</span> <span class="o">=</span> <span class="n">configurator_ecg</span><span class="p">(</span><span class="n">epoch_data</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

                <span class="c1"># Like the number of iterations, the batch size is inferred from presimulated dictionary or list</span>
                <span class="c1">#batch_size = len(input_dict[DEFAULT_KEYS[&#39;parameters&#39;]][0])</span>

                <span class="n">batch_loss</span> <span class="o">=</span> <span class="n">summary_network</span><span class="o">.</span><span class="n">train_on_batch</span><span class="p">(</span><span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;summary_conditions&#39;</span><span class="p">],</span> <span class="n">input_dict</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">])</span>
                <span class="c1">#loss = self._train_step(batch_size, input_dict, **kwargs)</span>

                <span class="c1"># Store returned loss</span>
                <span class="n">loss_history</span> <span class="o">+=</span> <span class="p">[</span><span class="n">batch_loss</span><span class="p">]</span>

                <span class="c1"># Format for display on progress bar</span>
                <span class="c1">#disp_str = format_loss_string(ep, it, loss, avg_dict, slope)</span>

                <span class="c1"># Update progress bar</span>
                <span class="c1">#p_bar.set_postfix_str(disp_str)</span>
                <span class="n">p_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                <span class="c1"># Check optional stopping and end training</span>
<span class="c1">#                     if self._check_optional_stopping():</span>
<span class="c1">#                         self._save_trainer(save_checkpoint)</span>
<span class="c1">#                         return self.loss_history.get_plottable()</span>

        <span class="c1"># Store after each epoch, if specified</span>
        <span class="n">summary_network</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_checkpoint</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#loss=tf.keras.losses.MeanSquaredError()</span>
</pre></div>
</div>
</div>
<p>We specify the parameters of our summary network to match the desired latent summary dimensions (n_summary = 64) and, in our specific case, the ECG sampling frequency (sf_ecg = 250).</p>
<p>The invertible neural network (INN) we will be combining with this summary network can be generated by BayesFlow with as little as two inputs - a number of parameters n_params and a number of desired coupling layers n_coupling_layers. This, too, is done below.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coupling_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;t_args&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;dense_args&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">coupling_block_size</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;elu&#39;</span><span class="p">),</span>
        <span class="s1">&#39;n_dense&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;spec_norm&#39;</span><span class="p">:</span> <span class="n">spectral_normalization</span>
    <span class="p">},</span>
    <span class="s1">&#39;s_args&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;dense_args&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">units</span><span class="o">=</span><span class="n">coupling_block_size</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s1">&#39;glorot_uniform&#39;</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;elu&#39;</span><span class="p">),</span>
        <span class="s1">&#39;n_dense&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;spec_norm&#39;</span><span class="p">:</span> <span class="n">spectral_normalization</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">if</span> <span class="n">summary_net_type</span> <span class="o">==</span> <span class="s1">&#39;LSTM&#39;</span><span class="p">:</span>
    <span class="n">NN_ecg</span> <span class="o">=</span> <span class="n">LSTM_ecg</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;LSTM selected.&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">NN_ecg</span> <span class="o">=</span> <span class="n">CNN_ecg</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;CNN selected&quot;</span><span class="p">)</span>

<span class="n">summary_net_ecg</span> <span class="o">=</span> <span class="n">NN_ecg</span><span class="p">(</span><span class="n">n_summary</span><span class="o">=</span><span class="n">n_summary</span><span class="p">,</span> <span class="n">sampling_frequency</span><span class="o">=</span><span class="n">params_sim</span><span class="p">[</span><span class="s1">&#39;sf_ecg&#39;</span><span class="p">])</span>
<span class="n">inference_net_ecg</span> <span class="o">=</span> <span class="n">InvertibleNetwork</span><span class="p">({</span>
    <span class="s1">&#39;n_params&#39;</span><span class="p">:</span> <span class="n">n_params</span><span class="p">,</span>
    <span class="s1">&#39;n_coupling_layers&#39;</span><span class="p">:</span> <span class="n">depth_INN</span><span class="p">,</span>
    <span class="s1">&#39;coupling_settings&#39;</span><span class="p">:</span> <span class="n">coupling_settings</span>
<span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CNN selected
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
2022-11-02 16:16:21.396465: I tensorflow/compiler/jit/xla_cpu_device.cc:41] Not creating XLA devices, tf_xla_enable_xla_devices not set
2022-11-02 16:16:21.397636: I tensorflow/stream_executor/platform/default/dso_loader.cc:49] Successfully opened dynamic library libcuda.so.1
2022-11-02 16:16:23.451109: E tensorflow/stream_executor/cuda/cuda_driver.cc:328] failed call to cuInit: CUDA_ERROR_NO_DEVICE: no CUDA-capable device is detected
2022-11-02 16:16:23.451139: I tensorflow/stream_executor/cuda/cuda_diagnostics.cc:156] kernel driver does not appear to be running on this host (rene-LENOVO-Y520-15IKBN): /proc/driver/nvidia/version does not exist
2022-11-02 16:16:23.451753: I tensorflow/core/platform/cpu_feature_guard.cc:142] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  SSE4.1 SSE4.2 AVX AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
2022-11-02 16:16:23.452457: I tensorflow/compiler/jit/xla_gpu_device.cc:99] Not creating XLA devices, tf_xla_enable_xla_devices not set
</pre></div></div>
</div>
<p>It may make sense to test the summary network on its own to ensure that, if nothing else, the various layers are compatible with one another. If they are, the following cell will produce an output; otherwise, it will raise an error.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The data must go through a configurator in order to be compatible with the summary network</span>
<span class="c1"># A more detailed explanation is given below</span>
<span class="k">def</span> <span class="nf">simulator_configurator</span><span class="p">(</span><span class="n">simdata</span><span class="p">):</span>
    <span class="n">simdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">simdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">flt32data</span> <span class="o">=</span> <span class="n">simdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">flt32data</span><span class="p">)</span>

<span class="n">mini_prior</span> <span class="o">=</span> <span class="n">generate_ecg_parameter_prior_batch</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">params_model</span><span class="o">=</span><span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="o">=</span><span class="n">params_sim</span><span class="p">,</span> \
                                        <span class="n">model_params_to_vary</span> <span class="o">=</span> <span class="n">model_params_to_vary</span><span class="p">,</span> \
                                        <span class="n">sim_params_to_vary</span><span class="o">=</span> <span class="n">sim_params_to_vary</span><span class="p">)</span>

<span class="n">mini_batch</span> <span class="o">=</span> <span class="n">simulate_batch</span><span class="p">(</span><span class="n">mini_prior</span><span class="p">,</span> <span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">,</span> <span class="n">param_list</span> <span class="o">=</span> <span class="n">param_list</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">mini_conf_batch</span> <span class="o">=</span> <span class="n">simulator_configurator</span><span class="p">(</span><span class="n">mini_batch</span><span class="p">)</span>
<span class="n">summary_net_ecg</span><span class="p">(</span><span class="n">mini_conf_batch</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;tf.Tensor: shape=(10, 64), dtype=float32, numpy=
array([[ 3.24456766e-03, -1.64107326e-02, -3.33966501e-03,
        -1.18468534e-02,  7.74563663e-03, -1.07237054e-02,
         1.55723412e-02,  1.12250680e-02, -2.57169567e-02,
        -3.09401080e-02, -3.76627930e-02,  3.54484729e-02,
        -3.75546962e-02,  1.65478941e-02, -1.32772643e-02,
        -2.39839647e-02,  1.93066411e-02,  1.83899812e-02,
         7.15846568e-03, -1.72677580e-02, -1.02557410e-02,
        -2.22181529e-02, -2.09757537e-02,  1.70257930e-02,
        -8.28521326e-03, -9.62187536e-03, -1.64539330e-02,
        -5.47604784e-02,  1.01153757e-02,  5.42402547e-03,
        -1.22632142e-02,  1.35707138e-02, -1.38075724e-02,
        -3.39601934e-02, -8.73538293e-03,  1.08660143e-02,
        -5.37361903e-03, -2.31008064e-02, -8.07662308e-03,
         1.30897099e-02, -1.40462574e-02,  2.80745104e-02,
         1.99739216e-03,  1.63167603e-02, -1.93377119e-03,
        -2.32791547e-02, -9.37607884e-03, -6.38548750e-03,
         1.03146443e-03,  5.94492070e-03,  1.49884261e-02,
        -7.65219610e-03, -8.31460021e-03,  1.80328190e-02,
        -1.57494880e-02,  1.40053835e-02,  2.02362761e-02,
        -6.46799989e-03,  1.70194265e-02,  9.64552537e-03,
        -1.94355333e-03,  3.21847796e-02,  2.84735300e-03,
         3.38038765e-02],
       [-4.63962601e-03, -1.27706397e-02, -1.68315191e-02,
        -5.43718878e-03,  1.30503941e-02, -5.37311798e-03,
         1.38567295e-02,  1.38973286e-02, -1.26457801e-02,
        -1.07835373e-02,  1.49859022e-03,  1.49340956e-02,
        -1.17628966e-02,  1.56225478e-02, -1.14150727e-02,
        -5.33425026e-02,  2.12407056e-02,  1.69208627e-02,
         5.14632277e-03, -1.12179872e-02, -8.84360448e-03,
        -9.99700278e-03, -3.23996320e-03,  4.39996971e-03,
         3.19042709e-03, -3.75022786e-03, -1.31152999e-02,
        -2.40244027e-02,  1.61012243e-02,  1.14837615e-02,
        -5.10686170e-03,  1.30044529e-04, -1.07309781e-02,
        -1.54246651e-02,  1.68750994e-04, -1.64782759e-02,
         1.09114945e-02, -2.69285985e-03,  4.60404530e-03,
        -2.28979066e-03, -3.44538456e-03,  3.16384621e-02,
        -3.28805414e-03,  2.22703498e-02,  6.41596830e-03,
        -5.59203094e-03,  1.55887417e-02, -1.80669650e-02,
        -1.19289290e-03,  1.79700879e-03, -1.67342951e-03,
        -7.46605732e-03,  1.16901137e-02,  2.55385190e-02,
        -1.87534858e-02,  5.07946266e-03,  8.70363787e-03,
        -9.34754405e-03, -9.40031372e-03,  1.85824069e-03,
        -7.10364478e-03,  3.52135897e-02,  7.69260386e-03,
         1.11293821e-02],
       [ 1.76702579e-03,  2.48973165e-03, -3.38223018e-03,
        -2.07733922e-03,  8.48887302e-03, -9.84759536e-03,
        -2.17647199e-03,  1.25311017e-02, -5.24697779e-03,
        -1.82653265e-03, -2.60787876e-03,  9.50842910e-03,
        -5.37691871e-03,  6.28034584e-03, -1.08975675e-02,
        -2.18905099e-02,  9.22601763e-03,  8.37400462e-03,
        -1.16462372e-02, -5.74429845e-03,  7.74699170e-03,
         1.37600629e-02, -3.65915289e-03,  9.86343995e-03,
        -5.97426016e-03, -2.22308724e-03, -1.69569831e-02,
        -2.97216768e-03,  2.08654930e-03, -7.21106818e-03,
         9.04891640e-04,  8.77749640e-03, -3.28478822e-03,
        -1.24638863e-02, -4.49178601e-03, -1.03718471e-02,
         1.01813003e-02, -1.32992715e-02,  8.25735182e-03,
         1.16822906e-02, -1.58072393e-02, -2.01814575e-03,
        -9.60859936e-04,  1.01949852e-02,  1.92145118e-04,
         1.31481513e-03,  2.04105489e-03, -4.78366576e-03,
         1.95258949e-03, -3.43168247e-03, -8.99210479e-03,
         1.18811820e-02, -1.52884703e-03,  9.06945206e-03,
        -1.07428925e-02,  1.77551457e-03,  9.55044199e-03,
        -3.86864273e-03,  1.69330044e-03, -5.78637235e-04,
        -8.09120480e-03,  1.99868949e-03, -7.71602616e-03,
         1.88069325e-02],
       [-8.34617112e-03, -9.93749592e-03,  5.26132435e-03,
        -1.82580110e-03,  9.57853720e-03, -1.28469430e-02,
        -6.91437628e-03,  1.49344075e-02, -1.35524170e-02,
        -1.88396266e-03, -8.52051377e-03,  1.40336221e-02,
        -2.09499989e-03,  6.73260214e-03, -1.10943373e-02,
        -2.06453558e-02,  7.86845945e-03,  2.73562688e-02,
         8.94350279e-03, -1.38578741e-02,  2.59822607e-03,
         9.40415543e-03, -7.28146266e-03,  1.44554516e-02,
        -7.65593536e-03,  1.79710276e-02, -6.04319992e-03,
        -2.70430967e-02,  1.38848564e-02,  7.60258641e-04,
        -1.03887985e-03,  2.60042250e-02,  1.51894111e-02,
        -1.19025232e-02,  1.45691354e-03, -3.46387294e-03,
         1.01025719e-02, -1.24985110e-02, -9.50123463e-03,
         1.88983921e-02, -1.11025479e-02,  3.61361029e-03,
        -1.77302919e-02,  2.95009837e-02, -1.60861295e-03,
        -1.64960045e-02, -1.05406614e-02, -4.20133490e-03,
        -5.63700218e-03,  5.23474440e-03,  2.21606414e-03,
        -4.50225780e-03, -1.51533354e-03,  1.64001994e-02,
        -7.08148815e-04,  7.50257354e-03,  1.22600049e-02,
        -2.20426917e-03,  4.00615111e-03,  3.26299411e-03,
        -1.04095391e-03,  1.66636445e-02,  4.23521223e-03,
         9.88042355e-03],
       [-2.64907046e-03, -2.91275140e-03,  7.32426997e-04,
         4.65903431e-05,  1.35062253e-02, -1.48723018e-03,
         9.33165103e-03,  9.92549956e-03, -7.77849648e-03,
         1.04252924e-03, -8.34132824e-03,  9.71136149e-04,
        -3.23829800e-03,  3.04025039e-03, -7.20747653e-03,
        -1.48192402e-02,  1.95903257e-02,  1.08812982e-02,
        -3.01429234e-03, -7.93535449e-03, -7.85713457e-03,
         7.01053860e-03, -1.22280698e-03,  7.44793843e-03,
        -2.43394729e-03, -4.43934835e-03, -1.15222326e-02,
        -1.40891513e-02,  3.65828304e-03,  5.22945775e-03,
        -5.95002435e-04,  7.76342489e-03,  7.41989468e-04,
        -7.72994664e-03, -6.79061981e-03, -7.53282849e-03,
         5.21474984e-03, -1.01936013e-02,  5.95732406e-03,
         6.33426011e-03, -7.57818250e-03,  1.17340665e-02,
        -7.31039234e-03,  5.34785166e-03, -3.78290378e-03,
        -6.86603133e-03, -5.32145426e-03, -6.65825047e-03,
         6.71169907e-03, -3.51365539e-04,  1.99922128e-04,
        -2.70953542e-03, -1.27486940e-02,  1.99410133e-02,
        -5.03266929e-04,  2.15259683e-03,  1.13483807e-02,
        -7.07907137e-03, -6.38654921e-04,  3.63958161e-03,
        -9.24443640e-03,  9.90270823e-03, -2.72398582e-04,
         9.68253426e-03],
       [ 2.46298569e-03,  3.23007116e-03,  1.76435104e-03,
         2.33268598e-03,  2.82393536e-03, -3.62791121e-03,
         6.89662248e-03,  1.33442692e-02, -4.60357592e-03,
         1.05690164e-03, -1.83855109e-02,  2.59315129e-04,
        -3.57337715e-03,  6.30038092e-03, -6.87871501e-03,
        -1.54213198e-02,  9.43662133e-03,  1.31487530e-02,
        -5.31562185e-03, -7.19792023e-03,  2.10980489e-03,
         5.64702461e-03, -3.91139230e-03,  2.27172021e-03,
         2.92660831e-03, -1.03080762e-03,  4.95274737e-03,
        -1.59571636e-02,  8.52794736e-04,  6.89948257e-03,
        -2.28561019e-03,  5.14073856e-03,  7.88109750e-03,
        -9.19564068e-03,  2.49863253e-03, -8.08237121e-03,
         3.36464914e-03, -4.25842358e-03, -3.01002502e-03,
         1.01159671e-02,  1.96318189e-03,  1.63296983e-02,
        -1.18920095e-02,  7.74781266e-03, -3.66432499e-03,
        -3.88403493e-03,  7.17626233e-03, -4.80821589e-03,
         3.86918243e-03,  4.52077808e-03, -7.75070488e-03,
        -3.16603901e-03, -2.69539654e-03,  1.40473088e-02,
        -2.39790138e-03,  7.98668619e-03,  5.29166218e-03,
        -5.52918809e-03,  6.79211598e-03, -1.65072596e-03,
         6.42562052e-03,  5.01054432e-03, -6.88130502e-03,
         9.36325453e-03],
       [-5.96671365e-03,  1.34759326e-03,  5.46307396e-03,
         1.39163435e-03,  1.12655070e-02, -2.34296150e-03,
         1.14681982e-02,  8.17963202e-03, -4.96718567e-03,
         8.09026789e-03, -7.79785775e-03,  5.85173257e-04,
        -2.68648495e-03,  2.04817182e-03, -4.48378781e-03,
        -7.93863833e-03,  1.63401142e-02,  9.48207546e-03,
         6.60005398e-03, -8.29841569e-03, -6.21248549e-03,
         1.19140763e-02,  2.59222090e-03,  5.27635310e-03,
         1.23577705e-03, -8.61920416e-03, -1.43436305e-02,
        -1.06953867e-02,  1.02475723e-02,  6.90548168e-03,
        -7.04483455e-03,  1.36000738e-02,  8.67305789e-04,
         3.01013212e-03, -5.03810681e-03,  3.22628161e-03,
         6.88406825e-03, -8.50675907e-03,  3.24551435e-03,
         1.32147018e-02, -9.16547514e-03,  3.08331847e-03,
        -4.83494857e-03,  1.09248888e-02,  7.74243101e-03,
        -1.37184635e-02,  6.03213999e-03, -1.35520287e-03,
         2.06031650e-03,  6.09713187e-03, -7.31219724e-03,
        -1.01056909e-02,  4.74079745e-04,  1.16990786e-02,
        -1.05250292e-02,  3.71317193e-03,  3.79018090e-03,
         3.95507133e-03,  1.30962348e-02,  1.97951961e-03,
        -7.45200831e-03,  8.85149464e-03,  3.31120146e-03,
         7.83941150e-03],
       [-1.67577353e-04, -6.90943608e-03, -2.55157705e-03,
        -2.24411068e-03, -8.27923883e-04, -3.28427972e-03,
        -1.47103239e-03,  1.26331355e-02, -7.05925701e-03,
         1.27712265e-03, -1.14190951e-02, -6.28751749e-03,
        -4.58655739e-03, -1.99233368e-03, -1.84542034e-02,
        -6.97372202e-03,  1.28726354e-02,  1.15378611e-02,
         2.40234542e-04, -9.37251560e-03, -2.01418772e-02,
         6.82975492e-03, -3.12785711e-03,  2.85147736e-03,
         1.28668128e-03,  6.62231445e-03, -9.99804400e-03,
        -1.62761137e-02,  2.78872577e-03,  6.13288581e-03,
        -8.91170092e-03,  1.15974154e-02,  1.09241251e-03,
        -2.88474676e-03, -8.64984654e-03, -4.19113366e-03,
         7.27173360e-03, -1.50924968e-02,  4.87063453e-03,
         1.61262956e-02, -1.44479629e-02,  9.70147178e-03,
        -1.36786224e-02,  1.03286579e-02,  3.51922866e-03,
        -1.26415771e-02, -4.04452626e-03,  5.44013456e-04,
        -2.55953614e-03,  3.88928503e-03, -8.18894245e-03,
        -5.41199464e-03,  3.75570753e-03,  7.08277710e-03,
        -4.84136166e-03,  6.08763052e-03,  4.69812052e-03,
        -1.07908444e-02,  2.54417071e-03, -2.08180584e-03,
        -2.94783618e-03,  1.81640573e-02,  2.58331303e-03,
         1.28154224e-02],
       [ 1.64085883e-04,  1.34705112e-03, -2.50221137e-03,
        -2.97719426e-03,  1.34700537e-02, -9.51178279e-03,
         1.90626271e-02,  1.65147930e-02, -2.03735009e-02,
        -5.49429096e-03, -4.55398299e-03, -8.45681410e-04,
        -5.08469436e-03,  1.86994905e-03, -1.10589936e-02,
        -1.64479483e-02,  9.42527968e-03,  1.49506303e-02,
         2.81122327e-03, -1.15094436e-02, -1.56082213e-02,
         1.02585256e-02, -1.84818963e-03,  3.11538577e-04,
         5.46971709e-03,  5.94071206e-03, -1.48306442e-02,
        -2.85808444e-02,  1.72738289e-03,  9.04094707e-03,
         3.19156330e-04,  1.36553477e-02, -2.73274444e-03,
        -3.79895931e-03, -6.23126328e-03, -8.83940794e-03,
         1.64310411e-02, -5.62730152e-03,  4.97513171e-03,
         2.11178437e-02, -1.75768342e-02,  5.35870437e-04,
        -1.62865017e-02,  1.22626163e-02, -5.12611400e-03,
        -1.09002050e-02,  5.67504996e-03, -9.59447352e-04,
        -2.86630075e-03,  4.16954095e-03, -1.30310152e-02,
         3.16064199e-03, -2.32005399e-03,  2.48022061e-02,
        -6.73709903e-04,  1.11188414e-02,  1.26073081e-02,
        -5.83511405e-03,  2.61322130e-05,  1.33731053e-04,
        -1.09960716e-02,  3.20223160e-03,  1.00036040e-02,
         8.94202106e-03],
       [-2.22928938e-03, -7.20459595e-03,  1.30706504e-02,
        -1.17668053e-02,  3.57659012e-02, -2.10356005e-02,
        -8.07841867e-03,  2.37106960e-02,  4.11702320e-03,
        -1.79027300e-02, -2.63283588e-02,  1.22494427e-02,
        -2.48051770e-02, -6.23081625e-03, -6.93108188e-03,
        -2.78352909e-02,  5.90121048e-03,  3.71425948e-03,
         1.37824090e-02, -1.02854967e-02,  2.56099226e-03,
         2.71415943e-03, -1.98844690e-02,  6.51730224e-04,
        -1.70425326e-03,  2.19112542e-03, -1.94375124e-02,
        -4.98152524e-02,  1.11309290e-02, -1.21156592e-03,
        -1.31000699e-02,  8.59808829e-03, -1.22597869e-02,
        -1.93167403e-02, -1.24504194e-02, -1.07406629e-02,
         7.05526909e-03, -2.40683183e-02,  7.44454656e-03,
         1.07667483e-02, -4.94353287e-03,  8.89418274e-03,
        -1.16490014e-02,  1.72710810e-02,  8.79048835e-03,
        -9.68047511e-03,  5.44901611e-03, -3.74445319e-03,
         5.31280600e-03,  6.34946115e-03,  3.81225254e-03,
         5.66604082e-04, -1.34298392e-03,  1.75348017e-02,
        -2.26252433e-02, -2.72340700e-03,  1.29145058e-02,
        -1.05564240e-02, -9.55491140e-03,  6.51606033e-03,
        -1.57220159e-02,  2.66325213e-02,  3.51311499e-03,
         2.01565903e-02]], dtype=float32)&gt;
</pre></div></div>
</div>
<p>Next, we combine our summary network and INN into a single amortizer network using BayesFlow’s AmortizedPosterior class:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">amortizer_ecg</span> <span class="o">=</span> <span class="n">AmortizedPosterior</span><span class="p">(</span><span class="n">inference_net_ecg</span><span class="p">,</span> <span class="n">summary_net_ecg</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ecg_amortizer&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>The final bit of preparation before training is to configure prior draws and simulation data for training.</p>
<p>Up to three steps are typically required: 1) Reshaping the simulation data. CNNs require inputs of the shape (batch size, signal length, number of channels), i.e. (batch size, signal length, 1) in our case. 2) Casting to single-precision float. If a GPU is available, it will speed up training immensely, and GPUs typically have much more processing power for single-precision float numbers (float32). 3) Normalizing. Both passing through and updating a neural network repeatedly involves
matrix-vector multiplication, and entries of vastly different size make this operation notoriously ill-conditioned. For the simulation data, this can lead to vanishing or exploding gradients during training, and for the parameters, it can cause much greater uncertainty in the predicted posterior distributions.</p>
<p>The first two steps are carried out below largely as-is.</p>
<p>Normalization is a little less obvious. Since our model already includes a normalizing step for the simulated data (constraining the simulated ECG signal to the range between -0.4 and +1.2 Hz), we do not need to add another one here. We do, however, need to normalize our priors so that they jointly have mean 0 and variance 1. To do so, we must first compute their unnormalized means and stds:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prior_means</span><span class="p">,</span> <span class="n">prior_stds</span> <span class="o">=</span> <span class="n">prior_ecg</span><span class="o">.</span><span class="n">estimate_means_and_stds</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">configurator_ecg</span><span class="p">(</span><span class="n">forward_dict</span><span class="p">):</span>
    <span class="c1"># Prepare placeholder dict</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Reshape data to (batch size, signal length, 1) and cast data to float32</span>
    <span class="c1"># GPUs are optimized for float32 computations, and convolutional NN require</span>
    <span class="c1"># the number of channels as a third dimension - this is 1 for the ECG signal</span>
    <span class="n">simdata</span> <span class="o">=</span> <span class="n">forward_dict</span><span class="p">[</span><span class="s1">&#39;sim_data&#39;</span><span class="p">]</span>
    <span class="n">simdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">simdata</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">flt32data</span> <span class="o">=</span> <span class="n">simdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Cast parameters to float32</span>
    <span class="c1">### (Extract prior draws and z-standardize with previously computed means)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">forward_dict</span><span class="p">[</span><span class="s1">&#39;prior_draws&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span> <span class="o">-</span> <span class="n">prior_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">prior_stds</span>

    <span class="c1"># Add to keys</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;summary_conditions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">flt32data</span><span class="c1">#[idx_keep]</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="c1">#[idx_keep]</span>

    <span class="k">return</span> <span class="n">out_dict</span>
</pre></div>
</div>
</div>
</section>
<section id="4.-Training-and-Evaluation">
<h1>4. Training and Evaluation<a class="headerlink" href="#4.-Training-and-Evaluation" title="Permalink to this heading"></a></h1>
<p>With our AmortizedPosterior, GenerativeModel and Configurator, we are now ready to create a trainer instance. Doing so before starting the actual training results in a small test run to ensure that all components are consistent with one another:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">optional_stopping_kwargs</span> <span class="o">=</span> <span class="p">{</span>
<span class="c1">#&#39;period&#39;: 4000,</span>
<span class="s1">&#39;patience&#39;</span><span class="p">:</span> <span class="n">patience</span><span class="p">,</span>
<span class="c1">#&#39;tolerance&#39;: -0.01,</span>
<span class="c1">#&#39;cooldown_factor&#39;: 1,</span>
<span class="c1">#&#39;reduction_factor&#39;: 0.5,</span>
<span class="c1">#&#39;num_resets&#39;: 8</span>
<span class="p">}</span>

<span class="n">trainer_ecg</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">amortizer</span><span class="o">=</span><span class="n">amortizer_ecg</span><span class="p">,</span>
                            <span class="n">generative_model</span><span class="o">=</span><span class="n">model_ecg</span><span class="p">,</span>
                            <span class="n">configurator</span><span class="o">=</span><span class="n">configurator_ecg</span><span class="p">,</span>
                            <span class="n">checkpoint_path</span><span class="o">=</span><span class="n">checkpoint_path</span><span class="p">,</span>
                            <span class="n">clip_method</span><span class="o">=</span><span class="s1">&#39;norm&#39;</span><span class="p">,</span>
                            <span class="n">clip_value</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                            <span class="n">learning_rate</span> <span class="o">=</span> <span class="n">initial_lr</span><span class="p">,</span>
                            <span class="n">optional_stopping_kwargs</span><span class="o">=</span><span class="n">optional_stopping_kwargs</span><span class="p">,</span>
                            <span class="n">optional_stopping</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># trainer_ecg = Trainer(amortizer=amortizer_ecg, generative_model=model_ecg, configurator=configurator_ecg,</span>
<span class="c1">#                      checkpoint_path = checkpoint_path)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Loaded loss history from checkpoints_Oct31_2/history_13.pkl
INFO:root:Loaded simulation memory from checkpoints_Oct31_2/memory.pkl
INFO:root:Loaded RegressionLRAdjuster from checkpoints_Oct31_2/lradjuster.pkl
INFO:root:Networks loaded from checkpoints_Oct31_2/ckpt-13
INFO:root:Performing a consistency check with provided components...
INFO:root:Done.
</pre></div></div>
</div>
<p>Instantiating the Trainer above caused the BayesFlow model to actually be built. We are now in a position to look at some statistics about our architecture:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">amortizer_ecg</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Model: &#34;ecg_amortizer&#34;
_________________________________________________________________
Layer (type)                 Output Shape              Param #
=================================================================
invertible_network (Invertib multiple                  305968
_________________________________________________________________
cnn_ecg (CNN_ecg)            multiple                  726517
=================================================================
Total params: 1,032,485
Trainable params: 1,028,117
Non-trainable params: 4,368
_________________________________________________________________
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#trainer_ecg.train_online(epochs=1,batch_size=64,iterations_per_epoch=2)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Training epoch 1:   0%|                                   | 0/2 [00:00&lt;?, ?it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING:tensorflow:AutoGraph could not transform &lt;bound method SpectralNormalization.normalize_weights of &lt;bayesflow.wrappers.SpectralNormalization object at 0x7f5eaa5dcf70&gt;&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: module &#39;gast&#39; has no attribute &#39;Index&#39;
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
WARNING:tensorflow:AutoGraph could not transform &lt;bound method SpectralNormalization.normalize_weights of &lt;bayesflow.wrappers.SpectralNormalization object at 0x7f5eaa5dcf70&gt;&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: module &#39;gast&#39; has no attribute &#39;Index&#39;
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
WARNING: AutoGraph could not transform &lt;bound method SpectralNormalization.normalize_weights of &lt;bayesflow.wrappers.SpectralNormalization object at 0x7f5eaa5dcf70&gt;&gt; and will run it as-is.
Please report this to the TensorFlow team. When filing the bug, set the verbosity to 10 (on Linux, `export AUTOGRAPH_VERBOSITY=10`) and attach the full output.
Cause: module &#39;gast&#39; has no attribute &#39;Index&#39;
To silence this warning, decorate the function with @tf.autograph.experimental.do_not_convert
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
Training epoch 1:  50%|▌| 1/2 [00:02&lt;00:02,  2.45s/it, Epoch: 1, Iter: 1,Loss: -/tmp/ipykernel_22237/3223817925.py:73: RuntimeWarning: divide by zero encountered in true_divide
  z += d[i]*np.exp(-(delta_theta(x,y,theta[i]))**2 / (2*b[i]*b[i]))
Training epoch 1: 100%|█| 2/2 [00:04&lt;00:00,  2.02s/it, Epoch: 1, Iter: 2,Loss: -
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Default.Loss</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>15.603333</td>
    </tr>
    <tr>
      <th>1</th>
      <td>11.139843</td>
    </tr>
    <tr>
      <th>2</th>
      <td>11.152058</td>
    </tr>
    <tr>
      <th>3</th>
      <td>11.599173</td>
    </tr>
    <tr>
      <th>4</th>
      <td>11.343264</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th>11001</th>
      <td>-4.808593</td>
    </tr>
    <tr>
      <th>11002</th>
      <td>-3.759671</td>
    </tr>
    <tr>
      <th>11003</th>
      <td>-3.010377</td>
    </tr>
    <tr>
      <th>11004</th>
      <td>-2.188667</td>
    </tr>
    <tr>
      <th>11005</th>
      <td>-3.503876</td>
    </tr>
  </tbody>
</table>
<p>11006 rows × 1 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">losses</span> <span class="o">=</span> <span class="n">trainer_ecg</span><span class="o">.</span><span class="n">loss_history</span><span class="o">.</span><span class="n">get_plottable</span><span class="p">()</span>
<span class="n">stepsize</span><span class="o">=</span> <span class="mi">1000</span>
<span class="c1">#for i in range(int(15000/stepsize)):</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">80000</span><span class="o">/</span><span class="n">stepsize</span><span class="p">)):</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">diag</span><span class="o">.</span><span class="n">plot_losses</span><span class="p">(</span><span class="n">losses</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">stepsize</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">stepsize</span><span class="p">])</span>

<span class="c1"># LR adjustments triggered at 4979 its, 7349 its, 13169 its and 15410 its (=stop)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/rene/Bf_ecg/BayesFlow/bayesflow/diagnostics.py:525: RuntimeWarning: More than 20 figures have been opened. Figures created through the pyplot interface (`matplotlib.pyplot.figure`) are retained until explicitly closed and may consume too much memory. (To control this warning, see the rcParam `figure.max_open_warning`).
  f, axarr = plt.subplots(n_row, 1, figsize=fig_size)
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_1.png" src="../_images/tutorial_notebooks_ECG_Model_73_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_2.png" src="../_images/tutorial_notebooks_ECG_Model_73_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_3.png" src="../_images/tutorial_notebooks_ECG_Model_73_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_4.png" src="../_images/tutorial_notebooks_ECG_Model_73_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_5.png" src="../_images/tutorial_notebooks_ECG_Model_73_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_6.png" src="../_images/tutorial_notebooks_ECG_Model_73_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_7.png" src="../_images/tutorial_notebooks_ECG_Model_73_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_8.png" src="../_images/tutorial_notebooks_ECG_Model_73_8.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_9.png" src="../_images/tutorial_notebooks_ECG_Model_73_9.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_10.png" src="../_images/tutorial_notebooks_ECG_Model_73_10.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_11.png" src="../_images/tutorial_notebooks_ECG_Model_73_11.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_12.png" src="../_images/tutorial_notebooks_ECG_Model_73_12.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_13.png" src="../_images/tutorial_notebooks_ECG_Model_73_13.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_14.png" src="../_images/tutorial_notebooks_ECG_Model_73_14.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_15.png" src="../_images/tutorial_notebooks_ECG_Model_73_15.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_16.png" src="../_images/tutorial_notebooks_ECG_Model_73_16.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_17.png" src="../_images/tutorial_notebooks_ECG_Model_73_17.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_18.png" src="../_images/tutorial_notebooks_ECG_Model_73_18.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_19.png" src="../_images/tutorial_notebooks_ECG_Model_73_19.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_20.png" src="../_images/tutorial_notebooks_ECG_Model_73_20.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_21.png" src="../_images/tutorial_notebooks_ECG_Model_73_21.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_22.png" src="../_images/tutorial_notebooks_ECG_Model_73_22.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_23.png" src="../_images/tutorial_notebooks_ECG_Model_73_23.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_24.png" src="../_images/tutorial_notebooks_ECG_Model_73_24.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_25.png" src="../_images/tutorial_notebooks_ECG_Model_73_25.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_26.png" src="../_images/tutorial_notebooks_ECG_Model_73_26.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_27.png" src="../_images/tutorial_notebooks_ECG_Model_73_27.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_28.png" src="../_images/tutorial_notebooks_ECG_Model_73_28.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_29.png" src="../_images/tutorial_notebooks_ECG_Model_73_29.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_30.png" src="../_images/tutorial_notebooks_ECG_Model_73_30.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_31.png" src="../_images/tutorial_notebooks_ECG_Model_73_31.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_32.png" src="../_images/tutorial_notebooks_ECG_Model_73_32.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_33.png" src="../_images/tutorial_notebooks_ECG_Model_73_33.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_34.png" src="../_images/tutorial_notebooks_ECG_Model_73_34.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_35.png" src="../_images/tutorial_notebooks_ECG_Model_73_35.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_36.png" src="../_images/tutorial_notebooks_ECG_Model_73_36.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_37.png" src="../_images/tutorial_notebooks_ECG_Model_73_37.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_38.png" src="../_images/tutorial_notebooks_ECG_Model_73_38.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_39.png" src="../_images/tutorial_notebooks_ECG_Model_73_39.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_40.png" src="../_images/tutorial_notebooks_ECG_Model_73_40.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_41.png" src="../_images/tutorial_notebooks_ECG_Model_73_41.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_42.png" src="../_images/tutorial_notebooks_ECG_Model_73_42.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_43.png" src="../_images/tutorial_notebooks_ECG_Model_73_43.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_44.png" src="../_images/tutorial_notebooks_ECG_Model_73_44.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_45.png" src="../_images/tutorial_notebooks_ECG_Model_73_45.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_46.png" src="../_images/tutorial_notebooks_ECG_Model_73_46.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_47.png" src="../_images/tutorial_notebooks_ECG_Model_73_47.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_48.png" src="../_images/tutorial_notebooks_ECG_Model_73_48.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_49.png" src="../_images/tutorial_notebooks_ECG_Model_73_49.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_50.png" src="../_images/tutorial_notebooks_ECG_Model_73_50.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_51.png" src="../_images/tutorial_notebooks_ECG_Model_73_51.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_52.png" src="../_images/tutorial_notebooks_ECG_Model_73_52.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_53.png" src="../_images/tutorial_notebooks_ECG_Model_73_53.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_54.png" src="../_images/tutorial_notebooks_ECG_Model_73_54.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_55.png" src="../_images/tutorial_notebooks_ECG_Model_73_55.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_56.png" src="../_images/tutorial_notebooks_ECG_Model_73_56.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_57.png" src="../_images/tutorial_notebooks_ECG_Model_73_57.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_58.png" src="../_images/tutorial_notebooks_ECG_Model_73_58.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_59.png" src="../_images/tutorial_notebooks_ECG_Model_73_59.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_60.png" src="../_images/tutorial_notebooks_ECG_Model_73_60.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_61.png" src="../_images/tutorial_notebooks_ECG_Model_73_61.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_62.png" src="../_images/tutorial_notebooks_ECG_Model_73_62.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_63.png" src="../_images/tutorial_notebooks_ECG_Model_73_63.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_64.png" src="../_images/tutorial_notebooks_ECG_Model_73_64.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_65.png" src="../_images/tutorial_notebooks_ECG_Model_73_65.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_66.png" src="../_images/tutorial_notebooks_ECG_Model_73_66.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_67.png" src="../_images/tutorial_notebooks_ECG_Model_73_67.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_68.png" src="../_images/tutorial_notebooks_ECG_Model_73_68.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_69.png" src="../_images/tutorial_notebooks_ECG_Model_73_69.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_70.png" src="../_images/tutorial_notebooks_ECG_Model_73_70.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_71.png" src="../_images/tutorial_notebooks_ECG_Model_73_71.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_72.png" src="../_images/tutorial_notebooks_ECG_Model_73_72.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_73.png" src="../_images/tutorial_notebooks_ECG_Model_73_73.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_74.png" src="../_images/tutorial_notebooks_ECG_Model_73_74.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_75.png" src="../_images/tutorial_notebooks_ECG_Model_73_75.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_76.png" src="../_images/tutorial_notebooks_ECG_Model_73_76.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_77.png" src="../_images/tutorial_notebooks_ECG_Model_73_77.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_78.png" src="../_images/tutorial_notebooks_ECG_Model_73_78.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_79.png" src="../_images/tutorial_notebooks_ECG_Model_73_79.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_73_80.png" src="../_images/tutorial_notebooks_ECG_Model_73_80.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[55]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">diag</span><span class="o">.</span><span class="n">plot_losses</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_74_0.png" src="../_images/tutorial_notebooks_ECG_Model_74_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[56]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#fig_2 = trainer_ecg.diagnose_latent2d()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[57]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#fig_3 = trainer_ecg.diagnose_sbc_histograms()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[58]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># g, axarr2 = plt.subplots(7, 7, figsize=(20, 10))</span>

<span class="c1"># for ax in axarr2.flat:</span>
<span class="c1">#     q = trainer_ecg.configurator(model_ecg(batch_size=1))</span>
<span class="c1">#     p = amortizer_ecg.sample(q, n_samples=1)</span>
<span class="c1">#     y = model_ecg.simulator(p)[&#39;sim_data&#39;][0]</span>
<span class="c1">#     ax.plot(y)</span>
<span class="c1"># g.tight_layout()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[78]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">valid_sim_data_raw</span> <span class="o">=</span> <span class="n">model_ecg</span><span class="p">(</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="c1">#valid_sim_data_raw = model_ecg(batch_size=1000)</span>
<span class="n">valid_sim_data</span> <span class="o">=</span> <span class="n">trainer_ecg</span><span class="o">.</span><span class="n">configurator</span><span class="p">(</span><span class="n">valid_sim_data_raw</span><span class="p">)</span>
<span class="n">posterior_samples</span> <span class="o">=</span> <span class="n">amortizer_ecg</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">valid_sim_data</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="c1">#posterior_samples = amortizer_ecg.sample(valid_sim_data, n_samples=300)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">diag</span><span class="o">.</span><span class="n">plot_sbc_ecdf</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">,</span> <span class="n">valid_sim_data</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">],</span> <span class="n">param_names</span><span class="o">=</span><span class="n">prior_ecg</span><span class="o">.</span><span class="n">param_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/tmp/ipykernel_15089/3223817925.py:73: RuntimeWarning: divide by zero encountered in true_divide
  z += d[i]*np.exp(-(delta_theta(x,y,theta[i]))**2 / (2*b[i]*b[i]))
2022-11-02 15:12:27.285046: W tensorflow/core/framework/cpu_allocator_impl.cc:80] Allocation of 750000000 exceeds 10% of free system memory.
2022-11-02 15:12:27.396186: W tensorflow/core/framework/cpu_allocator_impl.cc:80] Allocation of 750000000 exceeds 10% of free system memory.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_78_1.png" src="../_images/tutorial_notebooks_ECG_Model_78_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[79]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">diag</span><span class="o">.</span><span class="n">plot_recovery</span><span class="p">(</span><span class="n">posterior_samples</span><span class="p">,</span> <span class="n">valid_sim_data</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">],</span> <span class="n">param_names</span><span class="o">=</span><span class="n">prior_ecg</span><span class="o">.</span><span class="n">param_names</span><span class="p">,</span> <span class="n">n_col</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_79_0.png" src="../_images/tutorial_notebooks_ECG_Model_79_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[61]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_samples_unnorm</span> <span class="o">=</span> <span class="n">prior_means</span> <span class="o">+</span> <span class="n">posterior_samples</span> <span class="o">*</span> <span class="n">prior_stds</span>
<span class="c1">#fig = diag.plot_posterior_2d(posterior_samples_unnorm[0], param_names=prior_ecg.param_names)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[62]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#fig = diag.plot_posterior_2d(posterior_samples_unnorm[0], prior=prior_ecg)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[63]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2500</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resim</span> <span class="o">=</span> <span class="n">simulate_batch</span><span class="p">(</span><span class="n">posterior_samples_unnorm</span><span class="p">[</span><span class="n">i</span><span class="p">,:],</span> <span class="n">params_model</span><span class="p">,</span> <span class="n">params_sim</span><span class="p">,</span> <span class="n">param_list</span><span class="p">,</span> <span class="n">baseline_wander</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Resimulation </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>

    <span class="c1"># compute quantiles</span>
    <span class="n">qt_50</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">resim</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">qt_90</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">resim</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">[</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">qt_95</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">resim</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="p">[</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># plot</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">resim</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Median ECG&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">valid_sim_data_raw</span><span class="p">[</span><span class="s1">&#39;sim_data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Ground truth&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">qt_50</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qt_50</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;50% CI&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">qt_90</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qt_90</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;90% CI&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">qt_95</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">qt_95</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95% CI&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Re-simulation for ECG&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time t [s]&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;ECG Signal&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># for i in range(10):</span>
<span class="c1">#     resim = simulate_one(posterior_samples_unnorm[0,i], params_model, params_sim, param_list, baseline_wander=False)</span>

<span class="c1">#     # plot</span>
<span class="c1">#     fig, ax = plt.subplots(1, 1, figsize=(15, 10))</span>
<span class="c1">#     ax.plot(time_points, resim, label=&#39;Resimulated ECG&#39;, color=&#39;b&#39;)</span>
<span class="c1">#     ax.plot(time_points, valid_sim_data_raw[&#39;sim_data&#39;][0, :], marker=&#39;o&#39;, label=&#39;Ground truth&#39;, color=&#39;k&#39;, linestyle=&#39;--&#39;, alpha=0.8)</span>
<span class="c1">#     ax.set_title(&quot;Re-simulation for ECG&quot;)</span>
<span class="c1">#     ax.set_xlabel(&quot;Time t [s]&quot;)</span>
<span class="c1">#     ax.set_ylabel(&quot;ECG Signal&quot;)</span>
<span class="c1">#     ax.legend()</span>
<span class="c1">#     plt.show()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Resimulation 0:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_82_1.png" src="../_images/tutorial_notebooks_ECG_Model_82_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Resimulation 1:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_82_3.png" src="../_images/tutorial_notebooks_ECG_Model_82_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Resimulation 2:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_82_5.png" src="../_images/tutorial_notebooks_ECG_Model_82_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Resimulation 3:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_82_7.png" src="../_images/tutorial_notebooks_ECG_Model_82_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Resimulation 4:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_82_9.png" src="../_images/tutorial_notebooks_ECG_Model_82_9.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Resimulation 5:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_82_11.png" src="../_images/tutorial_notebooks_ECG_Model_82_11.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Resimulation 6:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_82_13.png" src="../_images/tutorial_notebooks_ECG_Model_82_13.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Resimulation 7:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_82_15.png" src="../_images/tutorial_notebooks_ECG_Model_82_15.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Resimulation 8:
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_82_17.png" src="../_images/tutorial_notebooks_ECG_Model_82_17.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

 Resimulation 9:
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_ECG_Model_82_19.png" src="../_images/tutorial_notebooks_ECG_Model_82_19.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[64]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Offene Fragen</span>
<span class="c1"># 1. Welche Parameter sollten variiert werdden (b,theta,a,f_2, Simulation)?</span>
<span class="c1"># 2. Wie sollte variiert werden (Verteilung, Streuung)?</span>
<span class="c1"># Ziel: Zunächst einmal gesunde Fälle priorisieren. Ggf. mehrere Modelle nutzen (unterschiedliche Pathologien)</span>
<span class="c1"># -&gt; Model selection</span>
<span class="c1"># Einheit für Periode gleich halten (gleiche Zeitschrittgröße); Signallänge (/Anzahl der Perioden)</span>
<span class="c1"># erstmal fix mit CNN, dann mit LSTM variabel</span>

<span class="c1"># Weiß man, wie hoch die Rauschamplitude ist? Wenn ja, als Parameter an das NN übergeben</span>

<span class="c1"># Kalibrierungsproblemerklärung: zu wenig trainiert, zu kleines Netz</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[65]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># 1. Adjustable learning rate stärker parametrisierbar (u. an-/abstellbar) machen? (Aktuell zu frühes Stoppen)</span>
<span class="c1"># -&gt; Aktuelle Fassung von letzter Woche testen!</span>

<span class="c1"># 2. Debugging/Fehlersuche wenn das Modell rät (true vs. estimated horizontal)? Workflow?</span>
<span class="c1"># -&gt; Korrelation +/-1 zwischen Komponenten</span>
<span class="c1"># -&gt; Info-Verlust im Modell?</span>
<span class="c1"># -&gt; PyABC direkt auf Summary Statistic (Vorsicht, langsam!)</span>
<span class="c1"># -&gt; LSTM 500 hidden units für 4-5 Parameter (erst als Regression ohne BayesFlow testen, dann als</span>
<span class="c1"># Summary Net nutzen)</span>
<span class="c1"># -&gt; unter der Voraussetzung guter Ergebnisse: pre-trained networks verwenden</span>
<span class="c1"># -&gt; Trainings-Tempo: ein paar Tausend Simulationen sollten aussagekräftige Trends liefern</span>
<span class="c1"># -&gt; Diagnostik mittels true vs estimated: ggf. Median statt Mittelwert testen</span>

<span class="c1"># 3. Summary net: Wahl von n_summary? Größe und Art des Netzes (in Relation zu n_summary/dem Problem)?</span>
<span class="c1"># -&gt; &gt;= Anzahl params (e.g. x4)</span>
<span class="c1"># -&gt; PCA des summary space (-&gt; überparametrisierter latent space erkennen (Detecting Model Misspecification ... arXiv 2021 (Radev last)))</span>

<span class="c1"># 4. Preprocessing (ja/nein, wenn ja was)?</span>
<span class="c1"># -&gt; Fokus auf over-/underflow vermeiden (Skalierung)</span>
<span class="c1"># -&gt; einzelner Herzschlag ggf unterinformativ</span>
<span class="c1"># -&gt; Downsampling</span>
<span class="c1"># -&gt; Transformation (e.g. Fourier)</span>

<span class="c1"># 5. Nutzung von Kontext-Informationen? (Hilfreich? Wenn ja, wie?)</span>
<span class="c1"># -&gt; z.B. sampling frequency</span>
<span class="c1"># -&gt; Nützlich, wenn sich Kontext verändert (z.B. zwei verschiedene sampling frequencies je nach Batch)</span>

<span class="c1"># 6. Offline-Training ohne dass Memory ausgeht</span>
<span class="c1"># -&gt; Loop über Training; ggf Simulationdataset helper_class anpassen</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[66]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Zeitabhängige Parameter: erst omega, dann ggf weitere (wirft auch Fragen zu Priors auf) -&gt; super statistics</span>
<span class="c1"># Vergleich: segmentiertes Signal ohne super statistics vs. Gesamtsignal mit</span>
<span class="c1"># Ggf. anderes Fit-Verfahren als BayesFlow als Baseline (mechanical engineering?)</span>
<span class="c1"># Reale Daten -&gt; Simulation gap / model misspecification (später)</span>
<span class="c1"># Wunschliste:</span>
<span class="c1"># Prior-Veränderung günstig auffangen</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[67]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Fragen</span>
<span class="c1"># 1. Es gibt keine Prior aus der Literatur. Lohnt es sich, empirisch welche zu bauen? (Konkret: reale Daten</span>
<span class="c1">#    mit den Parametern fitten)</span>
<span class="c1"># 2. Ist es sinnvoll, das komplett triviale Problem (keine Basislinien-Wanderung) als Startpunkt zu wählen?</span>
<span class="c1">#    (Stichwort: Simulationsgeschwindigkeit)</span>
<span class="c1"># 3. Im aktuellen Modell sind die Veränderungen zu gering. Sollte man die Herzfrequenz (erheblich) breiter</span>
<span class="c1">#    streuen lassen? Wenn ja, was für Verteilungen eignen sich? Sollte man auf der Basis von Prof. Hessers</span>
<span class="c1">#    Vorgaben auch die anderen Parameter breiter streuen und dann rejection sampling betreiben (Zitat:</span>
<span class="c1">#    &quot;Wichtig ist, dass die R-Zacke immer viel größer ist als die P und T-Wellen und dass sie auch</span>
<span class="c1">#    viel schmäler ist.&quot;)?</span>



<span class="c1"># 1. Daten fitten, Marginalverteilung der Posterior über Daten lernen</span>
<span class="c1"># = neuer Prior</span>
<span class="c1"># Iterate until prior converges (SMPT)</span>
<span class="c1"># &quot;Neuro-empirical Bayes&quot; -&gt; jetzt Prior-</span>

<span class="c1"># Prior setzen</span>
<span class="c1"># BF trainieren mit Prior</span>
<span class="c1"># Inferenz mit realen Daten</span>
<span class="c1"># Sample zu realen Daten Posterior</span>
<span class="c1"># Trainiere INN auf Posterior Samples</span>
<span class="c1"># (neuer Prior: entweder fit über Punkte mit Gauss oder so oder INN)</span>
<span class="c1"># Wiederholen</span>
<span class="c1"># Ggf. als Baseline: naives Fitting der realen Daten</span>

<span class="c1"># 3. Um überhaupt BF trainieren zu können, 3. umsetzen.</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[68]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#min_shifted = 0</span>
<span class="c1">#mean_shifted = 25</span>
<span class="c1">#max_shifted = 160</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[69]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">naive_error</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="mi">40</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">65</span><span class="p">]):</span>
    <span class="n">integrand</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="n">targets</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">lower_int</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">targets</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">targets</span><span class="p">[</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">upper_int</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="n">integrand</span><span class="p">,</span> <span class="n">targets</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">targets</span><span class="p">[</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">lower_int</span><span class="o">-</span><span class="n">upper_int</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
<span class="c1">#     y_target = scipy.stats.lognorm.pdf(targets, s=params[0], loc=targets[1], scale=params[1])</span>
<span class="c1">#     x_general = np.linspace(0, targets[1]+50, 1000)</span>
<span class="c1">#     y_general = scipy.stats.lognorm.pdf(x_general, s=params[0], loc=targets[1], scale=params[1])</span>
<span class="c1">#     y_max = max(y_general)</span>
<span class="c1">#     return y_target[0]**2 + y_target[1]**2</span>

<span class="k">def</span> <span class="nf">fit_naively</span><span class="p">(</span><span class="n">x_min</span><span class="p">,</span> <span class="n">x_max</span><span class="p">,</span> <span class="n">x_mean</span><span class="p">):</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">fun</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">naive_error</span><span class="p">,</span><span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">x_min</span><span class="p">,</span><span class="n">x_max</span><span class="p">,</span><span class="n">x_mean</span><span class="p">]),</span><span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span>

<span class="c1">#opt = fit_naively(40, 200, 65)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[70]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># x = np.linspace(-250,250,1000)</span>
<span class="c1"># y = scipy.stats.lognorm.pdf(x, s=sol[0], loc=65, scale=sol[1])</span>
<span class="c1"># fig_2d = plt.figure(figsize=(10,8))</span>
<span class="c1"># ax_2d = plt.axes()</span>
<span class="c1"># ax_2d.plot(x,y)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[71]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">lnormpar</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">xn</span><span class="p">,</span> <span class="n">xbar</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">fun</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">nll</span><span class="p">,</span><span class="n">x1</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span><span class="n">xn</span><span class="o">=</span><span class="n">xn</span><span class="p">,</span><span class="n">xbar</span><span class="o">=</span><span class="n">xbar</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">opt</span>

<span class="k">def</span> <span class="nf">nll</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">xn</span><span class="p">,</span><span class="n">xbar</span><span class="p">,</span><span class="n">n</span><span class="p">):</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x1</span><span class="p">)</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">xn</span><span class="p">)</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span>
    <span class="c1"># mean and variance of (x_1,x_n)-truncated lognormal</span>
    <span class="n">dnorm</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">logpdf</span>
    <span class="n">pnorm</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span>
    <span class="n">dlnorm</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">logpdf</span>
    <span class="n">plnorm</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">cdf</span>

    <span class="n">mu1_trunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span> <span class="p">(</span><span class="n">pnorm</span><span class="p">(</span><span class="n">z2</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">-</span> <span class="n">pnorm</span><span class="p">(</span><span class="n">z1</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">pnorm</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pnorm</span><span class="p">(</span><span class="n">z1</span><span class="p">))</span>
    <span class="n">mu2_trunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">mu</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">pnorm</span><span class="p">(</span><span class="n">z2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="p">)</span> <span class="o">-</span> <span class="n">pnorm</span><span class="p">(</span><span class="n">z1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">pnorm</span><span class="p">(</span><span class="n">z2</span><span class="p">)</span> <span class="o">-</span> <span class="n">pnorm</span><span class="p">(</span><span class="n">z1</span><span class="p">))</span>
    <span class="n">var_trunc</span> <span class="o">=</span> <span class="n">mu2_trunc</span> <span class="o">-</span> <span class="n">mu1_trunc</span><span class="o">**</span><span class="mi">2</span>
    <span class="c1"># joint density of x1, xn, xbar</span>
    <span class="n">ll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dlnorm</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span><span class="n">xn</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">plnorm</span><span class="p">(</span><span class="n">xn</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">)</span>\
        <span class="o">-</span> <span class="n">plnorm</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">))</span> <span class="o">+</span> <span class="n">dnorm</span><span class="p">(</span><span class="n">xbar</span><span class="p">,</span> <span class="p">(</span><span class="n">x1</span> <span class="o">+</span> <span class="n">xn</span> <span class="o">+</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">mu1_trunc</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_trunc</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="o">-</span><span class="n">ll</span>

<span class="c1">#results = lnormpar(x1=100,xn=10000,xbar=1000,n=10)</span>

<span class="c1">#   # maximise the log likelihood</span>
<span class="c1">#   opt &lt;- optim(start, nll, hessian=TRUE)</span>
<span class="c1">#   # extract parameter estimates</span>
<span class="c1">#   res &lt;- cbind(opt$par, sqrt(diag(solve(opt$hessian))))</span>
<span class="c1">#   rownames(res) &lt;- c(&quot;mu&quot;,&quot;sigma&quot;)</span>
<span class="c1">#   colnames(res) &lt;- c(&quot;Estimate&quot;,&quot;Std. Error&quot;)</span>
<span class="c1">#   res</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[72]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#x = np.linspace(0,5,1000)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[73]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># def heartrate_lognormal(batch_size):</span>
<span class="c1">#     sample_unscaled = scipy.stats.lognorm.rvs(s=1, loc=0, scale=3, size=batch_size)</span>
<span class="c1">#     return sample_unscaled*20+40</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[74]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># bla = heartrate_lognormal(50000)</span>
<span class="c1"># fig_2d = plt.figure(figsize=(8,6))</span>
<span class="c1"># ax_2d = plt.axes()</span>
<span class="c1"># ax_2d.set_xlim([0,500])</span>
<span class="c1"># plt.hist(bla, bins=1000)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[75]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># x = np.linspace(0,8,1000)</span>
<span class="c1"># y = scipy.stats.lognorm.pdf(x, s=0.75, loc=0, scale=1.5)</span>
<span class="c1"># fig_2d = plt.figure(figsize=(10,8))</span>
<span class="c1"># ax_2d = plt.axes()</span>
<span class="c1"># ax_2d.plot(x,y)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[76]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mu = 4.14</span>
<span class="c1"># sigma = 0.25</span>

<span class="c1"># mu_l = np.log(mu**2 / np.sqrt(mu**2 + sigma**2))</span>
<span class="c1"># sigma_l = np.sqrt(np.log(1 + (mu/sigma)**2))</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[77]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># period: 4000 (increased from 1k)</span>
<span class="c1"># tolerance: -0.01 (possibly shrunk)</span>
<span class="c1"># cooldown_factor: 1.5 (reduced from 2 to fit period size)</span>
<span class="c1"># num_resets: 8</span>
<span class="c1"># reduction_factor: 0.5 ? 0.25?</span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Stefan T. Radev.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

</body>
</html>
