<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Defining the Generative Model &mdash; BayesFlow beta documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> BayesFlow
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">bayesflow</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">BayesFlow</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a></li>
      <li class="breadcrumb-item active">Defining the Generative Model</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorial_notebooks/PriorSensitivity_Covid19_Initial.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars and line breaks on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
    white-space: pre;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt .copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
.jp-RenderedHTMLCommon table,
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
.jp-RenderedHTMLCommon thead,
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
.jp-RenderedHTMLCommon tr,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon td,
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
.jp-RenderedHTMLCommon th,
div.rendered_html th {
  font-weight: bold;
}
.jp-RenderedHTMLCommon tbody tr:nth-child(odd),
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
.jp-RenderedHTMLCommon tbody tr:hover,
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;../../..&#39;</span><span class="p">)))</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bayesflow.forward_inference</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">bayesflow.amortized_inference</span> <span class="kn">import</span> <span class="n">AmortizedPosterior</span>
<span class="kn">from</span> <span class="nn">bayesflow.networks</span> <span class="kn">import</span> <span class="n">InvertibleNetwork</span><span class="p">,</span> <span class="n">InvariantNetwork</span>
<span class="kn">from</span> <span class="nn">bayesflow.trainers</span> <span class="kn">import</span> <span class="n">Trainer</span>
</pre></div>
</div>
</div>
<h1><p>Introduction</p>
</h1><p>In our <a class="reference internal" href="Covid19_Initial_Posterior_Estimation.html"><span class="doc">previous tutorial</span></a>, we saw how to perform amortized posterior estimation on the parameters of a compartmental model for disease outbreaks. In this tutorial, we will perform prior sensitivity analysis on our posterior inference using for the first time the <code class="docutils literal notranslate"><span class="pre">prior_batchable_context</span></code> quantity.</p>
<p>Assessing a model’s sensitivity can be quite challenging in Bayesian analysis, since it typically requires re-estimating the model multiple times on the same data. Naturally, such an approach scales poorly in scenarios where estimating a model even once is prohibitively slow. While problems of efficiency can be somewhat alleviated in the context of likelihood-based Bayesian inference using Markov chain Monte Carlo (MCMC), the computational burden of refitting models becomes even heavier in
simulation-based scenarios.</p>
<p>Both core quantities in Bayesian inference, namely, likelihood and prior, depend on some implicit context variables which are considered fixed and thus not further specified as explicit conditioning variables. Typical examples for prior context variables might be as simple as the prior scale (i.e., dispersion) of admissible parameter values or as complex as discrete sets of qualitative expert knowledge. Typical examples for likelihood context variables include various structural decisions
regarding the transformation or exogenous experimental factors, such as design matrices, indicator variables, or time scales. In the <code class="docutils literal notranslate"><span class="pre">BayesFlow</span></code> library, such factors are considered context and should be implemented via <code class="docutils literal notranslate"><span class="pre">ContextGenerator</span></code> instances. Both <code class="docutils literal notranslate"><span class="pre">Prior</span></code> and <code class="docutils literal notranslate"><span class="pre">Simulator</span></code> instances support context generators.</p>
<p>Why is sensitivity analysis important? Modelers might disagree regarding the right set of context variables. For instance, when modeling emerging pandemics, different experts might choose to incorporate different prior knowledge about unknown disease parameters in their analysis and thereby arrive at conflicting substantive conclusions based on the same data. Certainly, the sensitivity of Bayesian inference will depend on the interplay between various factors, such as the model family or the
amount of available data. However, in most real-world applications, this interplay is too complex to allow for a straightforward (analytical) calculation of sensitivity. Thus, it is often desirable to explicitly asses the sensitivity of Bayesian analysis to possible choices of context variables by varying the latter along reasonable dimensions and then quantifying the consequences for the resulting inference. It is this assessment that we will illustrate in this notebook.</p>
<section id="Defining-the-Generative-Model">
<h1>Defining the Generative Model<a class="headerlink" href="#Defining-the-Generative-Model" title="Permalink to this heading"></a></h1>
<p>We will use the exactly same compartmental model as implemented in our <a class="reference internal" href="Covid19_Initial_Posterior_Estimation.html"><span class="doc">previous tutorial</span></a>. Our underlying model distinguishes between susceptible, <span class="math notranslate nohighlight">\(S\)</span>, infected, <span class="math notranslate nohighlight">\(I\)</span>, and recovered, <span class="math notranslate nohighlight">\(R\)</span>, individuals with infection and recovery occurring at a constant transmission rate <span class="math notranslate nohighlight">\(\lambda\)</span> and constant recovery rate <span class="math notranslate nohighlight">\(\mu\)</span>, respectively. The model dynamics are governed by the following system of ODEs:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align}
    \frac{dS}{dt} &amp;= -\lambda\,\left(\frac{S\,I}{N}\right) \\
    \frac{dI}{dt} &amp;= \lambda\,\left(\frac{S\,I}{N}\right) - \mu\,I \\
    \frac{dR}{dt} &amp;= \mu\,I,
\end{align}\end{split}\]</div>
<p>with <span class="math notranslate nohighlight">\(N = S + I + R\)</span> denoting the total population size. For the purpose of forward inference (simulation), we will use a time step of <span class="math notranslate nohighlight">\(dt = 1\)</span>, corresponding to daily case reports. In addition to the ODE parameters <span class="math notranslate nohighlight">\(\lambda\)</span> and <span class="math notranslate nohighlight">\(\mu\)</span>, we consider a reporting delay parameter <span class="math notranslate nohighlight">\(L\)</span> and a dispersion parameter <span class="math notranslate nohighlight">\(\psi\)</span>, which affect the number of reported infected individuals via a negative binomial disttribution
(<a class="reference external" href="https://en.wikipedia.org/wiki/Negative_binomial_distribution">https://en.wikipedia.org/wiki/Negative_binomial_distribution</a>).</p>
<p>Let’s first define a global singleton for accessing the <code class="docutils literal notranslate"><span class="pre">numpy</span></code> random number generator:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RNG</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="mi">2022</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Prior">
<h2>Prior<a class="headerlink" href="#Prior" title="Permalink to this heading"></a></h2>
<p>Our prior is the same as in our <a class="reference internal" href="Covid19_Initial_Posterior_Estimation.html"><span class="doc">previous notebook</span></a>, with the difference of a new argument called <code class="docutils literal notranslate"><span class="pre">alpha</span></code>. What this argument does is to scale each marginal prior <span class="math notranslate nohighlight">\(j\)</span> in the following way <span class="math notranslate nohighlight">\(p(\theta_j) \rightarrow p(\theta_j)^{\alpha_j}\)</span>.</p>
<p>The above transformation is called power scaling and is descrtibed in more detial in the paper by Noa Kallioinen, Topi Paananen, Paul-Christian Bürkner, and Aki Vehtari:</p>
<p>Detecting and diagnosing prior and likelihood sensitivity with power-scaling (<a class="reference external" href="https://arxiv.org/abs/2107.14054">https://arxiv.org/abs/2107.14054</a>)</p>
<p>Essentially, the power scaling method expands or shrinks the prior pdf, thus assuming a sort of hierarchical prior with adaptive sharpness. However, differently to hierarchical Bayesian models, we will not estimate the hyerparameter <span class="math notranslate nohighlight">\(\alpha\)</span>, but probe our results with different values of <span class="math notranslate nohighlight">\(\alpha\)</span> in some meaningful range (here <span class="math notranslate nohighlight">\(\alpha \in [0.5 - 2]\)</span>). The neat trick is this: we will perform amortized prior sensitivity analysis. Instead of training one <code class="docutils literal notranslate"><span class="pre">AmortizedPosterior</span></code>,
we will include <span class="math notranslate nohighlight">\(\alpha\)</span> in the generative process and treat it as a context variable over which to amortize. This means, that the scaling factors will simply be concatednated with the outputs of the summary network and passed on to the inference network. In this way, upon convergence, we end up with an <span class="math notranslate nohighlight">\(\alpha\)</span>-aware inference network, which can yield a posterior for each <span class="math notranslate nohighlight">\(\alpha\)</span> we supply during inference.</p>
<section id="Context-Generator-Function">
<h3>Context Generator Function<a class="headerlink" href="#Context-Generator-Function" title="Permalink to this heading"></a></h3>
<p>During training, we will generate the scaling parameters from a continuous uniform distribution:</p>
<div class="math notranslate nohighlight">
\[\alpha_j \sim \mathcal{U}(0.5, 2)\]</div>
<p>In this way, the inference network will see both simulations with a narrower prior (<span class="math notranslate nohighlight">\(\alpha &gt; 1\)</span>) and a wider prior (<span class="math notranslate nohighlight">\(\alpha &lt; 1\)</span>) than our original prior choice (<span class="math notranslate nohighlight">\(\alpha = 1\)</span>).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">alpha_gen</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Generates power-scaling parameters from a uniform distribution.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">RNG</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Prior-Generator-Function">
<h3>Prior Generator Function<a class="headerlink" href="#Prior-Generator-Function" title="Permalink to this heading"></a></h3>
<p>We can now also define the function which will generate random draws from the prior. Notice the additional argument specifying the vector of <span class="math notranslate nohighlight">\(\alpha\)</span>-scaling parameters. Note also, that scaling different pdfs has different effect on the corresponding parametrs. For instance, performing power scaling on an <a class="reference external" href="https://en.wikipedia.org/wiki/Exponential_distribution">exponential</a> pdf simply means dividing it’s shape parameters by <span class="math notranslate nohighlight">\(\alpha\)</span>. Further examples are given in
<a class="reference external" href="https://arxiv.org/abs/2107.14054">https://arxiv.org/abs/2107.14054</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">model_prior</span><span class="p">(</span><span class="n">alpha</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Generates random draws from the prior given an alpha scaling parameter. Each marginal</span>
<span class="sd">    prior has its own scaling parameter. See the paper linked below for details:</span>

<span class="sd">    https://arxiv.org/abs/2107.14054</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">lambd</span> <span class="o">=</span> <span class="n">RNG</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">0.4</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">RNG</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">8</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="n">RNG</span><span class="o">.</span><span class="n">lognormal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">8</span><span class="p">),</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">)</span>
    <span class="n">I0</span> <span class="o">=</span> <span class="n">RNG</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">20</span><span class="o">/</span><span class="n">alpha</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">psi</span> <span class="o">=</span> <span class="n">RNG</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="mi">5</span><span class="o">/</span><span class="n">alpha</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lambd</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">psi</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Great! We can now connect the context generating function with the prior sampler using <code class="docutils literal notranslate"><span class="pre">BayesFlow</span></code> wrappers:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prior_context</span> <span class="o">=</span> <span class="n">ContextGenerator</span><span class="p">(</span><span class="n">batchable_context_fun</span><span class="o">=</span><span class="n">alpha_gen</span><span class="p">)</span>
<span class="n">prior</span> <span class="o">=</span> <span class="n">Prior</span><span class="p">(</span><span class="n">model_prior</span><span class="p">,</span> <span class="n">prior_context</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>When we now call the <code class="docutils literal notranslate"><span class="pre">Prior</span></code> object, we can see that the entry <code class="docutils literal notranslate"><span class="pre">batchable_context</span></code> in the output dictionary is filled with the scaling parameters used to generate each random draw. The context is dubbed batchable, because for each random draw from the prior in a batch of simulations, there is a corresponding context variable. In contrast, a <code class="docutils literal notranslate"><span class="pre">non_batchable_context</span></code> would be shared across all simulated quantities within a batch.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prior</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;prior_draws&#39;: array([[ 0.33610512,  0.12001227,  7.13881526, 60.35291708,  3.23956216],
        [ 0.50102922,  0.12348521, 10.08823068, 44.44636353,  0.85205942]]),
 &#39;batchable_context&#39;: [array([0.62513734, 1.17675062, 0.74885141, 0.50594303, 0.94169066]),
  array([1.33514958, 1.7993603 , 0.81417343, 1.2814965 , 1.25550107])],
 &#39;non_batchable_context&#39;: None}
</pre></div></div>
</div>
<p>Notice, that the context variables are returned as a <code class="docutils literal notranslate"><span class="pre">list</span></code> type. This is done in order to deal with cases where the context variables cannot be coerced to a rectangular array or tensor. Our <code class="docutils literal notranslate"><span class="pre">configurator</span></code> should take care of this!</p>
<p>During training, we will also standardize the prior draws, that is, ensure zero means and unit scale. We will do this purely for technical reasons - neural networks like scaled values. In addition, our current prior ranges differ vastly, so each parameter will contribute disproportionately to the loss function. Here, we will use the <code class="docutils literal notranslate"><span class="pre">estimate_means_and_stds()</span></code> method of a <code class="docutils literal notranslate"><span class="pre">Prior</span></code> instance, which will estimate the prior means and standard deviations from random draws. We could have also just
taken the analytic marginal means and standard deviations, but these may not be available in all settings (e.g., implicit priors).</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prior_means</span><span class="p">,</span> <span class="n">prior_stds</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">estimate_means_and_stds</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
</section>
<section id="Simulator-(Implicit-Likelihood-Function)">
<h2>Simulator (Implicit Likelihood Function)<a class="headerlink" href="#Simulator-(Implicit-Likelihood-Function)" title="Permalink to this heading"></a></h2>
<p>Our simulator remains unchanged from the one specified in our <a class="reference internal" href="Covid19_Initial_Posterior_Estimation.html"><span class="doc">previous notebook</span></a>:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">nbinom</span>

<span class="k">def</span> <span class="nf">convert_params</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Helper function to convert mean/dispersion parameterization of a negative binomial to N and p,</span>
<span class="sd">    as expected by numpy.</span>

<span class="sd">    See https://en.wikipedia.org/wiki/Negative_binomial_distribution#Alternative_formulations</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">phi</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">r</span> <span class="o">*</span> <span class="n">mu</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">var</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">var</span>
    <span class="k">return</span> <span class="n">r</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">p</span>

<span class="k">def</span> <span class="nf">stationary_SIR</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs a forward simulation from the stationary SIR model given a random draw from the prior,</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Extract parameters and round I0 and D</span>
    <span class="n">lambd</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">psi</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">I0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">I0</span><span class="p">)</span>
    <span class="n">D</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">D</span><span class="p">))</span>

    <span class="c1"># Initial conditions</span>
    <span class="n">S</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">R</span> <span class="o">=</span> <span class="p">[</span><span class="n">N</span><span class="o">-</span><span class="n">I0</span><span class="p">],</span> <span class="p">[</span><span class="n">I0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Reported new cases</span>
    <span class="n">C</span> <span class="o">=</span> <span class="p">[</span><span class="n">I0</span><span class="p">]</span>

    <span class="c1"># Simulate T-1 tiemsteps</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="n">D</span><span class="p">):</span>

        <span class="c1"># Calculate new cases</span>
        <span class="n">I_new</span> <span class="o">=</span> <span class="n">lambd</span> <span class="o">*</span> <span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">S</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>

        <span class="c1"># SIR equations</span>
        <span class="n">S_t</span> <span class="o">=</span> <span class="n">S</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">I_new</span>
        <span class="n">I_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">I</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">I_new</span> <span class="o">-</span> <span class="n">mu</span><span class="o">*</span><span class="n">I</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
        <span class="n">R_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">R</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mu</span><span class="o">*</span><span class="n">I</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>

        <span class="c1"># Track</span>
        <span class="n">S</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">S_t</span><span class="p">)</span>
        <span class="n">I</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I_t</span><span class="p">)</span>
        <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_t</span><span class="p">)</span>
        <span class="n">C</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">I_new</span><span class="p">)</span>

    <span class="n">reparam</span> <span class="o">=</span> <span class="n">convert_params</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">C</span><span class="p">[</span><span class="n">D</span><span class="p">:]),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="n">psi</span><span class="p">)</span>
    <span class="n">C_obs</span> <span class="o">=</span> <span class="n">RNG</span><span class="o">.</span><span class="n">negative_binomial</span><span class="p">(</span><span class="n">reparam</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reparam</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">C_obs</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</pre></div>
</div>
</div>
</section>
<section id="Loading-Real-Data">
<h2>Loading Real Data<a class="headerlink" href="#Loading-Real-Data" title="Permalink to this heading"></a></h2>
<p>We will define a simple helper function to load the actually reported cases for the first 2 weeks in Germany.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_data</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Helper function to load cumulative cases and transform them to new cases.&quot;&quot;&quot;</span>

    <span class="n">confirmed_cases_url</span> <span class="o">=</span> <span class="s1">&#39;https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_global.csv&#39;</span>
    <span class="n">confirmed_cases</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">confirmed_cases_url</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>

    <span class="n">date_data_begin</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">date_data_end</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2020</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">15</span><span class="p">)</span>
    <span class="n">format_date</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">date_py</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">/</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date_py</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">date_py</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                                     <span class="nb">str</span><span class="p">(</span><span class="n">date_py</span><span class="o">.</span><span class="n">year</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
    <span class="n">date_formatted_begin</span> <span class="o">=</span> <span class="n">format_date</span><span class="p">(</span><span class="n">date_data_begin</span><span class="p">)</span>
    <span class="n">date_formatted_end</span> <span class="o">=</span> <span class="n">format_date</span><span class="p">(</span><span class="n">date_data_end</span><span class="p">)</span>

    <span class="n">cases_obs</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="n">confirmed_cases</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">confirmed_cases</span><span class="p">[</span><span class="s2">&quot;Country/Region&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Germany&quot;</span><span class="p">,</span>
                            <span class="n">date_formatted_begin</span><span class="p">:</span><span class="n">date_formatted_end</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">new_cases_obs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cases_obs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_cases_obs</span>
</pre></div>
</div>
</div>
<p>Again, we can collect the simulator settings, together with the observed data, into a dictionary:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;T&#39;</span><span class="p">:</span> <span class="mi">14</span><span class="p">,</span>
    <span class="s1">&#39;N&#39;</span><span class="p">:</span> <span class="mf">83e6</span><span class="p">,</span>
    <span class="s1">&#39;obs_data&#39;</span><span class="p">:</span> <span class="n">load_data</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>And we now define our simulator as before, using fixed <span class="math notranslate nohighlight">\(T\)</span> and <span class="math notranslate nohighlight">\(N\)</span>. You already guessed this, that varying this variables will amount to nothing different than further context variables…</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">simulator</span> <span class="o">=</span> <span class="n">Simulator</span><span class="p">(</span>
    <span class="n">simulator_fun</span><span class="o">=</span><span class="n">partial</span><span class="p">(</span><span class="n">stationary_SIR</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">],</span> <span class="n">N</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;N&#39;</span><span class="p">])</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Generative-Model">
<h2>Generative Model<a class="headerlink" href="#Generative-Model" title="Permalink to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">GenerativeModel</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">simulator</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;alpha_covid_simulator&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Performing 2 pilot runs with the alpha_covid_simulator model...
INFO:root:Shape of parameter batch after 2 pilot simulations: (batch_size = 2, 5)
INFO:root:Shape of simulation batch after 2 pilot simulations: (batch_size = 2, 14, 1)
INFO:root:No optional prior non-batchable context provided.
INFO:root:Could not determine shape of prior batchable context. Type appears to be non-array: &lt;class &#39;list&#39;&gt;,                                    so make sure your input configurator takes cares of that!
INFO:root:No optional simulation non-batchable context provided.
INFO:root:No optional simulation batchable context provided.
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;prior_non_batchable_context&#39;: None,
 &#39;prior_batchable_context&#39;: [array([0.79273277, 1.19422818, 1.8356426 , 1.65536612, 1.66737236]),
  array([1.63899447, 0.78282046, 1.93784751, 0.52241938, 0.51631685]),
  array([1.57341413, 0.53056712, 1.95345   , 0.62165196, 0.88358885]),
  array([1.7735128 , 1.93760023, 1.26856752, 1.82266109, 1.35856702]),
  array([1.7642493 , 0.50893892, 1.36037249, 0.73453132, 1.4185381 ]),
  array([1.31400376, 0.52861479, 1.03784459, 0.78415361, 0.9818053 ]),
  array([0.9626923 , 1.79112886, 1.83302327, 0.51940978, 1.68399211]),
  array([1.38447241, 0.96412365, 1.95212989, 0.73187025, 1.39411552]),
  array([1.73864575, 0.86433807, 0.58017974, 1.66084845, 1.88251074]),
  array([0.50834923, 1.78449442, 1.10429682, 1.83873072, 1.28765027]),
  array([1.4612476 , 1.44064022, 1.05470228, 0.74205375, 1.89993871]),
  array([0.53692873, 1.7255384 , 1.34814899, 1.33890243, 1.66728212]),
  array([0.55507505, 1.91271914, 1.7601826 , 1.4366108 , 0.99143708]),
  array([1.7363727 , 1.94404746, 1.24606924, 1.64436361, 1.32605177]),
  array([1.19001474, 1.72364784, 0.7571364 , 0.51278269, 0.98517823]),
  array([0.70912082, 0.97846952, 0.97789085, 1.25335047, 1.71318018]),
  array([1.561133  , 1.81205325, 0.62117482, 0.76486556, 1.25085506]),
  array([0.9153956 , 1.34123268, 1.66536784, 1.18155245, 1.31185419]),
  array([1.58072607, 1.49153524, 1.02329835, 0.60158568, 1.26436594]),
  array([0.54885802, 1.93349388, 1.26269767, 0.80025799, 0.67018478]),
  array([0.65062283, 0.75510436, 1.56262499, 0.51539649, 1.50702123]),
  array([0.72655852, 1.60896135, 1.61539548, 1.35312166, 0.68479443]),
  array([0.82312277, 1.13805441, 1.4357591 , 0.60865695, 1.50138526]),
  array([0.67371253, 1.68551019, 0.50195836, 0.98952698, 1.10839255]),
  array([0.59616488, 0.87993009, 1.16696925, 1.1575394 , 1.52839044]),
  array([1.40925058, 0.76338648, 1.84697278, 1.79234631, 0.72216377]),
  array([0.71679982, 1.62121116, 1.98863156, 1.19901313, 0.68982972]),
  array([0.76622924, 1.09068599, 1.74265555, 0.85182953, 0.97659312]),
  array([1.23821346, 0.5883582 , 1.44357305, 1.62515295, 1.90535686]),
  array([1.50328286, 1.869089  , 0.54773477, 1.63725377, 0.88249361]),
  array([1.91966603, 0.84828301, 1.61642387, 0.73959121, 0.69404266]),
  array([1.61294399, 1.92870438, 0.56384108, 1.54334376, 1.44812709])],
 &#39;prior_draws&#39;: array([[4.64013552e-01, 1.86108103e-01, 6.40624525e+00, 2.60712680e+01,
         2.28771795e+00],
        [3.57316965e-01, 1.04070080e-01, 9.82143804e+00, 9.13290881e+00,
         2.78264920e+01],
        [3.98988532e-01, 1.47156776e-01, 7.97633507e+00, 5.86530716e+01,
         1.46262521e+01],
        [4.11281481e-01, 1.58254351e-01, 7.02923570e+00, 2.86856991e+01,
         1.29861493e+00],
        [2.66347542e-01, 1.11065110e-01, 8.85287956e+00, 1.60891672e+01,
         2.38097779e-01],
        [5.44546164e-01, 1.52254816e-01, 9.92608495e+00, 4.91941643e+01,
         3.98480767e+00],
        [2.42984414e-01, 1.36995535e-01, 7.18819983e+00, 1.17901976e+00,
         2.20802689e+00],
        [3.49357591e-01, 1.47552742e-01, 7.33676256e+00, 6.49177183e+01,
         1.69501168e+00],
        [4.60733215e-01, 1.26578025e-01, 6.83697731e+00, 1.08608620e+01,
         5.32095974e+00],
        [2.07239336e-01, 1.11499139e-01, 9.49131592e+00, 3.17556703e+01,
         4.00099726e+00],
        [4.57865951e-01, 1.43670491e-01, 8.19443426e+00, 2.76158553e+01,
         7.48902308e+00],
        [3.48766034e-01, 1.13697390e-01, 6.23146281e+00, 2.04618107e+01,
         1.96676654e+00],
        [4.47920298e-01, 9.33645322e-02, 6.73633681e+00, 2.34573019e+01,
         8.00400048e-01],
        [2.34712524e-01, 1.46690029e-01, 6.87645506e+00, 2.55977245e+01,
         5.62580242e-01],
        [4.20477921e-01, 1.65193158e-01, 7.33094183e+00, 9.54935679e+01,
         7.62615631e+00],
        [2.06968702e-01, 1.96726791e-01, 1.12803453e+01, 5.52843739e+01,
         7.16787017e-01],
        [2.57031500e-01, 1.11479484e-01, 6.04365037e+00, 8.21914859e+00,
         2.12034243e+00],
        [3.52434023e-01, 1.30163985e-01, 6.70672868e+00, 4.75099992e+01,
         2.47319798e+00],
        [4.39683711e-01, 1.18464173e-01, 9.06789380e+00, 1.07887112e+02,
         9.71049887e+00],
        [8.09018257e-01, 1.38853914e-01, 1.10543283e+01, 1.22983853e+01,
         2.03830325e+00],
        [3.71972370e-01, 1.18878471e-01, 9.78834669e+00, 4.90503186e+01,
         2.26918440e-01],
        [1.03141926e+00, 1.23849343e-01, 8.39898327e+00, 2.53016756e+01,
         2.44119811e-01],
        [2.78335657e-01, 1.26974497e-01, 8.19208776e+00, 2.86954568e+01,
         4.55377379e+00],
        [2.98353491e-01, 1.32482395e-01, 5.34847923e+00, 2.53719043e+01,
         5.31371441e+00],
        [2.56852258e-01, 1.20998145e-01, 8.10951131e+00, 5.35923178e+01,
         1.16220817e-01],
        [4.79468038e-01, 9.20171142e-02, 6.94595852e+00, 4.07514076e+01,
         6.86768545e+00],
        [7.56452310e-01, 1.09943554e-01, 7.41290310e+00, 3.47291918e+01,
         2.77781661e+00],
        [6.06987661e-01, 9.53063253e-02, 4.80580765e+00, 1.15499895e+01,
         8.86260599e-01],
        [7.60495314e-01, 1.02037761e-01, 6.60685571e+00, 3.98080057e+01,
         1.47510115e+00],
        [3.62318011e-01, 1.02132464e-01, 1.08624619e+01, 1.98415414e+01,
         5.09614999e-01],
        [3.12722391e-01, 1.04109665e-01, 8.27064447e+00, 1.36605262e+01,
         7.00399372e-01],
        [3.71681539e-01, 1.35283854e-01, 1.05783098e+01, 5.68456311e+01,
         6.71377591e+00]]),
 &#39;sim_non_batchable_context&#39;: None,
 &#39;sim_batchable_context&#39;: None,
 &#39;sim_data&#39;: array([[[     65],
         [     59],
         [     41],
         [     77],
         [    431],
         [     53],
         [     63],
         [     81],
         [    276],
         [    603],
         [    815],
         [    309],
         [    587],
         [    393]],

        [[     19],
         [     31],
         [     68],
         [     47],
         [     71],
         [     96],
         [    118],
         [    101],
         [    147],
         [    224],
         [    242],
         [    271],
         [    431],
         [    552]],

        [[    196],
         [    170],
         [    237],
         [    220],
         [    316],
         [    274],
         [    359],
         [    514],
         [    499],
         [   1070],
         [    854],
         [    854],
         [   1607],
         [   1125]],

        [[     34],
         [      7],
         [     99],
         [    155],
         [     65],
         [     42],
         [    286],
         [    446],
         [    458],
         [    341],
         [     62],
         [    845],
         [    939],
         [   1160]],

        [[    199],
         [      2],
         [      0],
         [      0],
         [      0],
         [     16],
         [      0],
         [     35],
         [    146],
         [      0],
         [     11],
         [    192],
         [      3],
         [     59]],

        [[    631],
         [    788],
         [   1591],
         [   1537],
         [   1728],
         [   2078],
         [   4238],
         [   7347],
         [   8031],
         [   4575],
         [  10637],
         [  15657],
         [  21789],
         [  54596]],

        [[      1],
         [      1],
         [      0],
         [      1],
         [      1],
         [      0],
         [      1],
         [      0],
         [      0],
         [      2],
         [      4],
         [      5],
         [      0],
         [      5]],

        [[     18],
         [     73],
         [    139],
         [     50],
         [    261],
         [    178],
         [    124],
         [     22],
         [    119],
         [    402],
         [     35],
         [    452],
         [     54],
         [   1438]],

        [[     14],
         [     37],
         [     49],
         [     81],
         [    135],
         [    132],
         [    190],
         [    155],
         [    271],
         [    520],
         [    274],
         [    646],
         [    301],
         [   1594]],

        [[     20],
         [      6],
         [      9],
         [     14],
         [     18],
         [     14],
         [      9],
         [     14],
         [     16],
         [      6],
         [     17],
         [     64],
         [     35],
         [     43]],

        [[     61],
         [    146],
         [    171],
         [    190],
         [    208],
         [    178],
         [    584],
         [    402],
         [    579],
         [    538],
         [   1105],
         [   2786],
         [   1428],
         [   2553]],

        [[     33],
         [     48],
         [     90],
         [     56],
         [     37],
         [     28],
         [    129],
         [    205],
         [    136],
         [     75],
         [    191],
         [    345],
         [    201],
         [    523]],

        [[    189],
         [    209],
         [    325],
         [     61],
         [    351],
         [    971],
         [     30],
         [    839],
         [    368],
         [   2671],
         [     75],
         [     82],
         [     18],
         [    383]],

        [[      0],
         [      1],
         [      0],
         [      5],
         [      3],
         [      4],
         [     40],
         [      6],
         [     10],
         [      0],
         [     75],
         [     17],
         [     32],
         [      4]],

        [[    260],
         [    141],
         [    295],
         [    224],
         [    220],
         [    731],
         [    952],
         [    783],
         [    676],
         [   1175],
         [   2159],
         [   3436],
         [   2690],
         [   2090]],

        [[      2],
         [      4],
         [      5],
         [      7],
         [     67],
         [      4],
         [      1],
         [     21],
         [      7],
         [      1],
         [      4],
         [      1],
         [      1],
         [    103]],

        [[      4],
         [      4],
         [      2],
         [      7],
         [      1],
         [      5],
         [      7],
         [     14],
         [      5],
         [     10],
         [     23],
         [     10],
         [      9],
         [      7]],

        [[    106],
         [    124],
         [    103],
         [    261],
         [    135],
         [    172],
         [    358],
         [    486],
         [    226],
         [    634],
         [    683],
         [    220],
         [    539],
         [    836]],

        [[    537],
         [    428],
         [   1667],
         [    724],
         [   1068],
         [   2440],
         [   1994],
         [   2713],
         [   2312],
         [   3351],
         [  10179],
         [   6637],
         [  11109],
         [   8889]],

        [[   1209],
         [    946],
         [   1687],
         [   4500],
         [   2527],
         [  51677],
         [  60373],
         [ 172697],
         [  59939],
         [  54312],
         [ 172934],
         [ 351120],
         [ 211354],
         [1688718]],

        [[      0],
         [    201],
         [      0],
         [     54],
         [    747],
         [      1],
         [     29],
         [   1284],
         [    105],
         [      6],
         [  26763],
         [      0],
         [   9145],
         [    796]],

        [[      0],
         [    637],
         [   2028],
         [    355],
         [      5],
         [     74],
         [    111],
         [     98],
         [ 412235],
         [ 505812],
         [ 104365],
         [ 642601],
         [2283709],
         [      9]],

        [[     22],
         [     31],
         [     13],
         [     42],
         [      8],
         [     22],
         [     19],
         [     49],
         [     68],
         [     70],
         [    151],
         [    151],
         [    177],
         [    186]],

        [[     23],
         [     30],
         [     16],
         [     20],
         [      8],
         [     35],
         [     55],
         [     37],
         [     30],
         [     45],
         [     65],
         [     52],
         [     50],
         [     57]],

        [[      0],
         [      0],
         [     17],
         [      2],
         [      0],
         [      0],
         [      0],
         [      0],
         [      0],
         [     28],
         [     58],
         [      1],
         [      0],
         [      0]],

        [[     93],
         [    110],
         [    371],
         [    511],
         [    569],
         [    401],
         [    521],
         [   1553],
         [   2403],
         [   4062],
         [   6370],
         [   7030],
         [   5142],
         [   8303]],

        [[    235],
         [    732],
         [   2095],
         [   2204],
         [   2815],
         [   5885],
         [   8649],
         [   9178],
         [  34872],
         [  24155],
         [ 222351],
         [ 154588],
         [ 190584],
         [ 429498]],

        [[     37],
         [     12],
         [    109],
         [      2],
         [    276],
         [     44],
         [    796],
         [    376],
         [    987],
         [    554],
         [    708],
         [   7028],
         [   2105],
         [  11029]],

        [[    103],
         [     97],
         [   2024],
         [   8968],
         [  14304],
         [  16022],
         [   3503],
         [  45105],
         [  64522],
         [  12040],
         [ 403525],
         [  96459],
         [ 252234],
         [2110304]],

        [[     47],
         [     28],
         [      7],
         [     23],
         [    430],
         [     18],
         [    471],
         [     38],
         [     85],
         [     12],
         [    560],
         [      2],
         [    599],
         [   1054]],

        [[     21],
         [     32],
         [      3],
         [      8],
         [      1],
         [     69],
         [    165],
         [      8],
         [     74],
         [     11],
         [     54],
         [     17],
         [     34],
         [    138]],

        [[    214],
         [     90],
         [    193],
         [    539],
         [    266],
         [    474],
         [    643],
         [    912],
         [   1060],
         [    672],
         [   1553],
         [   1603],
         [   3160],
         [   2078]]], dtype=int64)}
</pre></div></div>
</div>
</section>
</section>
<section id="Defining-the-Configurator">
<h1>Defining the Configurator<a class="headerlink" href="#Defining-the-Configurator" title="Permalink to this heading"></a></h1>
<p>As you by now know, the configurator is the part that connects your simulator outputs to the neural inference architecture. Notice how this time the return dictionary has three keys: 1. <code class="docutils literal notranslate"><span class="pre">summary_conditions</span></code> - these will be passed through the summary network before going into the inference network; 2. <code class="docutils literal notranslate"><span class="pre">direct_conditions</span></code> - these will be passed directly to the inference network; 3. <code class="docutils literal notranslate"><span class="pre">parameters</span></code> - these are the quantities we wish to perform posterior inference on.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">configure_input</span><span class="p">(</span><span class="n">forward_dict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to configure the simulated quantities (i.e., simulator outputs)</span>
<span class="sd">    into a neural network-friendly (BayesFlow) format.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Prepare placeholder dict</span>
    <span class="n">out_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Convert data to logscale</span>
    <span class="n">logdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">forward_dict</span><span class="p">[</span><span class="s1">&#39;sim_data&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Extract scaling parameter and convert to array</span>
    <span class="n">alphas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">forward_dict</span><span class="p">[</span><span class="s1">&#39;prior_batchable_context&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="c1"># Extract prior draws and z-standardize with previously computed means</span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">forward_dict</span><span class="p">[</span><span class="s1">&#39;prior_draws&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span> <span class="o">-</span> <span class="n">prior_means</span><span class="p">)</span> <span class="o">/</span> <span class="n">prior_stds</span>

    <span class="c1"># Remove a batch if it contains nan, inf or -inf</span>
    <span class="n">idx_keep</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">logdata</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">idx_keep</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid value encountered...removing from batch&#39;</span><span class="p">)</span>

    <span class="c1"># Add to keys</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;summary_conditions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logdata</span><span class="p">[</span><span class="n">idx_keep</span><span class="p">]</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;direct_conditions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">alphas</span><span class="p">[</span><span class="n">idx_keep</span><span class="p">]</span>
    <span class="n">out_dict</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">idx_keep</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">out_dict</span>
</pre></div>
</div>
</div>
<p>We can always do a quick check that our configurator works well with the outputs of the generative model:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">configure_input</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="Defining-the-Neural-Approximator">
<h1>Defining the Neural Approximator<a class="headerlink" href="#Defining-the-Neural-Approximator" title="Permalink to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[163]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># TODO</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[165]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summary_net</span> <span class="o">=</span> <span class="n">SummaryNet</span><span class="p">(</span><span class="n">n_summary</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">inference_net</span> <span class="o">=</span> <span class="n">InvertibleNetwork</span><span class="p">({</span><span class="s1">&#39;n_params&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
                                   <span class="s1">&#39;n_coupling_layers&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
<span class="n">amortizer</span> <span class="o">=</span> <span class="n">AmortizedPosterior</span><span class="p">(</span><span class="n">inference_net</span><span class="p">,</span> <span class="n">summary_net</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Defining-the-Trainer">
<h1>Defining the Trainer<a class="headerlink" href="#Defining-the-Trainer" title="Permalink to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[166]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># change var_obs</span>
<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">amortizer</span><span class="o">=</span><span class="n">amortizer</span><span class="p">,</span>
                  <span class="n">generative_model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                  <span class="n">configurator</span><span class="o">=</span><span class="n">configure_input</span><span class="p">,</span>
                  <span class="n">checkpoint_path</span><span class="o">=</span><span class="s1">&#39;Alpha_Scaling_SIR&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
INFO:root:Initializing networks from scratch.
INFO:root:Performing a consistency check with provided components...
INFO:root:Done.
</pre></div></div>
</div>
</section>
<section id="Training-Phase">
<h1>Training Phase<a class="headerlink" href="#Training-Phase" title="Permalink to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># h = trainer.train_online(epochs=20, iterations_per_epoch=1000, batch_size=32)</span>
</pre></div>
</div>
</div>
</section>
<section id="Validation">
<h1>Validation<a class="headerlink" href="#Validation" title="Permalink to this heading"></a></h1>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
<section id="Inference-Phase">
<h1>Inference Phase<a class="headerlink" href="#Inference-Phase" title="Permalink to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[168]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">amortizer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;summary_conditions&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">obs_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
     <span class="s1">&#39;direct_conditions&#39;</span> <span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)},</span>
     <span class="n">n_samples</span><span class="o">=</span><span class="mi">3000</span><span class="p">,</span> <span class="n">to_numpy</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">samples</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plot_median_predictions</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">obs_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
d:\anaconda3\envs\tensorflowdev\lib\site-packages\ipykernel_launcher.py:37: UserWarning: FixedFormatter should only be used together with FixedLocator
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_46_1.png" src="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_46_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[114]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">amortizer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;summary_conditions&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">obs_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
     <span class="s1">&#39;direct_conditions&#39;</span> <span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)},</span>
     <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">to_numpy</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">samples</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plot_median_predictions</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">obs_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
d:\anaconda3\envs\tensorflowdev\lib\site-packages\ipykernel_launcher.py:37: UserWarning: FixedFormatter should only be used together with FixedLocator
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_47_1.png" src="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_47_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[115]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples</span> <span class="o">=</span> <span class="n">amortizer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
    <span class="p">{</span><span class="s1">&#39;summary_conditions&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">obs_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
     <span class="s1">&#39;direct_conditions&#39;</span> <span class="p">:</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)},</span>
     <span class="n">n_samples</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">to_numpy</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">samples</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">plot_median_predictions</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">obs_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
d:\anaconda3\envs\tensorflowdev\lib\site-packages\ipykernel_launcher.py:37: UserWarning: FixedFormatter should only be used together with FixedLocator
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_48_1.png" src="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_48_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[169]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">param_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$\lambda$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\mu$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$D$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$I_0$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\psi$&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[225]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">samples_alpha</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">alpha</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">amortizer</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="p">{</span><span class="s1">&#39;summary_conditions&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">obs_data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
         <span class="s1">&#39;direct_conditions&#39;</span> <span class="p">:</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)},</span>
         <span class="n">n_samples</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">to_numpy</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">samples</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">param_names</span><span class="p">)</span>
    <span class="n">samples_alpha</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[226]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_all</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">samples_alpha</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[227]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_all</span><span class="p">[</span><span class="s1">&#39;Scaling factor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$\alpha = 0.5$&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples_alpha</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> \
            <span class="o">+</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$\alpha = 1.0$&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples_alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> \
            <span class="o">+</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$\alpha = 2.0$&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">samples_alpha</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[228]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">build_viridis_palette</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n_total</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">base_palette</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Builds a viridis palette with maximal entropy (evenly spaced)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">color_palette</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="n">base_palette</span><span class="p">,</span> <span class="n">n_colors</span><span class="o">=</span><span class="n">n_total</span><span class="p">))</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_total</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">color_palette</span> <span class="o">=</span> <span class="n">color_palette</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">color_palette</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[229]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="n">build_viridis_palette</span><span class="p">(</span><span class="mi">21</span><span class="p">,</span> <span class="n">base_palette</span><span class="o">=</span><span class="s2">&quot;plasma&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[230]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">color_codes</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sa">r</span><span class="s1">&#39;$\alpha = 0.5$&#39;</span> <span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="sa">r</span><span class="s1">&#39;$\alpha = 1.0$&#39;</span> <span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
    <span class="sa">r</span><span class="s1">&#39;$\alpha = 2.0$&#39;</span> <span class="p">:</span> <span class="n">colors</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span>

<span class="p">}</span>
<span class="n">sns</span><span class="o">.</span><span class="n">palplot</span><span class="p">(</span><span class="n">color_codes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_55_0.png" src="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_55_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[262]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">corrfunc</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">):</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">pearsonr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\rho$ = </span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">),</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mf">.25</span><span class="p">,</span> <span class="mf">.5</span><span class="p">),</span> <span class="n">xycoords</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">18</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">PairGrid</span><span class="p">(</span><span class="n">df_all</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;Scaling factor&#39;</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="n">color_codes</span><span class="p">)</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">map_diag</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">map_lower</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">,</span> <span class="n">n_levels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">cut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bw_method</span><span class="o">=</span><span class="s1">&#39;silverman&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
<span class="c1"># grid = grid.map_upper(corrfunc)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">triu_indices_from</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">axes</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">param_names</span><span class="p">)):</span>
    <span class="n">grid</span><span class="o">.</span><span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">df_all</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>

<span class="n">grid</span><span class="o">.</span><span class="n">add_legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">_legend</span><span class="o">.</span><span class="n">get_title</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">_legend</span><span class="o">.</span><span class="n">get_texts</span><span class="p">(),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[262]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[None, None, None, None, None, None]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_56_1.png" src="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_56_1.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[263]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">grid</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;Initial_Pairs.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[267]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;#8c87d6&#39;</span><span class="p">,</span> <span class="s1">&#39;#d68787&#39;</span><span class="p">,</span> <span class="s1">&#39;#d6d387&#39;</span><span class="p">]</span>
<span class="n">legends</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$\alpha = 0.5$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\alpha = 1.0$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\alpha = 2.0$&#39;</span><span class="p">]</span>
<span class="n">f</span><span class="p">,</span> <span class="n">axarr</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="k">for</span> <span class="n">samples</span><span class="p">,</span> <span class="n">legend</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">samples_alpha</span><span class="p">,</span> <span class="n">legends</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axarr</span><span class="p">):</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">legend</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">l</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">despine</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axarr</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">param_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Parameter value&#39;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_58_0.png" src="../_images/tutorial_notebooks_PriorSensitivity_Covid19_Initial_58_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[268]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s2">&quot;Initial_Marginal.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Stefan T. Radev.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>